<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Kings — TestBed v9.9.30R2+</title>
<style>
  :root{
    --bg:#0b0f14; --card:#10161d; --muted:#9fb0c3; --text:#eaf2fb; --ok:#19c37d; --bad:#ff6363;
    --chip:#151d26; --chip-b:#2a3848; --brand1:#7c4dff; --brand2:#2396ff;
    --ring: rgba(124,77,255,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:#0d1218;color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1040px;margin:0 auto;padding:16px}
  header{background:#0a0f15;border-bottom:1px solid #16202b;position:sticky;top:0;z-index:5}
  .hrow{display:flex;align-items:center;gap:12px;padding:12px 16px}
  .logo{display:flex;align-items:center;gap:12px}
  .badge{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#4f7cff,#6bffe8);display:grid;place-items:center;color:#001422;font-weight:800}
  .title{font-size:20px;font-weight:700}
  .fx1{flex:1}
  .hamb{width:40px;height:40px;border-radius:10px;background:#121922;display:grid;place-items:center;cursor:pointer}
  .hamb span{display:block;width:18px;height:2px;background:#cfe0f2;box-shadow:0 6px 0 #cfe0f2,0 -6px 0 #cfe0f2;border-radius:2px}
  .card{background:var(--card);border:1px solid #15202b;border-radius:14px;box-shadow:0 2px 0 #0a0f15 inset;padding:16px;margin:16px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--chip-b);color:#cfe0f2;padding:8px 10px;border-radius:10px;font-size:14px}
  .btn{border:0;border-radius:12px;padding:14px 18px;font-weight:700;color:white;cursor:pointer;
       background:linear-gradient(135deg,var(--brand1),var(--brand2));box-shadow:0 0 0 0 var(--ring)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.soft{background:#17202a;color:#cfe0f2}
  .note{color:var(--muted);font-size:14px}
  .stat{background:#0f1620;border:1px dashed #203042;border-radius:12px;padding:8px 12px;color:#cfe0f2}
  .results .item{border:1px solid #17222f;background:#0f1620;border-radius:14px;padding:14px;margin:12px 0}
  .results .item.profit{background:rgba(25,195,125,.08);border-color:#1d6c4f}
  .results .item.loss{background:rgba(255,99,99,.06);border-color:#5a3030}
  .tok{font-weight:800;font-size:18px;margin-bottom:4px}
  .pair{color:#b9c7d6;font-size:14px;margin-bottom:8px}
  .pl{font-weight:800}
  .pl.ok{color:var(--ok)} .pl.bad{color:var(--bad)}
  .grid{display:grid;grid-template-columns:1.2fr .9fr .8fr .9fr;gap:8px}
  .ctrls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{min-width:110px;text-align:center}
  .footer{margin:40px 0 20px}
  .grid4{display:grid;gap:14px;grid-template-columns:repeat(4,minmax(0,1fr))}
  .grid4 h4{margin:.2rem 0 .5rem;font-size:14px;color:#b9c7d6}
  .grid4 a{display:block;color:#cfe0f2;text-decoration:none;opacity:.85;margin:.15rem 0}
  .grid4 a:hover{opacity:1;text-decoration:underline}
  pre{background:#071018;border:1px solid #132131;border-radius:12px;padding:12px;overflow:auto}
  input[type="number"]{background:#0f1620;border:1px solid #1b2836;color:#eaf2fb;border-radius:10px;padding:10px 12px;width:180px}
  .money{font-variant-numeric:tabular-nums}
  @media (max-width:720px){
    .grid{grid-template-columns:1fr 1fr}
    .grid4{grid-template-columns:1fr 1fr}
    input[type="number"]{width:100%}
  }
</style>
</head>
<body>
<header>
  <div class="hrow wrap">
    <div class="logo">
      <div class="badge">CK</div>
      <div>
        <div class="title">Crypto Kings</div>
        <div class="note">TestBed • Arbitrum • <b>v9.9.30R2+</b></div>
      </div>
    </div>
    <div class="fx1"></div>
    <div class="hamb" aria-label="menu"><span></span></div>
  </div>
</header>

<main class="wrap">

  <!-- Controls -->
  <section class="card">
    <div class="row">
      <label class="chip">Loan Amount (USDC):</label>
      <input id="loan" type="number" min="100" step="100" value="10000" />
      <span class="chip">RPC: <b id="rpcName">custom</b></span>
      <span class="chip">Tokens: <b id="tokCount">0</b></span>
      <span class="chip">Gas: <b id="gasChip">—</b></span>
      <span class="chip">ETH: <b id="ethChip">—</b></span>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="scanBtn" class="btn">Scan</button>
      <button id="stopBtn" class="btn soft">Stop</button>
      <span id="status" class="chip pill">Ready.</span>
    </div>
    <div class="note" style="margin-top:8px">
      Net P/L = (loan ÷ buyPrice × sellPrice) − per-leg DEX fees (0.3%/leg) − slippage buffer (0.2%/leg) − flash (0.09%) − gas.
      Spread cap 50%. Pools must be on Arbitrum.
    </div>
  </section>

  <!-- Selection / Execute -->
  <section class="card">
    <div class="ctrls">
      <button id="selProf" class="btn soft pill">Select all profitable</button>
      <button id="clearSel" class="btn soft pill">Clear</button>
      <span id="selTotal" class="stat money">++$0.00</span>
    </div>
    <div style="margin-top:12px">
      <button id="executeBtn" class="btn" style="width:100%">Execute Selected (Preview)</button>
    </div>
  </section>

  <!-- Results -->
  <section class="card">
    <h2 style="margin:0 0 8px">Results</h2>
    <div id="results" class="results"></div>
  </section>

  <!-- Logs -->
  <section class="card">
    <h3 style="margin:0 0 8px">Details / Logs</h3>
    <pre id="log"></pre>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="grid4">
      <div>
        <h4>Company</h4>
        <a href="#">About</a>
        <a href="#">Careers</a>
        <a href="#">Contact</a>
      </div>
      <div>
        <h4>Product</h4>
        <a href="#">Overview</a>
        <a href="#">Pricing</a>
        <a href="#">Docs</a>
      </div>
      <div>
        <h4>Legal</h4>
        <a href="#">Terms</a>
        <a href="#">Privacy</a>
        <a href="#">Risk</a>
      </div>
      <div>
        <h4>Social</h4>
        <a href="#">X</a>
        <a href="#">Discord</a>
        <a href="#">Blog</a>
      </div>
    </div>
    <div class="note" style="margin-top:18px">© 2025 Crypto Kings Limited — All rights reserved.</div>
  </footer>
</main>

<script>
/* ========= CONFIG (safe, minimal changes) ========= */

// Expanded token set (~60) prioritizing Arbitrum USDC/USDT liquidity
const TOKEN_LIST = [
  "WETH","WBTC","USDC","USDC.e","USDT","DAI","ARB","LINK","UNI","AAVE","SNX",
  "GMX","GRAIL","RDNT","MAGIC","PENDLE","DPX","rDPX","JOE","VELA","GRT","BAL",
  "CRV","FRAX","LUSD","FXS","LQTY","RPL","MKR","ENS","COMP","YFI","STG","PERP",
  "SUSHI","KYBERSWAP","CHRONOS","RAMSES","AURA","BNT","HOP","1INCH","VELO",
  "ALCX","GNS","RDPX","SPELL","RBN","FARM","KNC","Y2K","GMD","JONES","DODO",
  "TCR","MIM","LIFI","WOO","VST","TUSD"
];

// Cross-DEX universe for Arbitrum
const DEXES = ["UniswapV3","SushiSwap","Camelot","Ramses","KyberSwap","TraderJoe","Chronos"];

// Filters tuned to surface more routes while staying realistic
const LIQ_MULTIPLE     = 2;    // pool_liquidity must be ≥ 2× loan
const FRESH_WINDOW_MIN = 15;   // activity in last ≤ 15 minutes
const RAW_SPREAD_CAP   = 50;   // % cap on raw spread to drop absurd quotes
const MIN_NET_SPREAD   = 0.05; // % floor after fees/slippage/gas (keep small)
const DEX_FEE_PCT      = 0.30; // per leg (0.3%)
const SLIP_PCT         = 0.20; // per leg slippage budget (0.2%)
const FLASH_FEE_PCT    = 0.09; // Aave-like flash fee (0.09%)
const GAS_LIMIT        = 350000; // 2 swaps + callback target
const GAS_GWEI         = 0.01; // your UI showed 0.01 gwei — keep consistent
const ETH_PRICE        = 4416; // UI chip value; your scanner can update live

// If you already set window.RPC_URL elsewhere, we read it; otherwise use your Alchemy URL
const RPC_URL = window.RPC_URL || "https://arb-mainnet.g.alchemy.com/v2/your-key-here";

/* ========= UTIL ========= */
const $ = sel => document.querySelector(sel);
const log = (m) => { const el=$("#log"); el.textContent += (el.textContent? "\n":"") + m; el.scrollTop=el.scrollHeight; };
const money = (n) => (n<0? "-$":"+$")+Math.abs(n).toFixed(2);
const pct = (n) => n.toFixed(2)+"%";

/* ========= UI WIRING ========= */
$("#tokCount").textContent = TOKEN_LIST.length;
$("#rpcName").textContent = RPC_URL.includes("alchemy") ? "Alchemy" : "custom";
$("#gasChip").textContent = `${GAS_GWEI} gwei`;
$("#ethChip").textContent = `US$${ETH_PRICE.toLocaleString()}`;

/* ========= CORE: scan orchestration =========
   This orchestrator expects a project-specific quote function. We keep it flexible:
   - If window.fetchQuotesForToken exists (your live implementation), we call it.
   - Otherwise we log “not enough quotes” (non-breaking, keeps layout intact).
*/
let stopFlag=false;

async function scan() {
  stopFlag=false;
  const loan = Number($("#loan").value || 0);
  const gasUSD = (GAS_GWEI * 1e-9) * GAS_LIMIT * ETH_PRICE; // gwei→ETH * ETH$
  $("#status").textContent = "Scanning…";
  $("#results").innerHTML = "";
  $("#selTotal").textContent = "++$0.00";
  log(`CLICK Scan; tokens=${TOKEN_LIST.length}; loan=${loan}`);

  const rows = [];
  for (const sym of TOKEN_LIST) {
    if (stopFlag) break;

    let quotes = null;
    try {
      if (typeof window.fetchQuotesForToken === "function") {
        // Your existing function should return an array of { dex, price, liqUSD, freshMin }
        // for USDC/USDT pairs on Arbitrum.
        quotes = await window.fetchQuotesForToken(sym, { dexes: DEXES, rpc: RPC_URL });
      }
    } catch(e) {
      log(`[${sym}] quote error: ${e?.message||e}`);
    }

    if (!quotes || !quotes.length) {
      log(`[${sym}] not enough quotes`);
      continue;
    }

    // Filter by liquidity & freshness
    const liqNeed = Math.max(loan * LIQ_MULTIPLE, 20000); // floor 20k
    const filt = quotes.filter(q => (q.liqUSD||0) >= liqNeed && (q.freshMin||999) <= FRESH_WINDOW_MIN);
    if (filt.length < 2) {
      log(`[${sym}] thin or stale (liq<${LIQ_MULTIPLE}×loan or >${FRESH_WINDOW_MIN}m old)`);
      continue;
    }

    // Find best buy (lowest) and best sell (highest) among allowed DEXes
    const buy = filt.reduce((a,b)=> (b.price<a.price? b:a));
    const sell= filt.reduce((a,b)=> (b.price>a.price? b:a));
    if (sell.dex === buy.dex) { log(`[${sym}] best buy==sell (${buy.dex})`); continue; }

    // Raw spread %
    const rawSpread = ((sell.price / buy.price) - 1) * 100;
    if (rawSpread > RAW_SPREAD_CAP) { log(`[${sym}] spread ${rawSpread.toFixed(2)}% > ${RAW_SPREAD_CAP}% cap`); continue; }
    if (rawSpread <= 0) { log(`[${sym}] no positive spread`); continue; }

    // Net P/L: loan/buy * sell, minus fees, slippage, flash, gas
    const grossUSDC = loan / buy.price * sell.price;
    const fees = loan * ((DEX_FEE_PCT + SLIP_PCT)/100 * 2) + (loan * (FLASH_FEE_PCT/100));
    const net = grossUSDC - loan - fees - gasUSD;

    const netSpreadPct = (net/loan)*100;
    if (netSpreadPct < MIN_NET_SPREAD) { log(`[${sym}] net spread ${netSpreadPct.toFixed(3)}% < ${MIN_NET_SPREAD}% floor`); }

    rows.push({
      token: sym,
      buyDex: buy.dex, buyPrice: buy.price,
      sellDex: sell.dex, sellPrice: sell.price,
      usdcBack: loan + net,
      netPL: net,
      rawSpread
    });
  }

  // Sort profit-first, then spread
  rows.sort((a,b)=> b.netPL - a.netPL || b.rawSpread - a.rawSpread);

  renderResults(rows);
  const prof = rows.filter(r=> r.netPL>0).reduce((s,r)=>s+r.netPL,0);
  $("#status").textContent = `Done. Found ${rows.filter(r=>r.netPL>0).length} profitable route(s), ${rows.length} total rows.`;
  $("#selTotal").textContent = money(prof);
}

function stop(){ stopFlag=true; $("#status").textContent="Stopped."; }

/* ========= RENDER ========= */
function renderResults(rows){
  const box = $("#results"); box.innerHTML="";
  rows.forEach((r,i)=>{
    const card = document.createElement("div");
    card.className = "item " + (r.netPL>0? "profit":"loss");

    const id = `row_${i}`;
    card.innerHTML = `
      <div class="grid">
        <div>
          <div class="tok">${r.token}</div>
          <div class="pair">${r.buyDex} → ${r.sellDex}</div>
        </div>
        <div class="money">$${r.buyPrice.toFixed(6)} → $${r.sellPrice.toFixed(6)}</div>
        <div class="money">${pct(r.rawSpread)}</div>
        <div class="money pl ${r.netPL>0?'ok':'bad'}">${money(r.netPL)}</div>
      </div>
      <div style="margin-top:8px;display:flex;align-items:center;gap:10px">
        <input type="checkbox" class="pick" id="${id}" ${r.netPL>0?'checked':''}>
        <label for="${id}" class="note">Select</label>
      </div>
    `;
    box.appendChild(card);
  });
}

/* ========= SELECTION / EXEC ========= */
function updateSelectedTotal(){
  const cards = [...document.querySelectorAll("#results .item")];
  let total = 0;
  cards.forEach((c,idx)=>{
    const chk = c.querySelector(".pick");
    if (chk?.checked) {
      const plTxt = c.querySelector(".pl").textContent.replace(/[+$,]/g,"");
      total += Number(plTxt);
    }
  });
  $("#selTotal").textContent = money(total);
}

function selectAllProfitable(){
  document.querySelectorAll("#results .item").forEach((c)=>{
    const isProfit = c.classList.contains("profit");
    const chk = c.querySelector(".pick");
    if (chk) chk.checked = isProfit;
  });
  updateSelectedTotal();
}

function clearSelection(){
  document.querySelectorAll("#results .pick").forEach(ch => ch.checked=false);
  updateSelectedTotal();
}

function execPreview(){
  const picks = [];
  document.querySelectorAll("#results .item").forEach((c)=>{
    const chk = c.querySelector(".pick");
    if (chk?.checked) {
      const token = c.querySelector(".tok").textContent.trim();
      const route = c.querySelector(".pair").textContent.trim();
      const pl = c.querySelector(".pl").textContent.trim();
      picks.push({token, route, pl});
    }
  });
  if (!picks.length) { alert("Select at least one profitable route."); return; }
  alert("Preview (mock):\n\n" + picks.map(p=>`${p.token} — ${p.route} — ${p.pl}`).join("\n"));
}

/* ========= EVENTS ========= */
$("#scanBtn").addEventListener("click", scan);
$("#stopBtn").addEventListener("click", stop);
$("#selProf").addEventListener("click", selectAllProfitable);
$("#clearSel").addEventListener("click", clearSelection);
$("#results").addEventListener("change", (e)=>{ if(e.target.classList.contains("pick")) updateSelectedTotal(); });
$("#executeBtn").addEventListener("click", execPreview);

/* ========= OPTIONAL HOOKS =========
   If your previous build exposes these, we reuse them so you don’t lose functionality.
   - window.fetchQuotesForToken(symbol, {dexes,rpc}) => [{dex,price,liqUSD,freshMin}, ...]
   - window.getEthPrice() => number
   - window.getGasGwei() => number
*/
(async function initChips(){
  try { if (typeof window.getEthPrice === "function") $("#ethChip").textContent = "US$"+(await window.getEthPrice()).toLocaleString(); } catch{}
  try { if (typeof window.getGasGwei === "function") $("#gasChip").textContent = (await window.getGasGwei()).toFixed(2)+" gwei"; } catch{}
})();
</script>
</body>
</html>
