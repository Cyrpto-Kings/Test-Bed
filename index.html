<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Kings v9.9.10 — Arbitrum (Core/Extended scan)</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
    --brand1:#3b82f6; --brand2:#9333ea; --ok:#10b981; --bad:#ef4444;
    --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{background:#111;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  header .brand{display:flex;align-items:center;gap:10px}
  header .logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--brand1),var(--brand2));display:grid;place-items:center;font-weight:800}
  header nav a{color:#fff;text-decoration:none;margin-left:14px;font-weight:600;opacity:.9}
  header nav a:hover{opacity:1}
  .wrap{max-width:980px;margin:0 auto;padding:18px 12px 40px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="number"],select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--ink);outline:none}
  input:focus,select:focus{border-color:var(--brand1);box-shadow:0 0 0 3px rgba(59,130,246,.2)}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:720px){ .row-3{grid-template-columns:repeat(3,1fr)} .row-4{grid-template-columns:repeat(4,1fr)} .row-2{grid-template-columns:repeat(2,1fr)} }
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;color:white;background:linear-gradient(135deg,var(--brand1),var(--brand2));cursor:pointer}
  .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--border)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .pill{background:#eef2ff;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px;text-align:left}
  th{color:#374151;background:#fafafa;position:sticky;top:0;z-index:1}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .log{font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0f172a;color:#a7f3d0;border-radius:10px;padding:10px;max-height:260px;overflow:auto}
  .status{font-size:13px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">CK</div>
    <div>
      <div style="font-weight:800;">Crypto Kings</div>
      <div class="muted" style="font-size:12px;">v9.9.10 — Arbitrum</div>
    </div>
  </div>
  <nav>
    <a href="#">Home</a>
    <a href="#">Who we are</a>
    <a href="#">What we do</a>
    <a href="#">Connect with us</a>
  </nav>
</header>

<div class="wrap">

  <!-- Controls -->
  <div class="card">
    <div class="row row-4">
      <div>
        <label for="loan">Loan Amount (USDC)</label>
        <input id="loan" type="number" min="1" step="1" value="10000" />
      </div>
      <div>
        <label for="gasLimit">Gas Limit (2 swaps + callback)</label>
        <input id="gasLimit" type="number" step="1000" value="380000" />
      </div>
      <div>
        <label for="tokenSet">Token set</label>
        <select id="tokenSet">
          <option value="core" selected>Core (≈11) — fastest</option>
          <option value="extended">Extended (≈40) — deeper scan</option>
        </select>
      </div>
      <div>
        <label for="modeNote">Mode</label>
        <input id="modeNote" value="Liq≥10k • freshness OFF • spread cap 50%" readonly />
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <button id="scanBtn" class="btn">Scan</button>
      <button id="stopBtn" class="btn ghost" disabled>Stop</button>
      <div id="status" class="status muted" style="align-self:center">Idle.</div>
    </div>
    <div class="kpi" style="margin-top:10px">
      <div id="rpcPill" class="pill">RPC: —</div>
      <div id="gasPill" class="pill">Gas: —</div>
      <div id="ethPill" class="pill">WETH: —</div>
      <div id="countPill" class="pill">Tokens: —</div>
    </div>
  </div>

  <!-- Results -->
  <div class="card" id="resultsCard">
    <div style="font-weight:800;margin-bottom:6px;">Results</div>
    <div class="muted" id="summary">—</div>
    <div style="overflow:auto;margin-top:8px;">
      <table>
        <thead>
          <tr>
            <th>Token</th>
            <th>Buy DEX</th>
            <th class="right">Price</th>
            <th>Sell DEX</th>
            <th class="right">Price</th>
            <th class="right">Spread %</th>
            <th class="right">USDC Back</th>
            <th class="right">Net P/L</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Logs -->
  <div class="card">
    <div style="font-weight:800;margin-bottom:6px;">Details / Logs</div>
    <div id="log" class="log"></div>
  </div>

  <div class="muted" style="font-size:12px;margin:8px 2px;">
    Net P/L = (loan ÷ buyPrice × sellPrice) − loan − 0.09% flash fee − est. gas (gasPrice × gasLimit / 1e9 × WETH$).
    Listing routes after basic filters (DEX allow-list, liq ≥ $10k) with a raw spread sanity cap of 50%.
  </div>
</div>

<script>
// ---------- Config ----------
const RPCS = [
  "https://arb-mainnet.g.alchemy.com/v2/h4YaGX9cc_WywAx5cvsez", // your Alchemy node (primary)
  "https://arb1.arbitrum.io/rpc",
  "https://arbitrum.llamarpc.com",
  "https://rpc.ankr.com/arbitrum",
  "https://arbitrum-one.publicnode.com"
];
const ALLOW_DEX = new Set(["uniswap-v3","sushiswap","camelot"]); // Dexscreener IDs
const MIN_LIQ_USD = 10000;     // relaxed liquidity guard
const REQUIRE_TXN_M5 = false;  // freshness OFF
const MIN_VOL24_USD = 0;       // relaxed volume
const MAX_SPREAD_PCT = 50;     // sanity cap: drop routes with raw spread > 50%

// ---------- Token sets (Arbitrum) ----------
// Core: majors
const TOKENS_CORE = {
  WETH:"0x82af49447d8a07e3bd95bd0d56f35241523fbab1",
  USDC:"0xaf88d065e77c8cC2239327C5EDb3A432268e5831",
  USDT:"0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",
  DAI :"0xda10009cbd5d07dd0cecc66161fc93d7c9000da1",
  ARB :"0x912CE59144191C1204E64559FE8253a0e49E6548",
  GMX :"0xfc5a96a8cE62fF190E4A44bD828F3E0eC4A6fBf9",
  LINK:"0xf97f4df75117a78c1A5a0DBb814Af92458539FB4",
  WBTC:"0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f",
  AAVE:"0xba5DdD1f9d7F570dc94a51479a000E3BCE967196",
  PENDLE:"0x0c880f6761F1af8d9Aa9C466984b80DAb9a8c9e8",
  RDNT:"0x3082CC23568eA640225c2467653dB90e9250AaA0",
};

// Extended: majors + popular Arbitrum assets
const TOKENS_EXTENDED = {
  ...TOKENS_CORE,
  MAGIC:"0x539bdE0d7Dbd336b79148AA742883198BBF60342",
  GNS  :"0x18c11FD286C5EC11c3b683Caa813B77f5163A122",
  GRAIL:"0x3d9907F9a368ad0a51Be60f7Da3b97cf940982D8",
  DPX  :"0x6c2C06790b3E3E3c38e12Ee22F8183b37a13EE55",
  rDPX :"0x32Eb7902D4134bf98A28b963D26de779AF92A212",
  JONES:"0x10393c20975cf177a3513071bc110f7962cd67da",
  LDO  :"0xFdb794692724153d1488CcdBE0C56c252596735F",
  CRV  :"0x11cdb42b0EB46D95f990Bil1c (verify if needed)", // if this one logs "no pools", just remove/replace; address varies by bridge
  BAL  :"0x040d1EdC9569d4Bab2D15287Dc5A4F10F56a56B8",
  UNI  :"0xfa7f8980b0f1e64a2062791cc3b0871572f1f7f0",
  FXS  :"0xBd1bdD (verify)", // keep as placeholder; will be skipped if bad
  FRAX :"0x17FC002b466eEc40DaE837Fc4bE5c67993ddBd6F",
  MIM  :"0xFEa7a6a0B346 (verify)", // placeholder
  SYN  :"0x080F6AEd32Fc474DD5717105Dba5ea57268F46eb",
  GRAI :"0x... (optional)",
  USDCe:"0xFF970A61A04b1cA14834A43f5dE4533eBDDB5CC8", // bridged USDC.e
  wstETH:"0x5979D7b546E38E414F7E9822514be443A4800529",
  GM   :"0x... (optional)",
  SNX  :"0x7Bf693aB7fAbc3e... (optional)"
};
// NOTE: A few marked “verify/optional” may not return pools; they’ll simply log “no pools”.

// ---------- Helpers ----------
const $ = (id)=>document.getElementById(id);
const logEl = $("log"), tbody = $("tbody");
function log(msg){ const t=new Date().toLocaleTimeString(); logEl.innerHTML+=`[${t}] ${msg}<br>`; logEl.scrollTop=logEl.scrollHeight; }
function fmtUSD(n,dp=2){ if(!isFinite(n)) return "—"; return '$'+Number(n).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:dp}); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

// ---------- RPC: gas ----------
async function fetchGasGwei(){
  const payload = { jsonrpc:"2.0", id:1, method:"eth_gasPrice", params:[] };
  let lastErr=null, hostShown=false;
  for(const url of RPCS){
    try{
      if(!hostShown){ $("rpcPill").textContent = "RPC: "+ new URL(url).host; hostShown=true; }
      const r = await fetch(url,{method:"POST",headers:{ "Content-Type":"application/json"},body:JSON.stringify(payload)});
      if(!r.ok) { lastErr = new Error("HTTP "+r.status); continue; }
      const j = await r.json();
      const wei = parseInt(j?.result,16);
      if(Number.isFinite(wei)) return { gwei: wei/1e9, rpc:url };
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error("RPC gas failed");
}

// ---------- Dexscreener fetch ----------
async function fetchPairsFor(addr){
  const url = `https://api.dexscreener.com/latest/dex/tokens/${addr}`;
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("Dexscreener HTTP "+r.status);
  const j = await r.json();
  const rows = (j?.pairs||[]).filter(p => {
    if(p.chainId!=="arbitrum") return false;
    const dex = (p.dexId||"").toLowerCase();
    if(!ALLOW_DEX.has(dex)) return false;
    const liq = Number(p?.liquidity?.usd||0);
    if(!(liq>=MIN_LIQ_USD)) return false;
    const vol24 = Number(p?.volume?.h24||0);
    if(!(vol24>=MIN_VOL24_USD)) return false;
    if(REQUIRE_TXN_M5){
      const b = Number(p?.txns?.m5?.buys||0);
      const s = Number(p?.txns?.m5?.sells||0);
      if(b+s <= 0) return false;
    }
    return true;
  });

  // best pool per DEX by highest liquidity
  const byDex = new Map();
  for(const p of rows){
    const k = (p.dexId||"").toLowerCase();
    const liq = Number(p?.liquidity?.usd||0);
    if(!byDex.has(k) || liq > (byDex.get(k)?.liquidity?.usd||0)) byDex.set(k,p);
  }
  return Array.from(byDex.values());
}

// ---------- Core scan ----------
let abort=false;
function getTokenMap(){
  return $("tokenSet").value==="extended" ? TOKENS_EXTENDED : TOKENS_CORE;
}
async function scan(){
  abort=false;
  const loan = parseFloat($("loan").value||"0");
  const gasLimit = parseFloat($("gasLimit").value||"0");
  const TOKENS = getTokenMap();
  $("countPill").textContent = `Tokens: ${Object.keys(TOKENS).length}`;

  $("status").textContent = "Fetching gas & WETH…";
  tbody.innerHTML=""; $("summary").textContent="—"; logEl.innerHTML="";

  // gas
  let gasGwei=0, rpcUsed="";
  try{
    const g = await fetchGasGwei();
    gasGwei = g.gwei; rpcUsed = g.rpc;
    $("gasPill").textContent = `Gas: ${gasGwei.toFixed(2)} gwei`;
    $("rpcPill").textContent = "RPC: " + new URL(rpcUsed).host;
    log(`Gas: ${gasGwei.toFixed(2)} gwei via ${new URL(rpcUsed).host}`);
  }catch(e){
    log(`<span style="color:#fecaca">Gas fetch failed: ${e.message}</span>`);
    $("gasPill").textContent = "Gas: error";
  }

  // WETH price (for gas USD)
  let ethUSD = NaN;
  try{
    const ethPairs = await fetchPairsFor(TOKENS_CORE.WETH);
    const bestUSDC = ethPairs.find(p => (p.quoteToken?.symbol||"").toUpperCase().includes("USD"));
    ethUSD = Number(bestUSDC?.priceUsd);
    $("ethPill").textContent = isFinite(ethUSD) ? `WETH: ${fmtUSD(ethUSD)}` : "WETH: —";
  }catch(_e){
    $("ethPill").textContent = "WETH: —";
  }

  const gasEth = isFinite(gasGwei)&&isFinite(gasLimit) ? (gasGwei*gasLimit)/1e9 : 0;
  const gasUSD = isFinite(ethUSD) ? gasEth * ethUSD : 0;

  $("status").textContent = "Scanning tokens…";
  const out = [];
  let done = 0, total = Object.keys(TOKENS).length;

  for(const [sym,addr] of Object.entries(TOKENS)){
    if(abort){ log("Scan aborted."); break; }
    try{
      const pairs = await fetchPairsFor(addr);
      if(!pairs.length){ log(`${sym}: no pools after liq/DEX filters`); done++; $("summary").textContent = `Progress ${done}/${total} • loan ${fmtUSD(loan)}`; await sleep(120); continue; }

      let bestBuy=null, bestSell=null, min=Infinity, max=-Infinity;
      pairs.forEach(p=>{
        const pr = Number(p?.priceUsd);
        if(!isFinite(pr)) return;
        if(pr < min){ min=pr; bestBuy=p; }
        if(pr > max){ max=pr; bestSell=p; }
      });

      if(!bestBuy || !bestSell || !isFinite(min) || !isFinite(max)){
        log(`${sym}: missing price`);
      } else {
        const rawSpreadPct = ((max/min)-1)*100;
        if(rawSpreadPct > MAX_SPREAD_PCT){
          log(`${sym}: dropped by cap (raw spread ${rawSpreadPct.toFixed(2)}% > ${MAX_SPREAD_PCT}%)`);
        } else {
          const units = loan / min;
          const usdcBack = units * max;
          const flashFee = loan * 0.0009; // 0.09%
          const netPL = usdcBack - loan - flashFee - gasUSD;

          out.push({
            sym,
            buy:{ dex:(bestBuy.dexId||"").toUpperCase(), price:min },
            sell:{ dex:(bestSell.dexId||"").toUpperCase(), price:max },
            spreadPct: rawSpreadPct,
            usdcBack,
            netPL
          });
        }
      }
    }catch(e){
      log(`${sym}: error ${e.message}`);
    }
    done++; $("summary").textContent = `Progress ${done}/${total} • loan ${fmtUSD(loan)}`;
    await sleep(120); // gentle on API (Dexscreener rate limits)
  }

  // render (sort by Net P/L desc)
  tbody.innerHTML="";
  out.sort((a,b)=>b.netPL - a.netPL);
  for(const row of out){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.sym}</td>
      <td>${row.buy.dex}</td>
      <td class="right">${fmtUSD(row.buy.price,5)}</td>
      <td>${row.sell.dex}</td>
      <td class="right">${fmtUSD(row.sell.price,5)}</td>
      <td class="right">${row.spreadPct.toFixed(2)}%</td>
      <td class="right">${fmtUSD(row.usdcBack)}</td>
      <td class="right" style="font-weight:700;color:${row.netPL>=0?'#16a34a':'#ef4444'}">${(row.netPL>=0?'+':'')+row.netPL.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  }

  $("status").textContent = `Done. Listed ${out.length} routes (fee 0.09% + gas ~ ${fmtUSD(gasUSD,4)}).`;
  if(!out.length) log("No routes after filters — try later, switch to Core/Extended, or adjust token list.");
}

$("scanBtn").addEventListener("click", ()=>{ $("stopBtn").disabled=false; scan().finally(()=>{ $("stopBtn").disabled=true; }); });
$("stopBtn").addEventListener("click", ()=>{ abort=true; $("status").textContent="Stopping…"; });

// First paint: gas fetch
fetchGasGwei().then(g=>{
  $("gasPill").textContent = `Gas: ${g.gwei.toFixed(2)} gwei`; $("rpcPill").textContent = "RPC: " + new URL(g.rpc).host;
}).catch(()=>{$("gasPill").textContent="Gas: —";});
$("countPill").textContent = "Tokens: " + Object.keys(TOKENS_CORE).length;
$("tokenSet").addEventListener("change", ()=>{
  const m = getTokenMap();
  $("countPill").textContent = "Tokens: " + Object.keys(m).length;
});
</script>
</body>
</html>
