<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Crypto Kings v9.9.5 — Realistic P/L</title>
<style>
  :root{--bg:#0b0d12;--panel:#11151f;--ink:#e8eef9;--muted:#aab3c2;--ok:#16a34a;--bad:#ef4444;--chip:#182030;--brand1:#7c5cff;--brand2:#1d9bf0}
  *{box-sizing:border-box} body{margin:0;background:#0b0d12;color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:18px 14px 80px}
  header{display:flex;align-items:center;gap:12px;padding:10px 0 14px}
  .logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--brand1),var(--brand2));display:grid;place-items:center;font-weight:800}
  .badge{font-size:12px;padding:4px 8px;border:1px solid #263044;border-radius:999px;color:var(--muted)}
  .card{background:var(--panel);border:1px solid #1a2232;border-radius:14px;padding:14px;margin-top:12px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input{width:100%;padding:10px 12px;border:1px solid #2a3347;border-radius:10px;background:#0f1522;color:var(--ink);outline:none}
  input:focus{border-color:#4a63ff;box-shadow:0 0 0 3px rgba(124,92,255,.25)}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width:720px){ .row-2{grid-template-columns:repeat(2,1fr)} .row-3{grid-template-columns:repeat(3,1fr)} }
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;color:white;background:linear-gradient(135deg,var(--brand1),var(--brand2))}
  .ghost{background:#0f1522;border:1px solid #2a3347;color:var(--ink)}
  .pill{display:inline-flex;gap:8px;align-items:center;background:var(--chip);border:1px solid #223049;border-radius:999px;padding:6px 10px;font-size:12px;color:#c9d3e5}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-bottom:1px solid #1a2232}
  .table th{color:#c5cede;text-align:left;font-size:13px}
  .right{text-align:right}
  .green{color:var(--ok);font-weight:700}
  .red{color:var(--bad);font-weight:700}
  .sub{font-size:12px;color:var(--muted);margin-top:6px}
  .gridKPI{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .kpi{background:var(--chip);border:1px solid #223049;border-radius:12px;padding:8px 10px;font-size:13px}
  .center{display:flex;justify-content:center;align-items:center}
  .spinner{border:4px solid rgba(255,255,255,.18);border-top:4px solid var(--brand1);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">CK</div>
      <h1 style="margin:0;font-size:20px;">Crypto Kings</h1>
      <span class="badge">v9.9.5 realistic</span>
      <span class="badge" id="rpcBadge">RPC: —</span>
      <span class="badge" id="gasBadge">Gas: —</span>
    </header>

    <div class="card">
      <div class="row row-3">
        <div>
          <label>Loan Size (USDC)</label>
          <input id="loan" type="number" min="100" step="100" value="10000"/>
          <div class="sub">Used for both legs in simulation.</div>
        </div>
        <div>
          <label>Max raw spread % (cap unreal)</label>
          <input id="cap" type="number" min="1" step="0.1" value="50"/>
          <div class="sub">Any pair with raw spread above this is ignored.</div>
        </div>
        <div>
          <label>Liquidity Guard (× loan)</label>
          <input id="liqGuard" type="number" min="1" step="1" value="10"/>
          <div class="sub">Pool liquidity (USD) must be ≥ guard × loan.</div>
        </div>
      </div>

      <div class="row row-3" style="margin-top:8px">
        <div>
          <label>Gas Price (Gwei)</label>
          <input id="gasPrice" type="number" step="0.1" placeholder="auto…" />
        </div>
        <div>
          <label>Gas Limit (2 swaps + callback)</label>
          <input id="gasLimit" type="number" step="1000" value="380000"/>
        </div>
        <div>
          <label>ETH Price (USD, auto)</label>
          <input id="ethUsd" type="number" step="0.01" placeholder="auto…" />
        </div>
      </div>

      <div class="btns">
        <button id="scanBtn">Scan</button>
        <button class="ghost" id="selAll">Select all profitable</button>
        <button class="ghost" id="clearSel">Clear</button>
        <span class="pill" id="sumPill">Selected total: +$0</span>
      </div>
      <div class="gridKPI">
        <span class="kpi" id="kpiNote">Ready.</span>
      </div>
    </div>

    <div class="card" id="resultsCard">
      <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap">
        <h3 style="margin:0">Results</h3>
        <div class="pill" id="progress">—</div>
      </div>
      <div id="loading" class="center" style="height:52px;display:none;margin-top:8px"><div class="spinner"></div></div>
      <div style="overflow:auto;margin-top:6px">
        <table class="table">
          <thead>
            <tr>
              <th style="width:38px"></th>
              <th>Token</th>
              <th>Buy DEX</th>
              <th class="right">Buy @</th>
              <th>Sell DEX</th>
              <th class="right">Sell @</th>
              <th class="right">Spread %</th>
              <th class="right">USDC Back</th>
              <th class="right">Net P/L</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="sub" style="margin-top:10px">
        Net P/L = (USDC back − loan) − 0.09% flash fee − gas. Slippage simulated from pool liquidity (constant-product approximation) with per-leg 0.30% DEX fee. Pairs with raw spread &gt; cap or liquidity &lt; guard×loan are ignored.
      </div>
    </div>
  </div>

<script>
(async function(){
  const $ = id => document.getElementById(id);
  const TOKENS = ["WETH","USDC","USDT","DAI","ARB","LINK","GMX","AAVE","WBTC","RDNT","PENDLE","USDC.e","FRAX","CRV","BAL","LDO","rETH","wstETH","UNI","MKR","SNX","COMP","YFI","TUSD","1INCH","GRT","OP","MAGIC","JONES","HND","RDNT.e","STG","LUSD","BPT","SUSHI","DODO"]; // ~36
  const ALLOW_DEX = new Set(["uniswap","sushiswap","camelot","balancer","curve"]); // lowercased dexId
  const DEX_FEE = 0.003; // 0.30% each leg (conservative)
  const FLASH_FEE = 0.0009; // 0.09%
  const RPC = "https://arb-mainnet.g.alchemy.com/v2/h4YaGX9cc_WywAx5cvsez"; // your Alchemy RPC
  $("rpcBadge").textContent = "RPC: arb-mainnet.g.alchemy.com";

  const state = { prices:{}, ethUSD:null, gasGwei:null };

  // --- helpers
  const fmtUSD = v => isFinite(v) ? "$"+Number(v).toLocaleString(undefined,{maximumFractionDigits:2}) : "—";
  const fmt = (v, d=4) => isFinite(v) ? Number(v).toFixed(d) : "—";

  function constantProductUSDCtoToken(usdcIn, priceUsd, liqUsd, fee=DEX_FEE){
    // Approximate a V2 pool with total liquidity liqUsd; assume USDC and token sides each ~liqUsd/2.
    // tokenReserve = (liqUsd/2)/priceUsd ; usdcReserve = liqUsd/2
    if(!(usdcIn>0) || !(priceUsd>0) || !(liqUsd>0)) return 0;
    const Ru = liqUsd/2;             // USDC reserve ($)
    const Rt_tokens = (liqUsd/2)/priceUsd; // token reserve (units)
    const usdcAfterFee = usdcIn*(1-fee);
    // amountOut tokens = Rt * usdcAfterFee / (Ru + usdcAfterFee)
    const tokenOut = Rt_tokens * (usdcAfterFee / (Ru + usdcAfterFee));
    return tokenOut;
  }
  function constantProductTokentoUSDC(tokenIn, priceUsd, liqUsd, fee=DEX_FEE){
    if(!(tokenIn>0) || !(priceUsd>0) || !(liqUsd>0)) return 0;
    const Ru = liqUsd/2;             // USDC reserve ($)
    const Rt_tokens = (liqUsd/2)/priceUsd;
    const tokenAfterFee = tokenIn*(1-fee);
    // amountOut usdc = Ru * tokenAfterFee / (Rt + tokenAfterFee)
    const usdcOut = Ru * (tokenAfterFee / (Rt_tokens + tokenAfterFee));
    return usdcOut;
  }
  function netPL(loan, buyPx, buyLiq, sellPx, sellLiq, gasUSD){
    // Simulate USDC -> token on buy, then token -> USDC on sell
    const tokenOut = constantProductUSDCtoToken(loan, buyPx, buyLiq);
    const backUSDC = constantProductTokentoUSDC(tokenOut, sellPx, sellLiq);
    const fee = loan*FLASH_FEE;
    const pl = backUSDC - loan - fee - (gasUSD||0);
    const spread = (sellPx - buyPx) / buyPx * 100;
    return { backUSDC, pl, spread };
  }

  // --- fetch ETH price (for gas USD)
  async function fetchETHUSD(){
    try{
      const r = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd",{cache:"no-store"});
      const j = await r.json(); const p = j?.ethereum?.usd;
      if(typeof p === "number") return p;
    }catch(_){}
    return null;
  }
  // --- fetch gas (gwei) using feeHistory; fallback to gasPrice
  async function fetchGasGwei(){
    const payload = { jsonrpc:"2.0", id:1, method:"eth_feeHistory", params:[5,"latest",[10,50,90]] };
    try{
      let r = await fetch(RPC,{method:"POST",headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok) throw new Error("feeHistory http "+r.status);
      const j = await r.json(); const bh = j?.result; if(!bh?.baseFeePerGas) throw new Error("bad feeHistory");
      const lastBase = parseInt(bh.baseFeePerGas.at(-1),16)/1e9; // gwei
      const tip50 = parseInt((bh.reward.at(-1)||[])[1]||"0x0",16)/1e9;
      return lastBase + tip50;
    }catch(_){
      try{
        const r2 = await fetch(RPC,{method:"POST",headers:{'content-type':'application/json'},body:JSON.stringify({jsonrpc:"2.0",id:2,method:"eth_gasPrice",params:[]})});
        const j2 = await r2.json(); const wei = parseInt(j2?.result||"0x0",16); if(wei>0) return wei/1e9;
      }catch(_){}
    }
    return null;
  }

  // --- Dexscreener fetch & process for one token
  async function scanToken(symbol, loanUSD, guardX, capPct){
    const chainId = "arbitrum";
    // quick symbol->address map (extend as needed)
    const ADDR = {
      WETH:"0x82af49447d8a07e3bd95bd0d56f35241523fbab1",
      USDC:"0xaf88d065e77c8cC2239327C5EDb3A432268e5831",
      USDT:"0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",
      DAI:"0xda10009cbd5d07dd0cecc66161fc93d7c9000da1",
      ARB:"0x912CE59144191C1204E64559FE8253a0e49E6548",
      LINK:"0xf97f4df75117a78c1A5a0DBb814Af92458539FB4",
      GMX:"0xfc5A1A6EB076a2C7aD06eD22C90d7E710E35ad0a",
      AAVE:"0xba5DdD1f9d7F570dc94a51479a000E3BCE967196",
      WBTC:"0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f",
      RDNT:"0x3082CC23568eA640225c2467653dB90e9250AaA0",
      PENDLE:"0x0c880f6761F1af8d9Aa9C466984b80DAb9a8c9e8",
      "USDC.e":"0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d"
    };
    const addr = ADDR[symbol]; if(!addr) return null;
    try{
      const r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${addr}`,{cache:"no-store"});
      if(!r.ok) return null; const j = await r.json(); let pairs = j?.pairs||[];
      pairs = pairs.filter(p => p.chainId===chainId && p.quoteToken && (p.quoteToken.symbol==="USDC" || p.quoteToken.symbol==="USDC.e"));
      if(!pairs.length) return { symbol, note:"no USDC pairs" };

      // keep one per DEX (highest liquidity)
      const byDex = new Map();
      for(const p of pairs){
        const dex = (p.dexId||"").toLowerCase(); if(!ALLOW_DEX.has(dex)) continue;
        const liq = Number(p.liquidity?.usd||0);
        const prev = byDex.get(dex);
        if(!prev || liq > Number(prev.liquidity?.usd||0)) byDex.set(dex,p);
      }
      const list = Array.from(byDex.values());
      if(!list.length) return { symbol, note:"no allowed dex" };

      // choose best buy (lowest price) & sell (highest price) with guards
      const guardUSD = guardX * loanUSD;
      const viable = list.filter(p => Number(p.liquidity?.usd||0) >= guardUSD);
      if(!viable.length) return { symbol, note:"thin" };

      viable.sort((a,b)=>Number(a.priceUsd)-Number(b.priceUsd));
      const buy = viable[0];
      viable.sort((a,b)=>Number(b.priceUsd)-Number(a.priceUsd));
      const sell = viable[0];
      if(!buy || !sell || buy.pairAddress===sell.pairAddress) return { symbol, note:"no cross-dex" };

      const buyPx = Number(buy.priceUsd), sellPx = Number(sell.priceUsd);
      const rawSpread = (sellPx - buyPx)/buyPx*100;
      if(!(isFinite(rawSpread)) || rawSpread<=0) return { symbol, note:"neg spread" };
      if(rawSpread > capPct) return { symbol, note:"capped" };

      const buyLiq = Number(buy.liquidity?.usd||0);
      const sellLiq = Number(sell.liquidity?.usd||0);

      // gas USD
      const ethUSD = state.ethUSD || Number($("ethUsd").value)||0;
      const gwei = state.gasGwei || Number($("gasPrice").value)||0;
      const gasLimit = Number($("gasLimit").value)||380000;
      const gasUSD = (ethUSD && gwei) ? (gwei*1e-9*gasLimit*ethUSD) : 0;

      const { backUSDC, pl, spread } = netPL(loanUSD, buyPx, buyLiq, sellPx, sellLiq, gasUSD);
      return {
        symbol,
        buyDex:(buy.dexId||"").toUpperCase(),
        buyPx, sellDex:(sell.dexId||"").toUpperCase(), sellPx,
        spread, backUSDC, pl
      };
    }catch(_){ return null; }
  }

  function renderRows(rows){
    const tb = $("tbody"); tb.innerHTML = "";
    let selSum = 0;
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      const good = r?.pl>0;
      tr.innerHTML = `
        <td><input type="checkbox" class="sel"></td>
        <td>${r.symbol||"—"}</td>
        <td>${r.buyDex||"—"}</td>
        <td class="right">${isFinite(r.buyPx)?fmtUSD(r.buyPx):"—"}</td>
        <td>${r.sellDex||"—"}</td>
        <td class="right">${isFinite(r.sellPx)?fmtUSD(r.sellPx):"—"}</td>
        <td class="right">${isFinite(r.spread)?fmt(r.spread,2)+"%":"—"}</td>
        <td class="right">${isFinite(r.backUSDC)?fmtUSD(r.backUSDC):"—"}</td>
        <td class="right ${good?"green":"red"}">${isFinite(r.pl)?(good?"+":"")+fmtUSD(r.pl):"—"}</td>
      `;
      const cb = tr.querySelector(".sel");
      cb.addEventListener("change",()=>{
        selSum += cb.checked ? (r.pl||0) : -(r.pl||0);
        $("sumPill").textContent = `Selected total: ${(selSum>=0?"+":"")}${fmtUSD(selSum)}`;
      });
      tb.appendChild(tr);
    });
  }

  // Buttons
  $("clearSel").addEventListener("click",()=>{
    document.querySelectorAll(".sel").forEach(ch=>ch.checked=false);
    $("sumPill").textContent = "Selected total: +$0";
  });
  $("selAll").addEventListener("click",()=>{
    let sum=0; document.querySelectorAll(".sel").forEach(ch=>{
      const row = ch.closest("tr"); const last = row?.lastElementChild?.textContent||"";
      const val = Number(last.replace(/[^0-9.-]/g,""));
      const positive = /[\+\-]?\$/.test(last) && val>0;
      ch.checked = positive; if(positive) sum += val;
    });
    $("sumPill").textContent = `Selected total: ${(sum>=0?"+":"")}${fmtUSD(sum)}`;
  });

  // Scan
  $("scanBtn").addEventListener("click", async ()=>{
    const loan = Number($("loan").value)||10000;
    const cap = Number($("cap").value)||50;
    const guard = Number($("liqGuard").value)||10;

    $("loading").style.display = "flex";
    $("kpiNote").textContent = "Fetching gas & ETH…";
    // gas + eth
    state.ethUSD = Number($("ethUsd").value) || await fetchETHUSD();
    state.gasGwei = Number($("gasPrice").value) || await fetchGasGwei();
    $("ethUsd").value = state.ethUSD ? String(state.ethUSD) : "";
    $("gasPrice").value = state.gasGwei ? state.gasGwei.toFixed(2) : "";
    $("gasBadge").textContent = `Gas: ${state.gasGwei?state.gasGwei.toFixed(2):"—"} gwei`;

    $("kpiNote").textContent = "Scanning tokens…";
    $("progress").textContent = `0/${TOKENS.length} • loan ${fmtUSD(loan)}`;
    const out = [];
    let i=0;
    for(const sym of TOKENS){
      $("progress").textContent = `${++i}/${TOKENS.length} • loan ${fmtUSD(loan)}`;
      const row = await scanToken(sym, loan, guard, cap);
      if(row && row.pl!=null) out.push(row);
    }
    // sort by P/L desc
    out.sort((a,b)=> (b.pl||-1) - (a.pl||-1));
    renderRows(out);
    $("progress").textContent = `Done • ${out.filter(r=>r.pl>0).length} ≥ $0 • loan ${fmtUSD(loan)}`;
    $("kpiNote").textContent = "Complete.";
    $("loading").style.display = "none";
  });

  // init
  $("kpiNote").textContent = "Ready. Click Scan for realistic, slippage-aware results.";
})();
</script>
</body>
</html>
