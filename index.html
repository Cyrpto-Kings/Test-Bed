<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Crypto Kings – Diag v9.9.22b</title>
<style>
:root{--bg:#f7f8fb;--panel:#fff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--ok:#16a34a;--bad:#ef4444;--b1:#6d5cff;--b2:#1d9bf0;--ring:rgba(29,155,240,.25)}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 24px rgba(10,20,50,.04)}
.card{padding:14px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--b1),var(--b2));display:grid;place-items:center;color:#fff;font-weight:800}
.badge{font-size:12px;color:#fff;background:#9ca3af;border-radius:999px;padding:4px 8px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
input:focus{border-color:var(--b2);box-shadow:0 0 0 3px var(--ring)}
.row{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:760px){.row-4{grid-template-columns:repeat(4,1fr)}}
.btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;color:#fff;background:linear-gradient(135deg,var(--b1),var(--b2))}
.ghost{background:#f3f4f6;color:var(--ink);border:1px solid var(--line)}
.pill{display:inline-flex;align-items:center;gap:8px;font-size:12px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;margin-right:8px;margin-bottom:8px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
.ok{color:var(--ok)}.bad{color:var(--bad)}.help{font-size:12px;color:var(--muted)}
.spinner{width:24px;height:24px;border:3px solid #e5e7eb;border-top:3px solid var(--b2);border-radius:50%;animation:spin 1s linear infinite;margin:12px auto}
@keyframes spin{to{transform:rotate(360deg)}}
.notice{background:#fff1f2;border:1px solid #fecaca;color:#7f1d1d;border-radius:12px;padding:10px 12px;margin-bottom:12px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap}
.tooltip{position:relative;cursor:help}
.tooltip:hover::after{content:attr(data-tip);position:absolute;left:50%;transform:translateX(-50%);bottom:120%;background:#111827;color:#fff;white-space:pre;padding:8px 10px;border-radius:8px;font-size:12px;box-shadow:0 8px 24px rgba(0,0,0,.25);min-width:220px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div style="display:flex;align-items:center;gap:10px">
      <div class="logo">CK</div>
      <div>
        <div style="font-weight:800">Crypto Kings</div>
        <div class="help">Diag v9.9.22b • Arbitrum</div>
      </div>
    </div>
    <div class="badge">UI + network diagnostics</div>
  </header>

  <div id="appNotice" class="notice" style="display:none"></div>

  <section class="panel card">
    <div class="row row-4">
      <div><label>Loan (USDC)</label><input id="loan" type="number" value="10000" min="1" step="1"/></div>
      <div><label>Gas Limit</label><input id="gasLimit" type="number" value="150000" min="1" step="1000"/></div>
      <div><label>Gas (gwei)</label><input id="gasGwei" type="number" value="0.05" step="0.01"/></div>
      <div><label>RPC</label><div class="pill" id="rpcName">arb-mainnet.g.alchemy.com</div></div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
      <button class="btn" id="scanBtn">Scan</button>
      <button class="ghost" id="stopBtn">Stop</button>
      <div id="status" class="help">Idle.</div>
    </div>
  </section>

  <section class="panel card" style="margin-top:12px">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button class="ghost" id="selectProf">Select all profitable</button>
      <button class="ghost" id="clearSel">Clear</button>
      <div class="pill">Selected total: <span id="selTotal">+$0</span></div>
      <button class="btn" id="execBtn">Execute Selected (Preview)</button>
    </div>
    <div id="loading" class="spinner" style="display:none"></div>
    <div class="help" id="progress" style="margin:6px 0 10px">—</div>
    <div style="overflow:auto">
      <table class="table">
        <thead><tr>
          <th style="width:34px"><input type="checkbox" id="checkAll"/></th>
          <th>Token / Route</th><th>Price</th><th>Spread %</th><th>USDC Back</th><th>Net P/L</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <details style="margin-top:8px"><summary>Details / Logs</summary>
      <pre id="logs" style="white-space:pre-wrap;margin:10px 0 0;color:#0a1a2a;background:#f3f4f6;border:1px solid var(--line);border-radius:8px;padding:10px;max-height:320px;overflow:auto"></pre>
    </details>
  </section>
</div>

<script>
(() => {
// ===== minimal safe wiring FIRST =====
const $ = id => document.getElementById(id);
const log = m => { const L=$("logs"); L.textContent += (m + "\\n"); L.scrollTop = L.scrollHeight; };
let abortFlag = false;

function showNotice(msg){
  const n = $("appNotice"); n.style.display="block"; n.textContent = "App notice\\n" + msg;
}

window.addEventListener("error", (e)=> showNotice(String(e.message||e)));
window.addEventListener("unhandledrejection", (e)=> showNotice("Promise rejection: " + (e.reason?.message||e.reason)));

// wire buttons now
$("scanBtn").addEventListener("click", ()=>{ try { startScan(); } catch(err){ showNotice("startScan error: "+err.message); }});
$("stopBtn").addEventListener("click", ()=>{ abortFlag=true; setStatus("Stopped."); });
$("selectProf").addEventListener("click", ()=>{ document.querySelectorAll(".pick").forEach(c=>{const v=Number(c.dataset.pl||0); c.checked=v>0;}); recalcSelected(); });
$("clearSel").addEventListener("click", ()=>{ document.querySelectorAll(".pick").forEach(c=>c.checked=false); recalcSelected(); });
$("checkAll").addEventListener("change",(e)=>{ const on=e.target.checked; document.querySelectorAll(".pick").forEach(c=>c.checked=on); recalcSelected(); });
$("execBtn").addEventListener("click", ()=> alert("Preview only."));

function setStatus(t){ $("status").textContent=t; }
function fmtUSD(v,dp=2){ return isFinite(v) ? "$"+Number(v).toLocaleString(undefined,{minimumFractionDigits:dp,maximumFractionDigits:dp}) : "—"; }
function percent(a){ return (a*100).toFixed(2)+"%"; }
function recalcSelected(){
  let total=0; document.querySelectorAll(".pick").forEach(c=>{ if(c.checked) total+=Number(c.dataset.pl||0); });
  $("selTotal").textContent = (total>=0?"+":"")+fmtUSD(total);
}

// ===== constants (after wiring) =====
const TOKENS = ["WETH","USDC","USDT","DAI","ARB","LINK","GMX","AAVE","WBTC","RDNT","PENDLE","FRAX","CRV","BAL","UNI","wstETH","GRT","STG","MAGIC"];
const ADDR = {
  WETH:"0x82af49447d8a07e3bd95bd0d56f35241523fbab1",
  USDC:"0xaf88d065e77c8C2239327C5EDb3A432268e5831",
  USDT:"0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",
  DAI :"0xda10009cbd5d07dd0cecc61…000da1".replace("…","61fc93d7c9"),
  ARB :"0x912CE59144191C1204E64559FE8253a0e49E6548",
  LINK:"0xf97f4df75117a78c1A5a0DBb814Af92458539FB4",
  GMX :"0xfc5a1a6eb076a2c7ad06ed22c90d7e710e35ad0a",
  AAVE:"0xba5DdD1f9d7F570dc94a51479a000E3BCE967196",
  WBTC:"0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f",
  RDNT:"0x3082CC23568eA640225c2467653dB90e9250AaA0",
  PENDLE:"0x0c880f6761F1af8d9Aa9C466984b80DAb9a8c9e8",
  FRAX:"0x17FC002b466eEc40DaE837Fc4bE5c67993ddBd6F",
  CRV :"0x11cdb42b0eb46d95f990bedd4695a6e3fa034978",
  BAL :"0x040d1edc9569d4bab2d15287dc5a4f10f56a56b8",
  UNI :"0xfa7f8980b0f1e64a2062791cc3b0871572f1f7f0",
  wstETH:"0x5979D7b546E38E414F7E9822514be443A4800529",
  GRT :"0x23A941036Ae778Ac51Ab04CEa08Ed6e2FE103614",
  STG :"0x6694340fc020c5E6b96567843da2df01b2CE1eb6",
  MAGIC:"0x539bdE0d7Dbd336b79148AA742883198BBF60342",
};
const DEX_FEE_PER_LEG=0.003, SLIP_PER_LEG=0.0005, FLASH_FEE=0.0009, SPREAD_CAP=0.25, FRESH_MIN=15, LIQ_MULT=1.5;
let ETH_USD=3600;

// ===== utils =====
function time(){return new Date().toLocaleTimeString();}
function tsFreshEnough(ts){ if(!ts) return false; return ((Date.now()-new Date(ts).getTime())/60000)<=FRESH_MIN; }
function timeoutFetch(url, ms){
  const ctl=new AbortController(); const t=setTimeout(()=>ctl.abort(), ms);
  return fetch(url,{signal:ctl.signal,cache:"no-store"}).finally(()=>clearTimeout(t));
}

// ===== network helpers =====
async function getETHUSD(){
  try{
    const r=await timeoutFetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd",7000);
    if(!r.ok) throw new Error("coingecko HTTP "+r.status);
    const j=await r.json(); const p=j?.ethereum?.usd; if(typeof p==="number"){ ETH_USD=p; }
  }catch(e){ log(`[${time()}] ETH price fallback: ${e.message}`); }
}
async function getPairs(addr){
  const url=`https://api.dexscreener.com/latest/dex/tokens/${addr}`;
  try{
    const r=await timeoutFetch(url,10000);
    if(!r.ok) throw new Error("Dexscreener HTTP "+r.status);
    return await r.json();
  }catch(e){ throw new Error(`fetch ${url} failed: ${e.message}`); }
}

// ===== math/render =====
function computeNet(loanUSD,buyPrice,sellPrice,gasGwei,gasLimit){
  const units=loanUSD/buyPrice, grossBack=units*sellPrice;
  const dexFees=loanUSD*DEX_FEE_PER_LEG + grossBack*DEX_FEE_PER_LEG;
  const slip=loanUSD*SLIP_PER_LEG + grossBack*SLIP_PER_LEG;
  const flash=loanUSD*FLASH_FEE;
  const gasUSD=(gasGwei*gasLimit/1e9)*ETH_USD;
  const netBack=grossBack-dexFees-slip-flash-gasUSD;
  const netPL=netBack-loanUSD;
  return {netPL,netBack,rawSpread:(sellPrice-buyPrice)/buyPrice, br:{dexFees:dx=dexFees,slipp:slip,flash,gasUSD,units,grossBack}};
}
function tip(br){return `fees: $${br.dexFees.toFixed(2)}\\nslip: $${br.slipp.toFixed(2)}\\nflash: $${br.flash.toFixed(2)}\\ngas: $${br.gasUSD.toFixed(2)}\\nunits: ${br.units.toFixed(6)}\\ngross back: $${br.grossBack.toFixed(2)}`;}
function pushRow(tb,rec){
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td><input type="checkbox" class="pick" data-pl="${rec.netPL}"></td>
    <td><div style="font-weight:700">${rec.token}</div><div class="help">${rec.buyDex} → ${rec.sellDex}</div></td>
    <td class="tooltip" data-tip="${tip(rec.br)}">${fmtUSD(rec.buyPrice)} → ${fmtUSD(rec.sellPrice)}</td>
    <td>${percent(rec.rawSpread)}</td>
    <td>${fmtUSD(rec.netBack)}</td>
    <td class="${rec.netPL>=0?'ok':'bad'}">${(rec.netPL>=0?'+':'')+fmtUSD(rec.netPL)}</td>`;
  tb.appendChild(tr);
}

// ===== SCAN =====
async function startScan(){
  abortFlag=false;
  $("tbody").innerHTML=""; $("loading").style.display="block"; $("progress").textContent="—";
  $("appNotice").style.display="none"; $("appNotice").textContent="";
  const loan=Number($("loan").value||0), gasLimit=Number($("gasLimit").value||150000), gasGwei=Number($("gasGwei").value||0.05);
  setStatus("CLICK → START"); log(`[${time()}] CLICK Scan; tokens=${TOKENS.length}; loan=${loan}; gas=${gasGwei} gwei x ${gasLimit}`);
  if(!(loan>0)){ setStatus("Enter a positive loan."); $("loading").style.display="none"; return; }
  await getETHUSD();

  let done=0, hits=0;
  for(const sym of TOKENS){
    if(abortFlag){ setStatus("Stopped."); break; }
    done++; $("progress").textContent=`Progress ${done}/${TOKENS.length}`;
    const addr=ADDR[sym]; if(!addr){ log(`[${time()}] ${sym}: no address`); continue; }
    try{
      const j=await getPairs(addr);
      let pairs=(j?.pairs||[]).filter(p=>p.chainId==="arbitrum");
      if(!pairs.length){ log(`[${time()}] ${sym}: no pools on Arbitrum`); continue; }
      // keep USDC/USDT, fresh≤15m, liq≥1.5×loan
      pairs=pairs.filter(p=>{
        const q=(p?.quoteToken?.symbol||"").toUpperCase();
        const fresh=tsFreshEnough(p?.txns?.m5?.lastAt||p?.updatedAt);
        const liq=Number(p?.liquidity?.usd||0);
        const price=Number(p?.priceUsd||0);
        return (q==="USDC"||q==="USDT") && fresh && liq >= loan*1.5 && price>0;
      });
      if(pairs.length<2){ log(`[${time()}] ${sym}: not enough liquid/fresh USDC/USDT pools`); continue; }

      // best buy/sell
      let min=Infinity, max=-Infinity, buy=null, sell=null;
      for(const p of pairs){ const pr=Number(p.priceUsd); if(pr<min){min=pr;buy=p;} if(pr>max){max=pr;sell=p;} }
      const raw=(max-min)/min; if(raw<=0 || raw>0.25){ log(`[${time()}] ${sym}: spread ${percent(raw)} outside 0–25%`); continue; }

      const r=computeNet(loan,min,max,gasGwei,gasLimit);
      pushRow($("tbody"),{token:sym,buyDex:(buy.dexId||"").toUpperCase(),sellDex:(sell.dexId||"").toUpperCase(),buyPrice:min,sellPrice:max,rawSpread:r.rawSpread,netBack:r.netBack,netPL:r.netPL,br:r.br});
      hits++;
    }catch(err){
      log(`[${time()}] ${sym}: ${err.message}`);
    }
  }
  $("loading").style.display="none";
  setStatus(`Done. Found ${hits} routes.`);
}

})(); 
</script>
</body>
</html>
