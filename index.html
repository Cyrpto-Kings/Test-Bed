<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Crypto Kings Test Bed v9.6.0 — Liquidity Guard Controls</title>
<style>
  :root{ --bg:#f6f7f9; --surface:#fff; --ink:#111827; --muted:#6b7280; --brand:#7c5cff; --brand2:#1d9bf0; --ring:rgba(124,92,255,.35); --border:#e5e7eb; --border-strong:#d1d5db; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column;min-height:100vh;overflow-x:hidden}
  .container{max-width:1100px;width:100%;margin:0 auto;padding:0 16px}
  main{flex:1}
  .topbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border)}
  .topbar-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;flex-wrap:wrap}
  .home-link{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
  .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(29,155,240,.18)}
  .logo span{font-size:14px;font-weight:900;color:white}
  .brand{font-weight:800;letter-spacing:.3px;white-space:nowrap}
  .chip{display:inline-block;padding:2px 8px;border:1px solid var(--border-strong);border-radius:999px;font-size:12px;background:#eef2ff;color:#3b3b6d}

  .group{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:6px 8px}
  .group input{width:160px;padding:8px 10px;border:1px solid var(--border-strong);border-radius:8px}
  .group input:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring)}
  .group .small{width:120px}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;color:white;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 6px 16px rgba(124,92,255,.15);min-height:44px}
  .btn.ghost{background:#fff;color:#111;border:1px solid var(--border-strong);box-shadow:none}
  .btn.small{padding:8px 12px;min-height:36px}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  main .wrap{padding:16px 0 80px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:960px){ .row-4{grid-template-columns:repeat(4,1fr)} .row-5{grid-template-columns:repeat(5,1fr)} }
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[readonly]{background:#f9fafb;color:#4b5563}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
  .stat{font-size:12px;color:#6b7280;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}

  .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch}
  table{min-width:980px;width:100%}
  .table{border-collapse:collapse;margin-top:10px;background:#fff;border:1px solid var(--border)}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;text-align:left;white-space:nowrap}
  .table th{color:#374151;font-weight:700;background:#f9fafb}
  .table tr:nth-child(even){background:#fafafa}
  .right{text-align:right}
  .pos{background:#ecfdf5} .neg{background:#fef2f2} .meh{background:#f9fafb}

  @media (max-width:560px){
    table{min-width:0}
    .table thead{display:none}
    .table tr{display:grid;grid-template-columns:1fr;gap:6px;background:#fff;border:1px solid var(--border);border-radius:12px;margin:10px 0;padding:10px 10px}
    .table td{display:flex;justify-content:space-between;align-items:center;gap:10px;white-space:normal;border:0;padding:6px 0}
    .table td::before{content:attr(data-label);font-size:12px;color:#6b7280;margin-right:10px;flex:0 0 auto}
    .right{text-align:right}
  }

  footer{background:#fff;border-top:1px solid var(--border);margin-top:40px}
  .footer-inner{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:30px 0}
  footer h4{margin:0 0 8px;font-size:14px;color:#374151}
  footer ul{list-style:none;margin:0;padding:0;font-size:13px;color:#4b5563}
  footer li{margin:4px 0}
  footer a{color:inherit;text-decoration:none}
  footer a:hover{text-decoration:underline}
  .copyright{border-top:1px solid var(--border);padding:12px 0;font-size:12px;color:#6b7280;text-align:center}
</style>
</head>
<body>
  <div class="topbar" style="padding-top: env(safe-area-inset-top)">
    <div class="container topbar-inner">
      <a class="home-link" href="/"><div class="logo"><span>CK</span></div><div class="brand">Crypto Kings</div></a>
      <span class="chip">v9.6.0</span>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <div class="group">
          <label for="loanUsd" class="help">Loan Size (USD)</label>
          <input id="loanUsd" type="number" min="100" max="1000000" step="500" value="10000" inputmode="decimal">
        </div>
        <div class="group">
          <label for="liqMult" class="help">Liquidity Guard (× loan)</label>
          <input id="liqMult" class="small" type="number" min="1" max="50" step="1" value="10">
        </div>
        <div class="group">
          <label for="minLiq" class="help">Min Pool Liquidity (USD)</label>
          <input id="minLiq" class="small" type="number" min="0" step="1000" value="25000">
        </div>
        <button id="scanBtn" class="btn">Scan</button>
      </div>
    </div>
  </div>

  <main class="container wrap">
    <div class="card">
      <div class="row row-4">
        <div><label>Network</label><input value="Arbitrum" readonly></div>
        <div><label>Gas (auto)</label><input id="gas-gwei" placeholder="Auto" readonly><div class="help" id="gas-note">—</div></div>
        <div><label>Gas Limit</label><input id="gas-limit" type="number" step="1000" value="380000"><div class="help">Two swaps + callback ≈ 350–450k</div></div>
        <div><label>Est. Gas Cost</label><input id="gas-cost" placeholder="—" readonly><div class="help" id="gas-cost-usd">—</div></div>
      </div>

      <div class="row" style="margin-top:6px"><div><span id="status" class="help">Ready.</span></div></div>

      <div class="toolbar">
        <span id="statFound" class="stat">Found: 0</span>
        <span id="statProf" class="stat">Profitable: 0</span>
        <span id="statFiltered" class="stat">Filtered by Liquidity: 0</span>
        <span id="statSel" class="stat">Selected: 0</span>
        <span id="statTotalNet" class="stat">Total Selected Net: $0.00</span>
        <button id="btnSelectProf" class="btn small ghost" disabled>Select all profitable</button>
        <button id="btnClearSel" class="btn small ghost" disabled>Clear selection</button>
        <button id="btnExecute" class="btn small" disabled>Execute selected (mock)</button>
      </div>

      <div class="table-wrap">
        <table class="table" id="oppsTable">
          <thead>
            <tr>
              <th><input type="checkbox" id="chkAll" /></th>
              <th>Token</th>
              <th>Best Buy</th>
              <th>Best Sell</th>
              <th class="right">Raw Spread %</th>
              <th class="right">Net (Aave+gas)</th>
              <th class="right">Min Pool Liquidity</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer>
    <div class="container footer-inner">
      <div><div class="logo"><span>CK</span></div><p class="help">Dexscreener search → best buy/sell per token. Liquidity guard is adjustable to explore larger loans.</p></div>
      <div><h4>Quick</h4><ul><li><a href="#" id="lkScan">Scan</a></li></ul></div>
      <div><h4>Networks</h4><ul><li>Arbitrum (active)</li><li>Others (soon)</li></ul></div>
      <div><h4>Contact</h4><ul><li><a href="mailto:info@example.com">info@example.com</a></li></ul></div>
    </div>
    <div class="copyright">© 2025 Crypto Kings. All rights reserved.</div>
  </footer>

<script>
/* Error banner */
(function(){const show=(m,s,l,c,e)=>{try{const b=document.createElement('div');b.style.margin='12px auto';b.style.maxWidth='1100px';b.innerHTML='<div style="background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d;padding:10px 12px;border-radius:10px"><strong>App notice</strong><pre style="white-space:pre-wrap;margin:6px 0 0;font-size:12px;color:#7f1d1d">'+(e&&e.stack?e.stack:[m,s,l+':'+c].filter(Boolean).join(' | '))+'</pre></div>';document.body.prepend(b);}catch(_){}return false;};window.onerror=show;window.onunhandledrejection=e=>show('Unhandled promise rejection','','','',e&&(e.reason||e));})();
</script>

<script>
/* v9.6.0 — Dexscreener search + liquidity guard controls */
(function(){
  const $=id=>document.getElementById(id);
  const on=(el,ev,fn)=>{ if(el) el.addEventListener(ev,fn); };
  const fmtUSD=v=>isFinite(v)?`$${Number(v).toLocaleString(undefined,{maximumFractionDigits:6})}`:"—";
  const pct=(a,b)=>((b-a)/Math.max(1e-9,a))*100;
  const setStatus=msg=>{ const s=$("status"); if(s) s.textContent=msg; };

  /* Tunables (now from inputs) */
  const PLATFORM_FEE=0.0009;               // Aave 0.09%
  const CHAIN="arbitrum";
  const MAX_ROWS=400;                      // display cap

  function loanUSD(){ let v=parseFloat($("loanUsd").value||"0"); if(!isFinite(v)) v=10000; v=Math.max(100,Math.min(1_000_000,v)); $("loanUsd").value=String(v); return v; }
  function liqMultiplier(){ let v=parseFloat($("liqMult").value||"10"); if(!isFinite(v)||v<1) v=10; $("liqMult").value=String(Math.round(v)); return Math.round(v); }
  function minPoolLiq(){ let v=parseFloat($("minLiq").value||"25000"); if(!isFinite(v)||v<0) v=25000; $("minLiq").value=String(Math.round(v)); return Math.round(v); }

  /* Gas */
  const gas={ gwei:0.20, usdPerNative:0, usd:0 };
  async function cgETH(){ try{ const r=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd",{cache:"no-store"}); if(!r.ok) return null; const j=await r.json(); return j?.ethereum?.usd??null; }catch(_){ return null; } }
  async function ethFeeHistory(){
    try{ const r=await fetch("https://arbitrum-one.publicnode.com",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:1,method:"eth_feeHistory",params:[5,"latest",[10,50,90]]})}); if(!r.ok) return null; const j=await r.json(),bh=j?.result; const base=parseInt(bh.baseFeePerGas.at(-1),16)/1e9; const tip=parseInt((bh.reward.at(-1)||[])[1]||"0x0",16)/1e9; return base+tip; }catch(_){ return null; }
  }
  async function initGas(){
    const [ethUsd,g]=await Promise.all([cgETH(),ethFeeHistory()]);
    gas.usdPerNative=ethUsd||0; gas.gwei=(typeof g==='number'&&g>0)?g:0.20;
    $("gas-gwei").value=`${gas.gwei.toFixed(2)} Gwei`;
    $("gas-note").textContent=`ETH ≈ ${fmtUSD(gas.usdPerNative)} • ${g?"auto":"fallback"}`;
    calcGasUSD();
  }
  function calcGasUSD(){
    const gl=parseFloat($("gas-limit").value||"0");
    const native=(gas.gwei>0&&gl>0)?(gas.gwei*gl)/1e9:0;
    gas.usd=native*(gas.usdPerNative||0);
    $("gas-cost").value=native?`${native.toFixed(6)} ETH`:"";
    $("gas-cost-usd").textContent=native?`≈ ${fmtUSD(gas.usd)}`:"—";
  }
  on($("gas-limit"),"input",calcGasUSD); on($("loanUsd"),"change",calcGasUSD);

  /* Dexscreener search */
  const SEARCH_TERMS=["USDC","USDT","WETH","ETH","ARB","DAI","WBTC","LINK","UNI","AAVE","MKR","OP","CRV","BAL","FRAX","LDO","GMX","RDNT","GNS","MAGIC","PENDLE","RPL","ENS","LUSD","wstETH","weETH","AERO","AERO-USDC","USD+","USDe","sDAI","rsETH","ezETH","swETH","STONE"];
  async function fetchSearch(term){
    const url=`https://api.dexscreener.com/latest/dex/search?q=${encodeURIComponent(term)}`;
    const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(`Dexscreener HTTP ${r.status}`);
    const j=await r.json(); return Array.isArray(j?.pairs)?j.pairs.filter(p=>p.chainId===CHAIN):[];
  }
  async function fetchArbitrumPairs(){
    let all=[]; for(const t of SEARCH_TERMS){ try{ all=all.concat(await fetchSearch(t)); }catch(_){/*skip*/} }
    const seen=new Set(), uniq=[]; for(const p of all){ const key=(p?.pairAddress||p?.url||"").toLowerCase(); if(!key||seen.has(key)) continue; seen.add(key); uniq.push(p); }
    // sort by liquidity desc and keep lots
    uniq.sort((a,b)=>(b?.liquidity?.usd||0)-(a?.liquidity?.usd||0));
    return uniq.slice(0,3000);
  }

  /* Best buy/sell per base token, keeping liquidity info */
  function computeBestRoutes(pairs){
    const minLiq = minPoolLiq();
    const valid=pairs.filter(p=>{
      const liq=Number(p?.liquidity?.usd||0), price=Number(p?.priceUsd||NaN);
      return isFinite(liq)&&liq>=minLiq&&isFinite(price)&&p?.baseToken?.symbol&&p?.quoteToken?.symbol;
    });
    const byBase=new Map();
    for(const p of valid){ const base=(p?.baseToken?.address||"").toLowerCase(); if(!base) continue; (byBase.get(base)||byBase.set(base,[]).get(base)).push(p); }
    const out=[];
    for(const [base, list] of byBase.entries()){
      let buy=null,sell=null,minP=Infinity,maxP=-Infinity;
      for(const px of list){ const pr=Number(px.priceUsd); if(!isFinite(pr)) continue; if(pr<minP){minP=pr; buy=px;} if(pr>maxP){maxP=pr; sell=px;} }
      if(!buy||!sell||!isFinite(minP)||!isFinite(maxP)||maxP<=0||minP<=0) continue;
      out.push({
        tokenAddr:base,
        tokenSym:buy.baseToken?.symbol || sell.baseToken?.symbol || base.slice(0,6),
        buyDex:(buy.dexId||"").toUpperCase(),
        buyPair:`${buy.baseToken?.symbol}/${buy.quoteToken?.symbol}`,
        buyPrice:minP,
        buyUrl:buy.url,
        buyLiq:Number(buy?.liquidity?.usd||0),
        sellDex:(sell.dexId||"").toUpperCase(),
        sellPair:`${sell.baseToken?.symbol}/${sell.quoteToken?.symbol}`,
        sellPrice:maxP,
        sellUrl:sell.url,
        sellLiq:Number(sell?.liquidity?.usd||0)
      });
    }
    return out;
  }

  /* State + render */
  let CURRENT_ROWS=[];
  function updateStats(){
    const total=CURRENT_ROWS.length;
    const prof=CURRENT_ROWS.filter(r=>r.net>0).length;
    const cbs=[...document.querySelectorAll('tbody input[type="checkbox"]')];
    const selIdx=cbs.map((cb,i)=>cb.checked?i:null).filter(i=>i!==null);
    const selected=selIdx.length;
    const totalNet=selIdx.reduce((s,i)=>s+(CURRENT_ROWS[i]?.net||0),0);
    $("statFound").textContent=`Found: ${total}`;
    $("statProf").textContent=`Profitable: ${prof}`;
    $("statSel").textContent=`Selected: ${selected}`;
    $("statTotalNet").textContent=`Total Selected Net: ${fmtUSD(totalNet)}`;
    $("btnSelectProf").disabled=prof===0;
    $("btnClearSel").disabled=selected===0;
    $("btnExecute").disabled=selected===0;
  }

  function render(rows){
    CURRENT_ROWS=rows;
    const tb=$("rows"); tb.innerHTML="";
    rows.forEach((r,idx)=>{
      const tr=document.createElement("tr");
      const cls=r.net>0?"pos":(r.net>-3?"meh":"neg");
      tr.className=cls;
      const minPoolLiq=Math.min(r.buyLiq||0,r.sellLiq||0);
      tr.innerHTML=`
        <td data-label="Select"><input type="checkbox" data-idx="${idx}"></td>
        <td data-label="Token"><code title="${r.tokenAddr}">${r.tokenSym}</code></td>
        <td data-label="Best Buy"><a href="${r.buyUrl}" target="_blank" rel="noopener">${r.buyDex}</a><div class="help">${r.buyPair} @ ${fmtUSD(r.buyPrice)} • liq ${fmtUSD(r.buyLiq||0)}</div></td>
        <td data-label="Best Sell"><a href="${r.sellUrl}" target="_blank" rel="noopener">${r.sellDex}</a><div class="help">${r.sellPair} @ ${fmtUSD(r.sellPrice)} • liq ${fmtUSD(r.sellLiq||0)}</div></td>
        <td class="right" data-label="Raw Spread">${r.rawPct.toFixed(2)}%</td>
        <td class="right" data-label="Net">${fmtUSD(r.net)}</td>
        <td class="right" data-label="Min Pool Liquidity">${fmtUSD(minPoolLiq)}</td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.addEventListener('change',updateStats));
    const master=$("chkAll");
    master.checked=false;
    master.onchange=()=>{ tb.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=master.checked); updateStats(); };
    updateStats();
  }

  function scoreAndFilter(routes){
    const L=loanUSD(), gasUSD=gas.usd||0, mult=liqMultiplier();
    let filteredByLiq=0;
    const enriched=routes.map(r=>{
      const rawPct=pct(r.buyPrice,r.sellPrice);
      const revenue=(L/r.buyPrice)*r.sellPrice;
      const net = revenue - L - (L*PLATFORM_FEE) - gasUSD;
      const minLiq=Math.min(r.buyLiq||0,r.sellLiq||0);
      const liqOK = minLiq >= (L*mult);
      if(!liqOK) filteredByLiq++;
      return {...r, rawPct, net, minLiq, liqOK};
    });
    const kept=enriched.filter(r=>r.liqOK).sort((a,b)=>b.net-a.net).slice(0,MAX_ROWS);
    $("statFiltered").textContent=`Filtered by Liquidity: ${filteredByLiq}`;
    return kept;
  }

  async function scan(){
    const tb=$("rows"); tb.innerHTML="";
    setStatus("Fetching gas…"); await initGas();
    setStatus("Querying Dexscreener…");
    let pairs=[];
    try{
      const res=await fetchArbitrumPairs();
      if(!res.length){ setStatus("No pairs from Dexscreener."); return; }
      pairs=res;
    }catch(e){ setStatus("Dexscreener error: "+(e?.message||e)); return; }

    setStatus(`Processing ${pairs.length} pairs…`);
    const routes=computeBestRoutes(pairs);
    if(!routes.length){ setStatus("No viable markets after base filtering."); render([]); return; }

    const scored=scoreAndFilter(routes);
    render(scored);
    setStatus(`Done • ${scored.length} routes (loan ${fmtUSD(loanUSD())}; guard ${liqMultiplier()}×; minLiq ${fmtUSD(minPoolLiq())})`);
    $("btnSelectProf").disabled = scored.filter(r=>r.net>0).length===0;
    $("btnClearSel").disabled = true;
    $("btnExecute").disabled = true;
  }

  function selectAllProfitable(){
    const tb=$("rows"); const cbs=tb.querySelectorAll('input[type="checkbox"]');
    CURRENT_ROWS.forEach((r,i)=>{ const cb=cbs[i]; if(!cb) return; cb.checked = r.net>0; });
    updateStats();
  }
  function clearSelection(){
    document.querySelectorAll('#rows input[type="checkbox"]').forEach(cb=>cb.checked=false);
    $("chkAll").checked=false; updateStats();
  }
  function executeSelectedMock(){
    const cbs=[...document.querySelectorAll('#rows input[type="checkbox"]')];
    const sel=cbs.map((cb,i)=>cb.checked?CURRENT_ROWS[i]:null).filter(Boolean);
    if(!sel.length){ alert("Select at least one route."); return; }
    const L = loanUSD();
    const lines = sel.slice(0,20).map(r =>
      `${r.tokenSym}: BUY ${r.buyDex} @ ${fmtUSD(r.buyPrice)} → SELL ${r.sellDex} @ ${fmtUSD(r.sellPrice)} | Net ${fmtUSD(r.net)} | MinLiq ${fmtUSD(r.minLiq)}`
    );
    const more = sel.length > 20 ? `\n… and ${sel.length - 20} more` : "";
    const totalNet = sel.reduce((s,r)=> s + (r.net||0), 0);
    const txid = '0x' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('');
    alert(
      `(Mock) Execute ${sel.length} route(s)\n` +
      `Loan: ${fmtUSD(L)}\n\n` +
      `• ${lines.join('\n• ')}${more}\n\n` +
      `TOTAL NET: ${fmtUSD(totalNet)}\n` +
      `TxID: ${txid}`
    );
  }

  on($("scanBtn"),"click",scan);
  on($("lkScan"),"click",(e)=>{e.preventDefault();scan();});
  on($("btnSelectProf"),"click",selectAllProfitable);
  on($("btnClearSel"),"click",clearSelection);
  on($("btnExecute"),"click",executeSelectedMock);

  (async()=>{ try{ await initGas(); }catch(_){} })();
})();
</script>
</body>
</html>
