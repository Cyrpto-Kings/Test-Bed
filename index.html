<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Crypto Kings TestBed v9.9.3d — Arbitrum</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
:root{--bg:#f6f7f9;--surface:#fff;--ink:#111827;--muted:#6b7280;--brand:#7c5cff;--brand2:#1d9bf0;--border:#e5e7eb;--ok:#10b981;--bad:#ef4444}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif}
header{background:#111;color:#fff}.bar{max-width:1100px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
.brand{display:flex;gap:10px;align-items:center}.logo{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:flex;align-items:center;justify-content:center;font-weight:900}
.wrap{max-width:1100px;margin:0 auto;padding:16px 12px 80px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 6px 16px rgba(0,0,0,.04)}
.row{display:grid;grid-template-columns:1fr;gap:8px}@media(min-width:760px){.row-5{grid-template-columns:repeat(5,1fr)}}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px}
button{border:0;border-radius:10px;padding:10px 14px;font-weight:700;color:#fff;cursor:pointer;background:linear-gradient(135deg,var(--brand),var(--brand2))}
.ghost{background:transparent;color:#111;border:1px solid var(--border)}
.status{display:flex;gap:10px;align-items:center;color:#6b7280;font-size:13px}
.spin{border:3px solid rgba(0,0,0,.08);border-top:3px solid var(--brand);border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.pill{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-left:8px}
.table-wrap{overflow-x:auto;border-radius:12px}
table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border:1px solid var(--border)}
th,td{padding:10px;border-bottom:1px solid var(--border);font-size:13px;text-align:left;white-space:nowrap}
th{background:#fafafa;position:sticky;top:0}.right{text-align:right}.ok{color:var(--ok)}.bad{color:var(--bad)}.hint{color:#6b7280;font-size:12px}
#log{margin-top:10px;font-size:12px;color:#374151;max-height:260px;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px}
.notice{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;border-radius:12px;padding:10px;margin:10px 0;white-space:pre-wrap}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand"><div class="logo">CK</div><strong>Crypto Kings</strong><span style="opacity:.75">v9.9.3d</span></div>
    <div id="walletStatus">Arbitrum One • Majors</div>
  </div>
</header>

<div class="wrap">
  <div id="notices"></div>

  <div class="card">
    <div class="row row-5">
      <div>
        <label for="loan">Loan Amount (USDC)</label>
        <input id="loan" type="number" value="1000" min="500" step="500"/>
      </div>
      <div>
        <label for="threshold">Min Net P/L to show (USDC)</label>
        <input id="threshold" type="number" value="0" min="0" step="1"/>
      </div>
      <div>
        <label for="interval">Auto-rescan</label>
        <select id="interval">
          <option value="0" selected>Off</option>
          <option value="15">15s</option>
          <option value="30">30s</option>
          <option value="60">60s</option>
        </select>
      </div>
      <div>
        <label for="autoExec">Auto-execute profitable</label>
        <select id="autoExec">
          <option value="0" selected>Off</option>
          <option value="1">On (mock)</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="scanBtn">Scan</button>
        <button id="stopBtn" class="ghost">Stop</button>
        <div class="status"><div id="spinner" class="spin" style="display:none"></div><span id="status">Booting…</span></div>
      </div>
    </div>
    <div class="hint" style="margin-top:6px">
      Net P/L = (USDC back − size) − 0.09% flash fee − est. gas.
      <span class="pill" id="rpcPill">RPC: —</span>
      <span class="pill" id="gasPill">Gas: —</span>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button id="selectProfitable" class="ghost">Select all ≥ threshold</button>
      <button id="clearSelection" class="ghost">Clear</button>
      <div style="font-weight:700">Selected total: <span id="totalNet">$0.00</span></div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="masterCheck"/></th>
            <th>Token</th>
            <th>Buy DEX</th>
            <th class="right">Token Out</th>
            <th>Sell DEX</th>
            <th class="right">USDC Back</th>
            <th class="right">Spread %</th>
            <th class="right">Net P/L</th>
            <th class="right">Size Used</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <details style="margin-top:10px">
      <summary>Details / Logs</summary>
      <div id="log"></div>
    </details>
  </div>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const fmt=(n,dp=2)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:dp});
  const log=(m)=>{const d=document.createElement('div'); d.textContent=m; $('log').appendChild(d); $('log').scrollTop=$('log').scrollHeight;};
  const notice=(m)=>{const n=document.createElement('div'); n.className='notice'; n.textContent='App notice\\n'+m; $('notices').prepend(n);};
  const setStatus=(t,spin)=>{$('status').textContent=t; $('spinner').style.display=spin?'inline-block':'none';};

  window.addEventListener('error', e=> notice(e.message+'\n'+(e.filename||'')+' | '+(e.lineno||0)+':'+(e.colno||0)));

  function boot(){
    try{
      if(typeof ethers==='undefined'){ notice('ethers not loaded — CDN blocked?'); $('status').textContent='Script error.'; return; }
      $('status').textContent='Ready.';
      bindUI();
    }catch(err){ notice(err.message); }
  }

  /* --------- RPC & provider --------- */
  const RPCS=[
    "https://arbitrum-one.publicnode.com",
    "https://1rpc.io/arb",
    "https://arbitrum.llamarpc.com",
    "https://arb1.arbitrum.io/rpc",
    "https://arbitrum.blockpi.network/v1/rpc/public"
  ];
  const CHAIN={ name:"arbitrum", chainId:42161 };
  let provider;
  function buildProvider(){
    const backends = RPCS.map((url,i)=>({ provider: new ethers.providers.StaticJsonRpcProvider({url, timeout:15000}, CHAIN), priority:i+1, stallTimeout:1800, weight:1 }));
    provider = new ethers.providers.FallbackProvider(backends,{quorum:1,polling:false});
  }
  async function warmupProvider(){
    try{
      const res = await Promise.race([provider.detectNetwork(), provider.getBlockNumber()]);
      const tag = (typeof res==='number') ? '#'+res : 'id '+res.chainId;
      $('rpcPill').textContent='RPC OK • '+tag;
      log('RPC warmup OK: '+tag);
      return true;
    }catch(e){
      $('rpcPill').textContent='RPC error';
      log('RPC warmup failed: '+e.message);
      return false;
    }
  }

  /* --------- Minimal quoting (same core as before, tighter timeouts) --------- */
  const WETH="0x82af49447d8a07e3bd95bd0d56f35241523fbab1";
  const USDC="0xaf88d065e77c8C2239327C5EDb3A432268e5831";
  const USDCe="0xff970a61a04b1ca14834a43f5de4533ebddb5cc8";
  const USDT="0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9";
  const TOKENS={ WETH, USDT, DAI:"0xda10009cbd5d07dd0cecc66161fc93d7c9000da1", ARB:"0x912CE59144191C1204E64559FE8253a0e49E6548", LINK:"0xf97f4df75117a78c1A5a0DBb814Af92458539FB4", GMX:"0xfc5A1A6EB076a2C7aD06eD22C90d7E710E35ad0a" };
  const ERC20_ABI=[ "function decimals() view returns (uint8)" ];
  const V2_ABI=[ "function getAmountsOut(uint amountIn,address[] calldata path) external view returns (uint[] memory)" ];
  const UNI_QV2="0x61fFE014bA17989E743c5F6cB21bF9697530B21e";
  const QV2_ABI=[ "function quoteExactInput(bytes path,uint256 amountIn) external returns (uint256,uint160,uint32,uint256)" ];
  const SUSHI="0x1b02da8cb0d097eb8d57a175b88c7d8b47997506";
  const CAMELOT="0xc873fEcbd354f5A56E00E710B90EF4201db2448d";
  const FEES=[500,3000,10000];
  const decCache=new Map();
  async function decimals(addr){ if(decCache.has(addr)) return decCache.get(addr); const d=await new ethers.Contract(addr,ERC20_ABI,provider).decimals(); decCache.set(addr,d); return d; }
  function packPath(hops){ const types=[],values=[]; for(let i=0;i<hops.length;i++){ if(i%2===0){types.push('address');values.push(hops[i]);} else {types.push('uint24');values.push(hops[i]);} } return ethers.utils.solidityPack(types,values); }
  function withTimeout(p,ms){ return Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]); }
  async function uniExactIn(path,amt,ms){ try{ const q=new ethers.Contract(UNI_QV2,QV2_ABI,provider); const [out]=await withTimeout(q.callStatic.quoteExactInput(path,amt),ms); return out; }catch(e){ log('uni quote: '+e.message); return null; } }
  async function uniBest(a,b,amt,ms){ let best=null; for(const f of FEES){ const p=packPath([a,f,b]); const out=await uniExactIn(p,amt,ms); if(out && (!best || out.gt(best))) best=out; } return best; }
  async function v2Out(router,path,amt,ms){ try{ const r=await withTimeout(new ethers.Contract(router,V2_ABI,provider).getAmountsOut(amt,path),ms); return r[r.length-1]; } catch(e){ log('v2 quote: '+e.message); return null; } }
  async function v2Best(router,paths,amt,ms){ let best=null; for(const p of paths){ const out=await v2Out(router,p,amt,ms); if(out && (!best || out.gt(best))) best=out; } return best; }
  const bestBig=(a,b)=> (a&&b) ? (a.gt(b)?a:b) : (a||b||null);

  let gasUSDC=0; const GAS_LIMIT=380000;
  async function fetchEthUsdFallback(){
    try{ const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd',{cache:'no-store'}); if(!r.ok) return null; const j=await r.json(); return Number(j?.ethereum?.usd)||null; }catch(_){ return null; }
  }
  async function refreshGas(){
    try{
      const gp=await provider.getGasPrice();
      let ethUsd=null;
      try{
        const out=await uniBest(WETH,USDC, ethers.utils.parseEther("1"), 2500);
        if(out) ethUsd = Number(ethers.utils.formatUnits(out,6));
      }catch(_){}
      if(ethUsd==null) ethUsd = await fetchEthUsdFallback();
      const gasETH = Number(ethers.utils.formatEther(gp.mul(GAS_LIMIT)));
      gasUSDC = (ethUsd? gasETH*ethUsd : 0.5);
      $('gasPill').textContent = `Gas ≈ ${fmt(gasUSDC,2)} USDC`;
      log('Gas OK: ~'+gasUSDC.toFixed(2)+' USDC');
    }catch(e){ gasUSDC=0.5; $('gasPill').textContent='Gas: fallback'; log('Gas failed: '+e.message); }
  }

  const SIZE_SEQ=[1000,2500,5000,10000]; const THIN=0.40;
  function dexes(){
    const mids=[WETH,USDT];
    return [
      { name:'Uniswap V3',
        buy: async(t,amt)=>bestBig(await uniBest(USDC,t,amt,2600), await uniBest(USDCe,t,amt,2600)),
        sell:async(t,amt)=>bestBig(await uniBest(t,USDC,amt,2600), await uniBest(t,USDCe,amt,2600))
      },
      { name:'SushiSwap',
        buy: async(t,amt)=>v2Best(SUSHI, [[USDC,t],[USDCe,t],[USDC,WETH,t],[USDC,USDT,t]], amt,2400),
        sell:async(t,amt)=>v2Best(SUSHI, [[t,USDC],[t,USDCe],[t,WETH,USDC],[t,USDT,USDC]], amt,2400)
      },
      { name:'Camelot',
        buy: async(t,amt)=>v2Best(CAMELOT, [[USDC,t],[USDCe,t],[USDC,WETH,t],[USDC,USDT,t]], amt,2400),
        sell:async(t,amt)=>v2Best(CAMELOT, [[t,USDC],[t,USDCe],[t,WETH,USDC],[t,USDT,USDC]], amt,2400)
      }
    ];
  }

  async function scanToken(sym, addr, maxSize, threshold){
    try{
      const tDec=await decimals(addr).catch(()=>18);
      let best=null, reason='no route';
      for(const size of SIZE_SEQ){
        if(size>maxSize) continue;
        const amtIn = ethers.utils.parseUnits(String(size),6);
        const dxs = dexes();
        const buys = await Promise.all(dxs.map(async d=>({d,out:await d.buy(addr, amtIn)})));
        const goodBuys = buys.filter(b=>b.out && b.out.gt(0));
        if(!goodBuys.length){ reason='BUY_FAIL @ '+size; continue; }
        for(const b of goodBuys){
          const sells = await Promise.all(dxs.filter(x=>x.name!==b.d.name).map(async x=>({name:x.name, back:await x.sell(addr, b.out)})));
          for(const s of sells){
            if(!s.back || !s.back.gt(0)) continue;
            const backNum = Number(ethers.utils.formatUnits(s.back,6));
            if(backNum < THIN*size){ reason='THIN @ '+size; continue; }
            const net = (backNum-size) - size*0.0009 - gasUSDC;
            if(!best || net>best.net){ best={ buyDex:b.d.name, sellDex:s.name, tokenOut:Number(ethers.utils.formatUnits(b.out,tDec)), back:backNum, size, net }; }
          }
        }
        if(best && best.net>=threshold) break;
      }
      if(!best) return { sym, error:reason };
      return { sym, buyDex:best.buyDex, sellDex:best.sellDex, tokenOut:best.tokenOut, usdcBack:best.back, spreadPct:((best.back-best.size)/best.size)*100, net:best.net, size:best.size };
    }catch(e){ return { sym, error:e.message }; }
  }

  function renderRow(r, threshold){
    const tb=$('rows'); const tr=document.createElement('tr');
    if(r.error){ tr.innerHTML=`<td></td><td>${r.sym}</td><td colspan="7" class="hint">Skipped: ${r.error}</td>`; tb.appendChild(tr); return; }
    tr.innerHTML=`
      <td><input type="checkbox" class="routeCheck" data-net="${r.net.toFixed(6)}" ${r.net>=threshold&&r.net>0?'checked':''}/></td>
      <td>${r.sym}</td><td>${r.buyDex}</td>
      <td class="right">${fmt(r.tokenOut,6)}</td><td>${r.sellDex}</td>
      <td class="right">${fmt(r.usdcBack,2)}</td>
      <td class="right">${r.spreadPct.toFixed(2)}%</td>
      <td class="right ${r.net>0?'ok':'bad'}">${r.net.toFixed(2)}</td>
      <td class="right">${fmt(r.size,0)}</td>`;
    tb.appendChild(tr);
    tr.querySelector('.routeCheck')?.addEventListener('change',sumSelected);
    sumSelected();
  }
  function sumSelected(){ let s=0; document.querySelectorAll('.routeCheck:checked').forEach(cb=>s+=Number(cb.dataset.net||0)); $('totalNet').textContent=(s>=0?'+':'')+'$'+fmt(s,2); }
  function renderRows(rows, thr){ $('rows').innerHTML=''; rows.forEach(r=>renderRow(r,thr)); }

  let timer=null, booted=false;

  async function scanAll(){
    const loan = parseFloat($('loan').value||'0');
    const thr  = parseFloat($('threshold').value||'0');
    if(!(loan>=500)) return alert('Enter a loan ≥ 500');

    $('rows').innerHTML=''; $('log').innerHTML='';
    setStatus('Connecting RPC…',true);
    if(!booted){ buildProvider(); booted=true; }
    await warmupProvider();

    setStatus('Fetching gas…',true);
    await refreshGas();

    setStatus('Quoting (majors)…',true);
    for(const [sym,addr] of Object.entries(TOKENS)){
      log('Scanning '+sym+' …');
      const r=await scanToken(sym,addr,loan,thr);
      renderRow(r,thr);
    }
    setStatus('Done.',false);
  }

  function bindUI(){
    $('scanBtn').addEventListener('click', async ()=>{
      try{
        if(timer){ clearInterval(timer); timer=null; }
        await scanAll();
        const secs=parseInt($('interval').value,10);
        if(secs>0){ timer=setInterval(scanAll, secs*1000); }
      }catch(e){ notice('Scan error: '+e.message); setStatus('Error.',false); }
    });
    $('stopBtn').addEventListener('click',()=>{ if(timer){ clearInterval(timer); timer=null; setStatus('Auto-rescan stopped.',false);} });
    $('selectProfitable').addEventListener('click',()=>{ const thr=parseFloat($('threshold').value||'0'); document.querySelectorAll('.routeCheck').forEach(cb=>cb.checked=(Number(cb.dataset.net||0)>=thr)); sumSelected(); });
    $('clearSelection').addEventListener('click',()=>{ document.querySelectorAll('.routeCheck').forEach(cb=>cb.checked=false); sumSelected(); });
    $('masterCheck').addEventListener('change',e=>{ document.querySelectorAll('.routeCheck').forEach(cb=>cb.checked=e.target.checked); sumSelected(); });
  }

  document.addEventListener('DOMContentLoaded', boot);
})();
</script>
</body>
</html>
