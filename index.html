<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Crypto Kings Test Bed v9.5.6 — Arbitrum (Dexscreener-only, stable)</title>
<style>
  :root{ --bg:#f6f7f9; --surface:#fff; --ink:#111827; --muted:#6b7280; --brand:#7c5cff; --brand2:#1d9bf0; --ring:rgba(124,92,255,.35); --border:#e5e7eb; --border-strong:#d1d5db; --ok:#10b981; --bad:#ef4444; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column;min-height:100vh;overflow-x:hidden}
  .container{max-width:1100px;width:100%;margin:0 auto;padding:0 16px}
  main{flex:1}
  .topbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border)}
  .topbar-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;flex-wrap:wrap}
  .brandbox{display:flex;align-items:center;gap:10px}
  .home-link{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
  .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(29,155,240,.18)}
  .logo span{font-size:14px;font-weight:900;color:white}
  .brand{font-weight:800;letter-spacing:.3px;white-space:nowrap}
  .chip{display:inline-block;padding:2px 8px;border:1px solid var(--border-strong);border-radius:999px;font-size:12px;background:#eef2ff;color:#3b3b6d}
  .nav-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .group{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:6px 8px}
  .group input{width:160px;padding:8px 10px;border:1px solid var(--border-strong);border-radius:8px}
  .group input:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring)}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;color:white;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 6px 16px rgba(124,92,255,.15);min-height:44px}
  .btn.ghost{background:#fff;color:#111;border:1px solid var(--border-strong);box-shadow:none}

  main .wrap{padding:16px 0 80px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:960px){ .row-4{grid-template-columns:repeat(4,1fr)} }
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[readonly]{background:#f9fafb;color:#4b5563}

  .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch}
  table{min-width:960px;width:100%}
  .table{border-collapse:collapse;margin-top:10px;background:#fff;border:1px solid var(--border)}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;text-align:left;white-space:nowrap}
  .table th{color:#374151;font-weight:700;background:#f9fafb}
  .table tr:nth-child(even){background:#fafafa}
  .right{text-align:right}
  .pos{background:#ecfdf5} .neg{background:#fef2f2} .meh{background:#f9fafb}

  @media (max-width:560px){
    table{min-width:0}
    .table thead{display:none}
    .table tr{display:grid;grid-template-columns:1fr;gap:6px;background:#fff;border:1px solid var(--border);border-radius:12px;margin:10px 0;padding:10px 10px}
    .table td{display:flex;justify-content:space-between;align-items:center;gap:10px;white-space:normal;border:0;padding:6px 0}
    .table td::before{content:attr(data-label);font-size:12px;color:#6b7280;margin-right:10px;flex:0 0 auto}
    .right{text-align:right}
  }

  .spinner{border:4px solid rgba(0,0,0,.08);border-top:4px solid var(--brand);border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

  footer{background:#fff;border-top:1px solid var(--border);margin-top:40px}
  .footer-inner{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:30px 0}
  footer h4{margin:0 0 8px;font-size:14px;color:#374151}
  footer ul{list-style:none;margin:0;padding:0;font-size:13px;color:#4b5563}
  footer li{margin:4px 0}
  footer a{color:inherit;text-decoration:none}
  footer a:hover{text-decoration:underline}
  .copyright{border-top:1px solid var(--border);padding:12px 0;font-size:12px;color:#6b7280;text-align:center}
  @media (max-width:960px){ .footer-inner{grid-template-columns:1fr 1fr} }
  @media (max-width:560px){ .footer-inner{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="topbar" style="padding-top: env(safe-area-inset-top)">
    <div class="container topbar-inner">
      <a class="home-link" href="/"><div class="logo"><span>CK</span></div><div class="brand">Crypto Kings</div></a>
      <span class="chip">v9.5.6</span>
      <div class="nav-right">
        <div class="group">
          <label for="loanUsd" class="help">Loan Size (USD)</label>
          <input id="loanUsd" type="number" min="100" max="500000" step="500" value="100000" inputmode="decimal">
        </div>
        <button id="scanBtn" class="btn">Scan</button>
      </div>
    </div>
  </div>

  <main class="container wrap">
    <div class="card">
      <div class="row row-4">
        <div><label>Network</label><input value="Arbitrum" readonly></div>
        <div><label>Gas (auto)</label><input id="gas-gwei" placeholder="Auto" readonly><div class="help" id="gas-note">—</div></div>
        <div><label>Gas Limit</label><input id="gas-limit" type="number" step="1000" value="380000"><div class="help">Two swaps + callback ≈ 350–450k</div></div>
        <div><label>Est. Gas Cost</label><input id="gas-cost" placeholder="—" readonly><div class="help" id="gas-cost-usd">—</div></div>
      </div>

      <div class="row" style="margin-top:6px"><div><span id="status" class="help">Ready.</span></div></div>

      <div class="table-wrap">
        <table class="table" id="oppsTable">
          <thead><tr><th>Token</th><th>Best Buy</th><th>Best Sell</th><th class="right">Raw Spread %</th><th class="right">Net (Aave+gas)</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer>
    <div class="container footer-inner">
      <div><div class="logo"><span>CK</span></div><p class="help">Stable scan using Dexscreener; realistic P/L with gas + flash fee.</p></div>
      <div><h4>Quick</h4><ul><li><a href="#" id="lkScan">Scan</a></li></ul></div>
      <div><h4>Networks</h4><ul><li>Arbitrum (active)</li><li>Others (soon)</li></ul></div>
      <div><h4>Contact</h4><ul><li><a href="mailto:info@example.com">info@example.com</a></li></ul></div>
    </div>
    <div class="copyright">© 2025 Crypto Kings. All rights reserved.</div>
  </footer>

<script>
/* Error banner (shows any JS errors at the top) */
(function(){const show=(m,s,l,c,e)=>{try{const b=document.createElement('div');b.style.margin='12px auto';b.style.maxWidth='1100px';b.innerHTML='<div style="background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d;padding:10px 12px;border-radius:10px"><strong>App notice</strong><pre style="white-space:pre-wrap;margin:6px 0 0;font-size:12px;color:#7f1d1d">'+(e&&e.stack?e.stack:[m,s,l+':'+c].filter(Boolean).join(' | '))+'</pre></div>';document.body.prepend(b);}catch(_){}return false;};window.onerror=show;window.onunhandledrejection=e=>show('Unhandled promise rejection','','','',e&&(e.reason||e));})();
</script>

<script>
/* v9.5.6 — Dexscreener-only stable scan for Arbitrum */
(function(){
  const $ = id => document.getElementById(id);
  const on = (el,ev,fn)=>{ if(el) el.addEventListener(ev,fn); };
  const fmtUSD = v => isFinite(v)?`$${Number(v).toLocaleString(undefined,{maximumFractionDigits:6})}`:"—";
  const pct = (a,b)=> ((b-a)/Math.max(1e-9,a))*100;
  const setStatus = msg => { const s=$("status"); if(s) s.textContent=msg; };

  const PLATFORM_FEE = 0.0009; // 0.09% Aave
  const CHAIN = "arbitrum";    // Dexscreener chain id
  const MIN_LIQ_USD = 25000;   // filter out tiny pools
  const MAX_ROWS = 200;        // limit to keep UI snappy

  /* Gas auto (public, browser-friendly) */
  async function cgETH(){
    try{ const r=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd",{cache:"no-store"});
      if(!r.ok) return null; const j=await r.json(); return j?.ethereum?.usd??null;
    }catch(_){ return null; }
  }
  async function ethFeeHistory(){
    // public Arbitrum gas endpoint via publicnode; soft-fails to fallback
    const url = "https://arbitrum-one.publicnode.com";
    try{
      const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({jsonrpc:"2.0",id:1,method:"eth_feeHistory",params:[5,"latest",[10,50,90]]})
      });
      if(!r.ok) return null;
      const j=await r.json(); const bh=j?.result;
      if(!bh) return null;
      const base=parseInt(bh.baseFeePerGas.at(-1),16)/1e9;
      const tip =parseInt((bh.reward.at(-1)||[])[1]||"0x0",16)/1e9;
      return base+tip;
    }catch(_){ return null; }
  }
  const gas = { gwei:0.20, usdPerNative:0, usd:0 };
  async function initGas(){
    const [ethUsd, g] = await Promise.all([cgETH(), ethFeeHistory()]);
    gas.usdPerNative = ethUsd || 0;
    gas.gwei = (typeof g === "number" && isFinite(g) && g>0) ? g : 0.20;
    $("gas-gwei").value = `${gas.gwei.toFixed(2)} Gwei`;
    $("gas-note").textContent = `ETH ≈ ${fmtUSD(gas.usdPerNative)} • ${g ? "auto" : "fallback"}`;
    calcGasUSD();
  }
  function calcGasUSD(){
    const gl=parseFloat($("gas-limit").value||"0");
    const native=(gas.gwei>0 && gl>0)?(gas.gwei*gl)/1e9:0;
    gas.usd = native * (gas.usdPerNative||0);
    $("gas-cost").value = native?`${native.toFixed(6)} ETH`:"";
    $("gas-cost-usd").textContent = native?`≈ ${fmtUSD(gas.usd)}`:"—";
  }
  on($("gas-limit"),"input",calcGasUSD);
  on($("loanUsd"),"change",calcGasUSD);

  function clampLoan(){
    let v=parseFloat($("loanUsd").value||"0"); if(!isFinite(v)) v=100000;
    v=Math.max(100,Math.min(500000,v)); v=Math.round(v/100)*100; $("loanUsd").value=String(v); return v;
  }

  /* Fetch a broad list of Arbitrum pairs from Dexscreener */
  async function fetchArbitrumPairs(){
    // Dexscreener supports /latest/dex/pairs/{chain}; many results, we’ll slice for performance
    const url = `https://api.dexscreener.com/latest/dex/pairs/${CHAIN}`;
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`Dexscreener HTTP ${r.status}`);
    const j = await r.json();
    return Array.isArray(j?.pairs) ? j.pairs : [];
  }

  /* Build best buy/sell per base token across DEXes */
  function computeBestRoutes(pairs){
    // Filter: decent liquidity & priced in USD
    const rows = pairs.filter(p=>{
      const liq = Number(p?.liquidity?.usd||0);
      const price = Number(p?.priceUsd||NaN);
      const base = p?.baseToken?.symbol;
      const quote = p?.quoteToken?.symbol;
      return isFinite(liq) && liq>=MIN_LIQ_USD && isFinite(price) && base && quote;
    });

    // Group by base token address (more robust than symbol)
    const byBase = new Map();
    for(const p of rows){
      const baseAddr = (p?.baseToken?.address||"").toLowerCase();
      if(!baseAddr) continue;
      const arr = byBase.get(baseAddr) || [];
      arr.push(p);
      byBase.set(baseAddr, arr);
    }

    const out = [];
    for(const [baseAddr, list] of byBase.entries()){
      // Find best buy (min price) and best sell (max price) across distinct dexId/pair
      let minP=Infinity, maxP=-Infinity, buy=null, sell=null;
      for(const px of list){
        const price = Number(px.priceUsd);
        if(!isFinite(price)) continue;
        if(price < minP){ minP=price; buy=px; }
        if(price > maxP){ maxP=price; sell=px; }
      }
      if(!buy || !sell || !isFinite(minP) || !isFinite(maxP) || maxP<=0 || minP<=0) continue;

      const tokenSym = buy.baseToken?.symbol || sell.baseToken?.symbol || baseAddr.slice(0,6);
      const tokenAddr = baseAddr;
      const buyDex = (buy.dexId||"").toUpperCase();
      const sellDex= (sell.dexId||"").toUpperCase();

      out.push({
        tokenAddr,
        tokenSym,
        buyDex, buyPair: `${buy.baseToken?.symbol}/${buy.quoteToken?.symbol}`, buyPrice: minP, buyUrl: buy.url,
        sellDex, sellPair:`${sell.baseToken?.symbol}/${sell.quoteToken?.symbol}`, sellPrice:maxP, sellUrl:sell.url
      });
    }
    return out;
  }

  function render(rows){
    const tb=$("rows"); tb.innerHTML="";
    rows.forEach(r=>{
      const rawPct = pct(r.buyPrice, r.sellPrice);
      const loanUSD = clampLoan();
      const aaveFee = loanUSD * PLATFORM_FEE;
      // if you buy token with USD at buyPrice and sell at sellPrice:
      // units = loanUSD / buyPrice; revenueUSD = units * sellPrice
      const revenue = (loanUSD / r.buyPrice) * r.sellPrice;
      const net = revenue - loanUSD - aaveFee - (window.__gasUSD||0);
      const tr=document.createElement("tr");
      tr.className = net>0 ? "pos" : (net>-3 ? "meh" : "neg");
      tr.innerHTML = `
        <td data-label="Token"><code title="${r.tokenAddr}">${r.tokenSym}</code></td>
        <td data-label="Best Buy">
          <a href="${r.buyUrl}" target="_blank" rel="noopener">${r.buyDex}</a>
          <div class="help">${r.buyPair} @ ${fmtUSD(r.buyPrice)}</div>
        </td>
        <td data-label="Best Sell">
          <a href="${r.sellUrl}" target="_blank" rel="noopener">${r.sellDex}</a>
          <div class="help">${r.sellPair} @ ${fmtUSD(r.sellPrice)}</div>
        </td>
        <td class="right" data-label="Raw Spread">${rawPct.toFixed(2)}%</td>
        <td class="right" data-label="Net">${fmtUSD(net)}</td>
      `;
      tb.appendChild(tr);
    });
  }

  async function scan(){
    const tb=$("rows"); tb.innerHTML="";
    setStatus("Fetching gas & pairs…");
    await initGas();
    window.__gasUSD = (function(){
      const gl=parseFloat($("gas-limit").value||"0");
      const native=(Number($("#gas-gwei")?.value||0)||gas.gwei)*gl/1e9;
      return native*(gas.usdPerNative||0);
    })();

    let pairs=[];
    try{
      const r = await fetchArbitrumPairs();
      if(!r.length){ setStatus("No pairs returned by Dexscreener."); return; }
      // Slice to top N by liquidity to keep it quick
      pairs = r.sort((a,b)=>(b?.liquidity?.usd||0)-(a?.liquidity?.usd||0)).slice(0,1200);
    }catch(e){
      setStatus("Dexscreener error: "+(e?.message||e));
      return;
    }

    setStatus(`Processing ${pairs.length} pairs…`);
    const collapsed = computeBestRoutes(pairs);
    if(!collapsed.length){ setStatus("No viable markets after filtering."); render([]); return; }

    // Compute and rank by net P/L
    const loanUSD = clampLoan();
    const scored = collapsed.map(r=>{
      const rawPct = pct(r.buyPrice, r.sellPrice);
      const revenue = (loanUSD / r.buyPrice) * r.sellPrice;
      const net = revenue - loanUSD - (loanUSD*PLATFORM_FEE) - (window.__gasUSD||0);
      return {...r, rawPct, net};
    }).sort((a,b)=>b.net-a.net)
      .slice(0, MAX_ROWS);

    render(scored);
    setStatus(`Done • ${scored.length} tokens (loan ${fmtUSD(loanUSD)})`);
  }

  on($("scanBtn"),"click",scan);
  on($("lkScan"),"click",(e)=>{e.preventDefault();scan();});

  // Initialize gas display
  (async()=>{ try{ await initGas(); }catch(_){} })();

})();
</script>
</body>
</html>
