<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Kings Test Bed v8.7.4 — Safe Boot + Seed Fallback</title>
<style>
  :root { --bg:#0b0d12; --ink:#e8eef9; --muted:#9aa3af; --brand:#7c5cff; --ring:rgba(124,92,255,.35); --ok:#34d399; --warn:#f59e0b; --bad:#ef4444; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .topbar{position:sticky;top:0;z-index:40;background:#0c0f1a;border-bottom:1px solid rgba(255,255,255,.08)}
  .topbar-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
  .logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#7c5cff,#1d9bf0);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(29,155,240,.25)}
  .logo span{font-size:14px;font-weight:900;color:white}
  .brand{font-weight:800;letter-spacing:.3px}
  .chip{display:inline-block;padding:4px 8px;border:1px solid rgba(255,255,255,.15);border-radius:999px;font-size:12px}
  .spacer{flex:1}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;color:white;background:linear-gradient(135deg,#7c5cff,#1d9bf0)}
  .btn.small{padding:7px 10px;border-radius:10px}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--ink)}
  .tabs{max-width:1200px;margin:12px auto 0;padding:0 16px}
  .tabbar{display:flex;gap:8px;flex-wrap:wrap}
  .tabbar button{appearance:none;background:#111422;border:1px solid rgba(255,255,255,.10);color:var(--ink);padding:10px 12px;border-radius:10px;cursor:pointer}
  .tabbar button.active{background:linear-gradient(135deg,#7c5cff,#1d9bf0);border-color:transparent}
  .tabpanes{margin-top:12px}
  .wrap{max-width:1200px;margin:0 auto;padding:0 16px 120px}
  .card{background:#111422;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:#0e1220;color:var(--ink);outline:none}
  input[readonly]{opacity:.85}
  input:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring)}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:960px){ .row-2{grid-template-columns:repeat(2,1fr)} .row-3{grid-template-columns:repeat(3,1fr)} .row-4{grid-template-columns:repeat(4,1fr)} }
  .help{font-size:12px;color:var(--muted)}
  .cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)} .hidden{display:none}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .kpi .box{border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px}
  .kpi .label{font-size:11px;color:var(--muted)} .kpi .value{font-weight:700}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;text-align:left}
  .table th{color:#b8c0cc;font-weight:600}
  .right{text-align:right}
  .tag{display:inline-block;padding:4px 8px;border:1px solid rgba(255,255,255,.15);border-radius:999px;font-size:12px}
  .spinner {border:4px solid rgba(255,255,255,.2);border-top:4px solid #7c5cff;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
  @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  /* error banner */
  .errbar{max-width:1200px;margin:12px auto 0;padding:0 16px}
  .errbar .box{background:#2a1520;border:1px solid rgba(255,100,120,.35);color:#ffd5db;padding:10px 12px;border-radius:10px}
  .errbar .box pre{white-space:pre-wrap;word-break:break-word;margin:6px 0 0;font-size:12px;color:#ffd5db}
</style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="logo"><span>CK</span></div>
      <div class="brand">Crypto Kings</div>
      <span class="chip">v8.7.4</span>
      <div class="spacer"></div>
      <button id="btnConnect" class="btn">Connect Wallet</button>
    </div>
  </div>

  <!-- Error banner (only shown on script error) -->
  <div id="errbar" class="errbar" style="display:none;">
    <div class="box">
      <strong>App error</strong>
      <pre id="errtxt"></pre>
    </div>
  </div>

  <!-- Static (non-JS) scaffold so the page never looks blank -->
  <div class="tabs">
    <div class="tabbar" id="tabbar">
      <button class="active" data-tab="ethereum">Ethereum</button>
      <button data-tab="arbitrum">Arbitrum</button>
      <button data-tab="polygon">Polygon</button>
      <button data-tab="bsc">BSC</button>
      <button data-tab="avalanche">Avalanche</button>
      <button data-tab="solana">Solana</button>
    </div>

    <div class="tabpanes" id="tabpanes">
      <!-- Ethereum -->
      <div id="pane-ethereum" class="wrap">
        <div class="card">
          <div class="row row-4">
            <div><label>Network</label><input value="Ethereum" readonly /></div>
            <div><label>Platform</label><input value="Aave v3" readonly /></div>
            <div><label>Gas Currency</label><input value="ETH" readonly /></div>
            <div><label>Scan</label><button class="btn small" data-scan="ethereum">Scan All Tokens (sampled)</button></div>
          </div>
          <div class="row row-3" style="margin-top:8px">
            <div><span id="status-ethereum" class="help">Ready.</span></div>
            <div class="help">Filters: Liquidity ≥ 20,000 • Vol(24h) ≥ 5,000</div>
            <div class="help">Sample size: 200, concurrency: 8</div>
          </div>
          <div class="kpi">
            <div class="box"><div class="label">Best Opportunity</div><div class="value" id="kpi-best-ethereum">—</div></div>
            <div class="box"><div class="label">Est. Spread</div><div class="value" id="kpi-spread-ethereum">—</div></div>
            <div class="box"><div class="label">Net (incl. gas)</div><div class="value" id="kpi-net-ethereum">—</div></div>
          </div>
          <div class="row row-4" style="margin-top:8px">
            <div><label>Loan Asset</label><input id="loan-asset-ethereum" value="USDC" /><div class="help" id="loan-amt-usd-ethereum-note">Loan capped at $10,000.</div></div>
            <div><label>Loan Amount (units)</label><input id="loan-amt-ethereum" type="number" min="0" step="any" placeholder="e.g., 1000" /><div class="help" id="loan-amt-usd-ethereum">≈ —</div></div>
            <div><label>Gas (auto)</label><input id="gas-gwei-ethereum" placeholder="Auto" readonly /><div class="help" id="gas-note-ethereum">—</div></div>
            <div><label>Gas Limit</label><input id="gas-limit-ethereum" type="number" min="0" step="1000" placeholder="190000" /><div class="help">Uni/Sushi ~150–200k • Curve ~340k • Balancer ~300k+</div></div>
          </div>
          <div class="row row-4" style="margin-top:8px">
            <div><label>Est. Gas Cost</label><input id="gas-cost-ethereum" placeholder="—" readonly /><div class="help" id="gas-cost-usd-ethereum">—</div></div>
            <div><label>Auto-Size Loan</label><button class="btn small" id="btn-autosize-ethereum" type="button">Break-Even +5%</button></div>
            <div><label>Auto-Execute</label><div class="row"><label class="help"><input type="checkbox" id="autoexec-ethereum"> Enable (sim)</label><label class="help">Min Net P/L (USD) <input id="minnet-ethereum" type="number" min="0" step="1" value="5"></label></div></div>
            <div><label>&nbsp;</label><div class="row"><label class="help">Max Trades <input id="maxtrades-ethereum" type="number" min="1" max="50" value="3"></label><label class="help">Cooldown (s) <input id="cooldown-ethereum" type="number" min="1" max="3600" value="10"></label></div></div>
          </div>
          <div class="help" id="route-ethereum" style="margin-top:6px;"></div>
          <div class="cta" style="margin-top:8px">
            <button class="btn" id="btn-proceed-ethereum" type="button">Proceed</button>
            <button class="btn ghost" id="btn-stop-ethereum" type="button">Stop Auto</button>
          </div>
          <div id="timeline-ethereum" class="hidden" style="margin-top:8px"><span class="help">Timeline…</span></div>
          <div id="tx-result-ethereum" class="hidden"></div>
          <table class="table" style="margin-top:10px">
            <thead><tr><th>Token</th><th>Buy (DEX @ $)</th><th>Sell (DEX @ $)</th><th class="right">Spread %</th></tr></thead>
            <tbody id="rows-ethereum"></tbody>
          </table>
        </div>
      </div>

      <!-- Arbitrum -->
      <div id="pane-arbitrum" class="wrap" style="display:none;">
        <div class="card">
          <div class="row row-4">
            <div><label>Network</label><input value="Arbitrum" readonly /></div>
            <div><label>Platform</label><input value="Aave v3" readonly /></div>
            <div><label>Gas Currency</label><input value="ETH" readonly /></div>
            <div><label>Scan</label><button class="btn small" data-scan="arbitrum">Scan All Tokens (sampled)</button></div>
          </div>
          <div class="row row-3" style="margin-top:8px">
            <div><span id="status-arbitrum" class="help">Ready.</span></div>
            <div class="help">Filters: Liquidity ≥ 20,000 • Vol(24h) ≥ 5,000</div>
            <div class="help">Sample size: 200, concurrency: 8</div>
          </div>
          <div class="kpi">
            <div class="box"><div class="label">Best Opportunity</div><div class="value" id="kpi-best-arbitrum">—</div></div>
            <div class="box"><div class="label">Est. Spread</div><div class="value" id="kpi-spread-arbitrum">—</div></div>
            <div class="box"><div class="label">Net (incl. gas)</div><div class="value" id="kpi-net-arbitrum">—</div></div>
          </div>
          <div class="row row-4" style="margin-top:8px">
            <div><label>Loan Asset</label><input id="loan-asset-arbitrum" value="USDC" /></div>
            <div><label>Loan Amount (units)</label><input id="loan-amt-arbitrum" type="number" /><div class="help" id="loan-amt-usd-arbitrum">≈ —</div></div>
            <div><label>Gas (auto)</label><input id="gas-gwei-arbitrum" placeholder="Auto" readonly /><div class="help" id="gas-note-arbitrum">—</div></div>
            <div><label>Gas Limit</label><input id="gas-limit-arbitrum" type="number" placeholder="170000" /></div>
          </div>
          <div class="row row-4" style="margin-top:8px">
            <div><label>Est. Gas Cost</label><input id="gas-cost-arbitrum" placeholder="—" readonly /><div class="help" id="gas-cost-usd-arbitrum">—</div></div>
            <div><label>Auto-Size Loan</label><button class="btn small" id="btn-autosize-arbitrum" type="button">Break-Even +5%</button></div>
            <div><label>Auto-Execute</label><div class="row"><label class="help"><input type="checkbox" id="autoexec-arbitrum"> Enable (sim)</label><label class="help">Min Net P/L (USD) <input id="minnet-arbitrum" type="number" value="5"></label></div></div>
            <div><label>&nbsp;</label><div class="row"><label class="help">Max Trades <input id="maxtrades-arbitrum" type="number" value="3"></label><label class="help">Cooldown (s) <input id="cooldown-arbitrum" type="number" value="10"></label></div></div>
          </div>
          <div class="help" id="route-arbitrum" style="margin-top:6px;"></div>
          <div class="cta" style="margin-top:8px">
            <button class="btn" id="btn-proceed-arbitrum" type="button">Proceed</button>
            <button class="btn ghost" id="btn-stop-arbitrum" type="button">Stop Auto</button>
          </div>
          <div id="timeline-arbitrum" class="hidden" style="margin-top:8px"><span class="help">Timeline…</span></div>
          <div id="tx-result-arbitrum" class="hidden"></div>
          <table class="table" style="margin-top:10px"><thead><tr><th>Token</th><th>Buy (DEX @ $)</th><th>Sell (DEX @ $)</th><th class="right">Spread %</th></tr></thead><tbody id="rows-arbitrum"></tbody></table>
        </div>
      </div>

      <!-- Polygon -->
      <div id="pane-polygon" class="wrap" style="display:none;"><div class="card">
        <div class="row row-4">
          <div><label>Network</label><input value="Polygon" readonly /></div>
          <div><label>Platform</label><input value="Aave v3" readonly /></div>
          <div><label>Gas Currency</label><input value="MATIC" readonly /></div>
          <div><label>Scan</label><button class="btn small" data-scan="polygon">Scan All Tokens (sampled)</button></div>
        </div>
        <div class="row row-3" style="margin-top:8px">
          <div><span id="status-polygon" class="help">Ready.</span></div>
          <div class="help">Filters: Liquidity ≥ 20,000 • Vol(24h) ≥ 5,000</div>
          <div class="help">Sample size: 200, concurrency: 8</div>
        </div>
        <div class="kpi">
          <div class="box"><div class="label">Best Opportunity</div><div class="value" id="kpi-best-polygon">—</div></div>
          <div class="box"><div class="label">Est. Spread</div><div class="value" id="kpi-spread-polygon">—</div></div>
          <div class="box"><div class="label">Net (incl. gas)</div><div class="value" id="kpi-net-polygon">—</div></div>
        </div>
        <div class="row row-4" style="margin-top:8px">
          <div><label>Loan Asset</label><input id="loan-asset-polygon" value="USDC" /></div>
          <div><label>Loan Amount (units)</label><input id="loan-amt-polygon" type="number" /><div class="help" id="loan-amt-usd-polygon">≈ —</div></div>
          <div><label>Gas (auto)</label><input id="gas-gwei-polygon" placeholder="Auto" readonly /><div class="help" id="gas-note-polygon">—</div></div>
          <div><label>Gas Limit</label><input id="gas-limit-polygon" type="number" placeholder="190000" /></div>
        </div>
        <div class="row row-4" style="margin-top:8px">
          <div><label>Est. Gas Cost</label><input id="gas-cost-polygon" placeholder="—" readonly /><div class="help" id="gas-cost-usd-polygon">—</div></div>
          <div><label>Auto-Size Loan</label><button class="btn small" id="btn-autosize-polygon" type="button">Break-Even +5%</button></div>
          <div><label>Auto-Execute</label><div class="row"><label class="help"><input type="checkbox" id="autoexec-polygon"> Enable (sim)</label><label class="help">Min Net P/L (USD) <input id="minnet-polygon" type="number" value="5"></label></div></div>
          <div><label>&nbsp;</label><div class="row"><label class="help">Max Trades <input id="maxtrades-polygon" type="number" value="3"></label><label class="help">Cooldown (s) <input id="cooldown-polygon" type="number" value="10"></label></div></div>
        </div>
        <div class="help" id="route-polygon" style="margin-top:6px;"></div>
        <div class="cta" style="margin-top:8px">
          <button class="btn" id="btn-proceed-polygon" type="button">Proceed</button>
          <button class="btn ghost" id="btn-stop-polygon" type="button">Stop Auto</button>
        </div>
        <div id="timeline-polygon" class="hidden" style="margin-top:8px"><span class="help">Timeline…</span></div>
        <div id="tx-result-polygon" class="hidden"></div>
        <table class="table" style="margin-top:10px"><thead><tr><th>Token</th><th>Buy (DEX @ $)</th><th>Sell (DEX @ $)</th><th class="right">Spread %</th></tr></thead><tbody id="rows-polygon"></tbody></table>
      </div></div>

      <!-- BSC -->
      <div id="pane-bsc" class="wrap" style="display:none;"><div class="card">
        <div class="row row-4">
          <div><label>Network</label><input value="BSC" readonly /></div>
          <div><label>Platform</label><input value="Aave v3" readonly /></div>
          <div><label>Gas Currency</label><input value="BNB" readonly /></div>
        <div><label>Scan</label><button class="btn small" data-scan="bsc">Scan All Tokens (sampled)</button></div>
        </div>
        <div class="row row-3" style="margin-top:8px">
          <div><span id="status-bsc" class="help">Ready.</span></div>
          <div class="help">Filters: Liquidity ≥ 20,000 • Vol(24h) ≥ 5,000</div>
          <div class="help">Sample size: 200, concurrency: 8</div>
        </div>
        <div class="kpi">
          <div class="box"><div class="label">Best Opportunity</div><div class="value" id="kpi-best-bsc">—</div></div>
          <div class="box"><div class="label">Est. Spread</div><div class="value" id="kpi-spread-bsc">—</div></div>
          <div class="box"><div class="label">Net (incl. gas)</div><div class="value" id="kpi-net-bsc">—</div></div>
        </div>
        <div class="row row-4" style="margin-top:8px">
          <div><label>Loan Asset</label><input id="loan-asset-bsc" value="USDC" /></div>
          <div><label>Loan Amount (units)</label><input id="loan-amt-bsc" type="number" /><div class="help" id="loan-amt-usd-bsc">≈ —</div></div>
          <div><label>Gas (auto)</label><input id="gas-gwei-bsc" placeholder="Auto" readonly /><div class="help" id="gas-note-bsc">—</div></div>
          <div><label>Gas Limit</label><input id="gas-limit-bsc" type="number" placeholder="170000" /></div>
        </div>
        <div class="row row-4" style="margin-top:8px">
          <div><label>Est. Gas Cost</label><input id="gas-cost-bsc" placeholder="—" readonly /><div class="help" id="gas-cost-usd-bsc">—</div></div>
          <div><label>Auto-Size Loan</label><button class="btn small" id="btn-autosize-bsc" type="button">Break-Even +5%</button></div>
          <div><label>Auto-Execute</label><div class="row"><label class="help"><input type="checkbox" id="autoexec-bsc"> Enable (sim)</label><label class="help">Min Net P/L (USD) <input id="minnet-bsc" type="number" value="5"></label></div></div>
          <div><label>&nbsp;</label><div class="row"><label class="help">Max Trades <input id="maxtrades-bsc" type="number" value="3"></label><label class="help">Cooldown (s) <input id="cooldown-bsc" type="number" value="10"></label></div></div>
        </div>
        <div class="help" id="route-bsc" style="margin-top:6px;"></div>
        <div class="cta" style="margin-top:8px">
          <button class="btn" id="btn-proceed-bsc" type="button">Proceed</button>
          <button class="btn ghost" id="btn-stop-bsc" type="button">Stop Auto</button>
        </div>
        <div id="timeline-bsc" class="hidden" style="margin-top:8px"><span class="help">Timeline…</span></div>
        <div id="tx-result-bsc" class="hidden"></div>
        <table class="table" style="margin-top:10px"><thead><tr><th>Token</th><th>Buy (DEX @ $)</th><th>Sell (DEX @ $)</th><th class="right">Spread %</th></tr></thead><tbody id="rows-bsc"></tbody></table>
      </div></div>

      <!-- Avalanche -->
      <div id="pane-avalanche" class="wrap" style="display:none;"><div class="card">
        <div class="row row-4">
          <div><label>Network</label><input value="Avalanche" readonly /></div>
          <div><label>Platform</label><input value="Aave v3" readonly /></div>
          <div><label>Gas Currency</label><input value="AVAX" readonly /></div>
          <div><label>Scan</label><button class="btn small" data-scan="avalanche">Scan All Tokens (sampled)</button></div>
        </div>
        <div class="row row-3" style="margin-top:8px">
          <div><span id="status-avalanche" class="help">Ready.</span></div>
          <div class="help">Filters: Liquidity ≥ 20,000 • Vol(24h) ≥ 5,000</div>
          <div class="help">Sample size: 200, concurrency: 8</div>
        </div>
        <div class="kpi">
          <div class="box"><div class="label">Best Opportunity</div><div class="value" id="kpi-best-avalanche">—</div></div>
          <div class="box"><div class="label">Est. Spread</div><div class="value" id="kpi-spread-avalanche">—</div></div>
          <div class="box"><div class="label">Net (incl. gas)</div><div class="value" id="kpi-net-avalanche">—</div></div>
        </div>
        <div class="row row-4" style="margin-top:8px">
          <div><label>Loan Asset</label><input id="loan-asset-avalanche" value="USDC" /></div>
          <div><label>Loan Amount (units)</label><input id="loan-amt-avalanche" type="number" /><div class="help" id="loan-amt-usd-avalanche">≈ —</div></div>
          <div><label>Gas (auto)</label><input id="gas-gwei-avalanche" placeholder="Auto" readonly /><div class="help" id="gas-note-avalanche">—</div></div>
          <div><label>Gas Limit</label><input id="gas-limit-avalanche" type="number" placeholder="185000" /></div>
        </div>
        <div class="row row-4" style="margin-top:8px">
          <div><label>Est. Gas Cost</label><input id="gas-cost-avalanche" placeholder="—" readonly /><div class="help" id="gas-cost-usd-avalanche">—</div></div>
          <div><label>Auto-Size Loan</label><button class="btn small" id="btn-autosize-avalanche" type="button">Break-Even +5%</button></div>
          <div><label>Auto-Execute</label><div class="row"><label class="help"><input type="checkbox" id="autoexec-avalanche"> Enable (sim)</label><label class="help">Min Net P/L (USD) <input id="minnet-avalanche" type="number" value="5"></label></div></div>
          <div><label>&nbsp;</label><div class="row"><label class="help">Max Trades <input id="maxtrades-avalanche" type="number" value="3"></label><label class="help">Cooldown (s) <input id="cooldown-avalanche" type="number" value="10"></label></div></div>
        </div>
        <div class="help" id="route-avalanche" style="margin-top:6px;"></div>
        <div class="cta" style="margin-top:8px">
          <button class="btn" id="btn-proceed-avalanche" type="button">Proceed</button>
          <button class="btn ghost" id="btn-stop-avalanche" type="button">Stop Auto</button>
        </div>
        <div id="timeline-avalanche" class="hidden" style="margin-top:8px"><span class="help">Timeline…</span></div>
        <div id="tx-result-avalanche" class="hidden"></div>
        <table class="table" style="margin-top:10px"><thead><tr><th>Token</th><th>Buy (DEX @ $)</th><th>Sell (DEX @ $)</th><th class="right">Spread %</th></tr></thead><tbody id="rows-avalanche"></tbody></table>
      </div></div>

      <!-- Solana (demo scan only) -->
      <div id="pane-solana" class="wrap" style="display:none;"><div class="card">
        <div class="row row-4">
          <div><label>Network</label><input value="Solana" readonly /></div>
          <div><label>Platform</label><input value="MarginFi/Solend (demo)" readonly /></div>
          <div><label>Gas Currency</label><input value="SOL" readonly /></div>
          <div><label>Scan</label><button class="btn small" data-scan="solana">Scan (demo)</button></div>
        </div>
        <div class="row row-3" style="margin-top:8px">
          <div><span id="status-solana" class="help">Ready.</span></div>
          <div class="help">Filters: Liquidity ≥ 20,000 • Vol(24h) ≥ 5,000</div>
          <div class="help">Sample size: 200, concurrency: 8</div>
        </div>
        <div class="kpi">
          <div class="box"><div class="label">Best Opportunity</div><div class="value" id="kpi-best-solana">—</div></div>
          <div class="box"><div class="label">Est. Spread</div><div class="value" id="kpi-spread-solana">—</div></div>
          <div class="box"><div class="label">Net (incl. gas)</div><div class="value" id="kpi-net-solana">—</div></div>
        </div>
        <div class="help" id="route-solana" style="margin-top:6px;"></div>
        <div class="cta" style="margin-top:8px">
          <button class="btn" id="btn-proceed-solana" type="button">Proceed</button>
        </div>
        <div id="timeline-solana" class="hidden" style="margin-top:8px"><span class="help">Timeline…</span></div>
        <div id="tx-result-solana" class="hidden"></div>
        <table class="table" style="margin-top:10px"><thead><tr><th>Token</th><th>Buy (DEX @ $)</th><th>Sell (DEX @ $)</th><th class="right">Spread %</th></tr></thead><tbody id="rows-solana"></tbody></table>
      </div></div>
    </div>
  </div>

<script>
(function(){
  // Tabs work even if enhancement fails
  const tabbar = document.getElementById('tabbar');
  const panes  = document.getElementById('tabpanes').children;
  tabbar.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-tab]');
    if(!b) return;
    [...tabbar.children].forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const id = 'pane-' + b.getAttribute('data-tab');
    for(const p of panes) p.style.display = (p.id === id) ? 'block' : 'none';
  });
})();
</script>

<script>
(function(){
  const errbar = document.getElementById('errbar');
  const errtxt = document.getElementById('errtxt');
  const showErr = (e)=>{ try{ errtxt.textContent = (e && e.stack) ? e.stack : String(e); errbar.style.display = 'block'; console.error('[CK SafeBoot]', e);}catch(_){} };

  try {
    /* ===== Constants ===== */
    const NETWORKS = ["ethereum","arbitrum","polygon","bsc","avalanche","solana"];
    const EVM = new Set(["ethereum","arbitrum","polygon","bsc","avalanche"]);
    const DS_BASE = "https://api.dexscreener.com";
    const LOAN_CAP_USD = 10000, PLATFORM_FEE = 0.0009;
    const MIN_LIQ_USD = 20000, MIN_VOL24H_USD = 5000;
    const MAX_ADDRESSES_PER_SCAN = 200, CONCURRENCY = 8, REQ_DELAY_MS = 120;
    const RPC={ ethereum:["https://rpc.ankr.com/eth","https://eth-mainnet.public.blastapi.io","https://cloudflare-eth.com"], arbitrum:["https://rpc.ankr.com/arbitrum","https://arbitrum.llamarpc.com","https://arb1.arbitrum.io/rpc"], polygon:["https://rpc.ankr.com/polygon","https://polygon-bor-rpc.publicnode.com","https://polygon-rpc.com"], bsc:["https://rpc.ankr.com/bsc","https://bsc.publicnode.com","https://bsc-dataseed1.binance.org"], avalanche:["https://rpc.ankr.com/avalanche","https://ava-mainnet.public.blastapi.io","https://api.avax.network/ext/bc/C/rpc"] };
    const GAS_NATIVE = { ethereum:"ETH", arbitrum:"ETH", polygon:"MATIC", bsc:"BNB", avalanche:"AVAX" };
    const CG_IDS={"ETH":"ethereum","WETH":"ethereum","MATIC":"matic-network","BNB":"binancecoin","AVAX":"avalanche-2"};
    const fmtUSD = v => isFinite(v) ? `$${Number(v).toLocaleString(undefined,{maximumFractionDigits:6})}` : "—";
    const toast = (msg)=>{ const t=document.createElement('div'); t.textContent=msg; t.style.cssText='position:fixed;right:12px;bottom:12px;background:#161a2b;border:1px solid rgba(255,255,255,.12);padding:8px 10px;border-radius:8px;z-index:50'; document.body.appendChild(t); setTimeout(()=>t.remove(),1500); };

    async function cgUSD(sym){ const id=CG_IDS[sym]; if(!id) return null; try{ const r=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`); if(!r.ok) return null; const j=await r.json(); return j?.[id]?.usd ?? null; }catch(_){return null;} }

    /* ===== Token lists + seeds ===== */
    const TOKENLISTS = {
      ethereum:["https://tokens.uniswap.org","https://unpkg.com/@uniswap/default-token-list@latest/build/uniswap-default.tokenlist.json"],
      arbitrum:["https://unpkg.com/@uniswap/default-token-list@latest/build/uniswap-default.tokenlist.json"],
      polygon:["https://unpkg.com/quickswap-default.token-list@latest/build/quickswap-default.tokenlist.json","https://unpkg.com/@uniswap/default-token-list@latest/build/uniswap-default.tokenlist.json"],
      bsc:["https://tokens.pancakeswap.finance/pancakeswap-extended.json"],
      avalanche:["https://raw.githubusercontent.com/traderjoe-xyz/joe-tokenlists/main/joe.tokenlist.json"],
      solana:[]
    };

    // High-liquidity seeds so scanning always works
    const SEED_ADDRESSES = {
      ethereum:[
        "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48","0xdac17f958d2ee523a2206206994597c13d831ec7",
        "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2","0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599",
        "0x6B175474E89094C44Da98b954EedeAC495271d0F","0x5A98FcBEA516Cf06857215779Fd812CA3beF1B32",
        "0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984","0x514910771AF9Ca656af840dff83E8264EcF986CA",
        "0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9"
      ],
      arbitrum:[
        "0xaf88d065e77c8cC2239327C5EDb3A432268e5831","0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",
        "0x82af49447d8a07e3bd95bd0d56f35241523fbab1","0x912CE59144191C1204E64559FE8253a0e49E6548",
        "0xda10009cbd5d07dd0cecc66161fc93d7c9000da1","0xfc5a1a6eb076a2c7ad06ed22c90d7e710e35ad0a"
      ],
      polygon:[
        "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174","0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
        "0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619","0x0000000000000000000000000000000000001010",
        "0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063"
      ],
      bsc:[
        "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d","0x55d398326f99059ff775485246999027b3197955",
        "0xbb4CdB9CBd36B01dCbAEBF2De08d9173bc095c","0x0e09fabb73bd3ade0a17ecc321fd13a19e81ce82"
      ],
      avalanche:[
        "0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E","0x9702230a8ea53601f5cd2dc00fdbc13d4df4a8c7",
        "0x49D5c2BdFfac6CE2BFdB6640F4F80f226bc10bAB","0x50b7545627a5162F82A992c33b87aDc75187B218",
        "0xd586E7F844cEa2F87f50152665BCbc2C279D8d70","0x6e84a6216eA6dACC71eE8E6b0a5B7322EEbC0fDd"
      ],
      solana:[]
    };

    async function getJSON(url){ const r=await fetch(url).catch(()=>null); if(!r||!r.ok) throw new Error(`GET ${url} -> ${r?r.status:'ERR'}`); return r.json(); }

    // Fallback-friendly loader
    async function loadTokenAddresses(network){
      const lists = TOKENLISTS[network] || [];
      const addrs = new Set();

      for (const url of lists) {
        try {
          const tl = await getJSON(url);
          const tokens = tl && tl.tokens ? tl.tokens : [];
          for (const t of tokens) {
            if (!t.address) continue;
            const ok =
              (network === "ethereum" && t.chainId == 1) ||
              (network === "arbitrum" && t.chainId == 42161) ||
              (network === "polygon" && t.chainId == 137) ||
              (network === "bsc" && t.chainId == 56) ||
              (network === "avalanche" && t.chainId == 43114);
            if (ok) addrs.add(t.address);
          }
        } catch (e) {
          console.warn("[tokens] tokenlist fetch failed:", url, e);
        }
      }

      let arr = Array.from(addrs);
      if (!arr.length) {
        console.warn("[tokens] falling back to seed addresses for", network);
        arr = SEED_ADDRESSES[network] ? [...SEED_ADDRESSES[network]] : [];
      }

      if (!arr.length && network === "ethereum") {
        arr = ["0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48","0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"]; // USDC, WETH
      }

      return arr.slice(0, Math.min(arr.length, MAX_ADDRESSES_PER_SCAN));
    }

    /* ===== Dexscreener & helpers ===== */
    async function dsByToken(addr){ const r=await fetch(`${DS_BASE}/latest/dex/tokens/${addr}`).catch(()=>null); if(!r||!r.ok) return null; return r.json(); }
    function consolidatePerDex(pairs){
      const preferred=["USDC","USDT"]; const byDex=new Map();
      for(const p of (pairs||[])){
        const dex=(p?.dexId||"").toLowerCase(); if(!dex) continue;
        const liq=p?.liquidity?.usd||0; if(liq<MIN_LIQ_USD) continue;
        const vol=p?.volume?.h24||0; if(vol<MIN_VOL24H_USD) continue;
        const quote=(p?.quoteToken?.symbol||"").toUpperCase();
        const rank=preferred.includes(quote)?preferred.indexOf(quote):99;
        const cur=byDex.get(dex);
        if(!cur||rank<cur.rank||(rank===cur.rank&&liq>cur.liq)) byDex.set(dex,{rec:p,liq,rank});
      }
      return [...byDex.values()].map(v=>v.rec);
    }
    function prettyDexId(p){
      const raw=(p?.dexId||"").toLowerCase();
      const map={uniswap:"Uniswap V3","uniswap-v3":"Uniswap V3",sushiswap:"SushiSwap",curve:"Curve",balancer:"Balancer",camelot:"Camelot",quickswap:"QuickSwap",pancakeswap:"PancakeSwap","pancakeswap-v3":"PancakeSwap",traderjoe:"Trader Joe",pangolin:"Pangolin",jupiter:"Jupiter",raydium:"Raydium",orca:"Orca"};
      for(const k in map){ if(raw.includes(k)) return map[k]; } return raw?raw[0].toUpperCase()+raw.slice(1):"DEX";
    }
    async function mapLimit(items, limit, fn){
      const out=new Array(items.length); let i=0;
      const worker=async()=>{ while(i<items.length){ const idx=i++; try{ out[idx]=await fn(items[idx],idx); if(REQ_DELAY_MS) await new Promise(r=>setTimeout(r,REQ_DELAY_MS)); }catch(_){ out[idx]=null; } } };
      const workers=Array.from({length:Math.min(limit,items.length)}, worker); await Promise.all(workers); return out;
    }

    /* ===== Per-network state ===== */
    const state={}; for(const net of NETWORKS){ state[net]={best:null,gasUsd:0,gasNativeUsd:null,gasGwei:null}; }

    function row(net, r){
      const tr=document.createElement('tr');
      const spread=((r.sellPrice-r.buyPrice)/r.buyPrice*100);
      tr.innerHTML=`<td>${r.base}</td><td>${r.buyDex} @ ${fmtUSD(r.buyPrice)}</td><td>${r.sellDex} @ ${fmtUSD(r.sellPrice)}</td><td class="right">${spread.toFixed(2)}%</td>`;
      tr.style.cursor="pointer";
      tr.addEventListener('click',()=>{
        state[net].best=r;
        document.getElementById(`route-${net}`).innerHTML=`<span class="tag">Selected</span> ${r.base}: Buy ${r.buyDex} @ ${fmtUSD(r.buyPrice)} → Sell ${r.sellDex} @ ${fmtUSD(r.sellPrice)} (${spread.toFixed(2)}%)`;
        updateKPIs(net);
      });
      return tr;
    }

    /* ===== Gas & loan & P/L ===== */
    async function gasSuggestGwei(net){
      const eps=RPC[net]; if(!eps) throw new Error("no rpc");
      const feeHist={jsonrpc:"2.0",id:1,method:"eth_feeHistory",params:[5,"latest",[10,50,90]]};
      for(const url of eps){
        try{
          const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(feeHist)}); if(!r.ok) continue;
          const j=await r.json(); const bh=j?.result; if(!bh?.baseFeePerGas||!bh?.reward) continue;
          const base=parseInt(bh.baseFeePerGas[bh.baseFeePerGas.length-1]||"0x0",16)/1e9;
          const rw=bh.reward[bh.reward.length-1]||[]; const tip=parseInt(rw[1]||"0x0",16)/1e9;
          return {gasPriceGwei:base+tip,baseGwei:base,tipGwei:tip};
        }catch(_){}
      }
      const gp={jsonrpc:"2.0",id:1,method:"eth_gasPrice",params:[]};
      for(const url of eps){
        try{ const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(gp)}); if(!r.ok) continue; const j=await r.json(); const wei=parseInt(j?.result||"0x0",16); return {gasPriceGwei:wei/1e9,baseGwei:wei/1e9,tipGwei:0}; }catch(_){}
      }
      throw new Error("rpc failed");
    }

    async function initGas(net){
      if(!EVM.has(net)) return;
      const g=await gasSuggestGwei(net).catch(()=>null);
      const nat=GAS_NATIVE[net]; const natUsd=await cgUSD(nat).catch(()=>null);
      state[net].gasGwei=g?.gasPriceGwei??null; state[net].gasNativeUsd=natUsd??null;
      const gEl=document.getElementById(`gas-gwei-${net}`), note=document.getElementById(`gas-note-${net}`);
      if(g){ gEl.value=`${g.gasPriceGwei.toFixed(1)} Gwei`; note.textContent=`base ${g.baseGwei.toFixed(1)} + tip ${g.tipGwei.toFixed(1)} • ${nat} ≈ ${fmtUSD(natUsd)}`; }
      else { gEl.value=""; note.textContent="auto gas failed (RPC/CORS). Enter gas limit to estimate cost."; }
    }
    function calcGasUsd(net){
      if(!EVM.has(net)) return 0;
      const g=state[net].gasGwei, gl=parseFloat(document.getElementById(`gas-limit-${net}`).value||"0"), usd=state[net].gasNativeUsd;
      if(!(g>0) || !(gl>0) || !(usd>0)) return 0;
      const native=(g*gl)/1e9; const cost=native*usd; state[net].gasUsd=cost;
      const sym=GAS_NATIVE[net]; document.getElementById(`gas-cost-${net}`).value=native.toFixed(6)+" "+sym;
      document.getElementById(`gas-cost-usd-${net}`).textContent=`≈ ${fmtUSD(cost)}`; return cost;
    }

    async function loanAssetUsdSym(net){
      const sym=(document.getElementById(`loan-asset-${net}`).value||"USDC").trim().toUpperCase();
      const map={USDC:"usd-coin",USDT:"tether",DAI:"dai",WETH:"ethereum",ETH:"ethereum",WBTC:"wrapped-bitcoin",MATIC:"matic-network",WBNB:"binancecoin",AVAX:"avalanche-2",ARB:"arbitrum",SOL:"solana"};
      const id=map[sym]; if(!id) return {sym,usd:null};
      try{const r=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`); const j=await r.json(); return {sym,usd:j?.[id]?.usd??null};}catch(_){return {sym,usd:null};}
    }

    function pickPL(net, principal){
      const b=state[net].best; if(!b) return null;
      const spread=(b.sellPrice-b.buyPrice)/b.buyPrice;
      const gross=principal*spread;
      const fee=principal*PLATFORM_FEE;
      const gas=state[net].gasUsd||0;
      return {spread,gross,flashFee:fee,gas,netNoGas:gross-fee,net:gross-fee-gas};
    }

    async function updateKPIs(net){
      const best=state[net].best;
      const kBest=document.getElementById(`kpi-best-${net}`), kSp=document.getElementById(`kpi-spread-${net}`), kNet=document.getElementById(`kpi-net-${net}`);
      if(!best){ kBest.textContent="—"; kSp.textContent="—"; kNet.textContent="—"; return; }
      const amt=parseFloat(document.getElementById(`loan-amt-${net}`).value||"0");
      const pa=await loanAssetUsdSym(net); const px=pa.usd||0; const principal = (amt>0 && px>0) ? amt*px : 1000;
      calcGasUsd(net);
      const r=pickPL(net, principal);
      kBest.textContent=`${best.base} | Buy ${best.buyDex} @ ${fmtUSD(best.buyPrice)} → Sell ${best.sellDex} @ ${fmtUSD(best.sellPrice)}`;
      kSp.textContent=`${(r.spread*100).toFixed(2)}%`;
      kNet.textContent=(amt>0 && px>0) ? `${fmtUSD(r.net)} (fee ${fmtUSD(r.flashFee)}, gas ~ ${fmtUSD(r.gas)})` : `set amount to see net (fee ${fmtUSD(r.flashFee)}, gas ~ ${fmtUSD(r.gas)})`;
      const usdNote=document.getElementById(`loan-amt-usd-${net}`); if(usdNote) usdNote.textContent = px>0 && amt>0 ? `≈ ${fmtUSD(px*amt)}` : "≈ —";
    }

    /* ===== Scan flow ===== */
    async function scanAll(net){
      const status=document.getElementById(`status-${net}`), body=document.getElementById(`rows-${net}`), route=document.getElementById(`route-${net}`);
      body.innerHTML=""; route.textContent=""; state[net].best=null; status.innerHTML=`<span class="spinner"></span> Loading token addresses… (will fallback if blocked)`;
      const addrs=await loadTokenAddresses(net).catch(()=>[]);
      if(!addrs.length){ status.textContent="Could not load token addresses."; return; }
      status.innerHTML=`<span class="spinner"></span> Scanning ${addrs.length} tokens…`;
      let done=0;
      const res=await mapLimit(addrs, CONCURRENCY, async (addr)=>{
        const j=await dsByToken(addr); done++; if(done%5===0) status.innerHTML=`<span class="spinner"></span> Scanned ${done}/${addrs.length}…`;
        if(!j||!j.pairs||!j.pairs.length) return null;
        const onNet=j.pairs.filter(p=>p.chainId===net); const perDex=consolidatePerDex(onNet); if(!perDex.length) return null;
        let min=Infinity,max=-Infinity,buy=null,sell=null;
        for(const p of perDex){ const pr=Number(p?.priceUsd); if(!isFinite(pr)) continue; if(pr<min){min=pr;buy=p;} if(pr>max){max=pr;sell=p;} }
        if(!buy||!sell||!isFinite(min)||!isFinite(max)) return null;
        const base=buy?.baseToken?.symbol || sell?.baseToken?.symbol || "";
        return { base, buyDex:prettyDexId(buy), buyPrice:min, sellDex:prettyDexId(sell), sellPrice:max, spread:(max-min)/min };
      });
      const usable=res.filter(Boolean).sort((a,b)=>b.spread-a.spread).slice(0,150);
      status.textContent=usable.length?`Found ${usable.length} opportunities`:"No viable routes (filters).";
      usable.forEach(r=>body.appendChild(row(net,r)));
      if(usable[0]){ state[net].best=usable[0]; route.innerHTML=`<span class="tag">Selected</span> ${usable[0].base}: Buy ${usable[0].buyDex} @ ${fmtUSD(usable[0].buyPrice)} → Sell ${usable[0].sellDex} @ ${fmtUSD(usable[0].sellPrice)} (${(usable[0].spread*100).toFixed(2)}%)`; updateKPIs(net); }
    }

    /* ===== Wire up ===== */
    document.querySelectorAll("[data-scan]").forEach(btn=>btn.addEventListener("click", ()=>scanAll(btn.dataset.scan)));
    for(const net of NETWORKS){
      if(EVM.has(net)) initGas(net);
      const gl=document.getElementById(`gas-limit-${net}`); if(gl) gl.addEventListener('input', ()=>{ calcGasUsd(net); updateKPIs(net); });
      const la=document.getElementById(`loan-amt-${net}`); if(la) la.addEventListener('input', ()=>updateKPIs(net));
      const auto=document.getElementById(`btn-autosize-${net}`); if(auto) auto.addEventListener('click', ()=>toast("Auto-size (full) is in the advanced build; kept minimal here."));
      const go=document.getElementById(`btn-proceed-${net}`); if(go) go.addEventListener('click', ()=>toast("Proceed (sim) — advanced timeline is in the full build."));
      const stop=document.getElementById(`btn-stop-${net}`); if(stop) stop.addEventListener('click', ()=>toast("Auto-exec stopped"));
    }
    document.getElementById("btnConnect").addEventListener("click", ()=>toast("Wallet connect coming soon"));
  } catch (e) { showErr(e); }
})();
</script>
</body>
</html>
