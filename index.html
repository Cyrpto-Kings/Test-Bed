<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Kings Test Bed v9.0.4 — Safe Boot</title>
<style>
  :root{
    --bg:#f3f4f6; --surface:#fff; --ink:#111827; --muted:#6b7280;
    --brand:#7c5cff; --brand2:#1d9bf0; --ring:rgba(124,92,255,.35);
    --border:#e5e7eb; --border-strong:#d1d5db; --chip:#eef2ff;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    --topbar:#fff; --topbar-border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:0 16px}
  .topbar{position:sticky;top:0;z-index:40;background:var(--topbar);border-bottom:1px solid var(--topbar-border)}
  .topbar-inner{display:flex;align-items:center;gap:12px;padding:12px 0}
  .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(29,155,240,.18)}
  .logo span{font-size:14px;font-weight:900;color:white}
  .brand{font-weight:800;letter-spacing:.3px}
  .chip{display:inline-block;padding:4px 8px;border:1px solid var(--border-strong);border-radius:999px;font-size:12px;background:var(--chip);color:#3b3b6d}
  .spacer{flex:1}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;color:white;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 6px 16px rgba(124,92,255,.15)}
  .wrap{padding:16px 0 96px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input{width:100%;padding:10px 12px;border:1px solid var(--border-strong);border-radius:10px;background:#fff;color:var(--ink);outline:none;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  input[readonly]{background:#f9fafb;color:#4b5563}
  input:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring)}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:960px){ .row-2{grid-template-columns:repeat(2,1fr)} .row-3{grid-template-columns:repeat(3,1fr)} .row-4{grid-template-columns:repeat(4,1fr)} }
  .help{font-size:12px;color:var(--muted)}
  .tag{display:inline-block;padding:4px 8px;border:1px solid var(--border-strong);border-radius:999px;font-size:12px;background:#f9fafb}
  .tabbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tabbar button{appearance:none;background:#fff;border:1px solid var(--border-strong);color:var(--ink);padding:10px 12px;border-radius:10px;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .tabbar button.active{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:transparent;color:white;box-shadow:0 6px 14px rgba(124,92,255,.18)}
  .table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border:1px solid var(--border)}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
  .table th{color:#374151;font-weight:700;background:#f9fafb}
  .table tr:nth-child(even){background:#fafafa}
  .right{text-align:right}
  .pos{background:#ecfdf5} .neg{background:#fef2f2} .meh{background:#f9fafb}
  .spinner{border:4px solid rgba(0,0,0,.08);border-top:4px solid var(--brand);border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .errbar{margin-top:12px}
  .errbar .box{background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d;padding:10px 12px;border-radius:10px}
  .errbar .box pre{white-space:pre-wrap;word-break:break-word;margin:6px 0 0;font-size:12px;color:#7f1d1d}
</style>
</head>
<body>
<div class="topbar">
  <div class="container topbar-inner">
    <div class="logo"><span>CK</span></div>
    <div class="brand">Crypto Kings</div>
    <span class="chip">v9.0.4</span>
    <div class="spacer"></div>
    <div class="help" style="display:flex;align-items:center;gap:6px">
      Loan Size (USD)
      <input id="loanUsd" type="number" min="100" step="100" value="1000" style="width:120px">
    </div>
    <button id="scanBtn" class="btn">Scan</button>
  </div>
</div>

<div class="container wrap">
  <div id="errbar" class="errbar" style="display:none;">
    <div class="box"><strong>App notice</strong><pre id="errtxt"></pre></div>
  </div>

  <div class="tabbar" id="tabbar">
    <button class="active" data-tab="arbitrum">Arbitrum</button>
    <button data-tab="ethereum">Ethereum</button>
    <button data-tab="polygon">Polygon</button>
    <button data-tab="bsc">BSC</button>
    <button data-tab="avalanche">Avalanche</button>
  </div>

  <div id="panes"></div>
</div>

<script>
/* Global error banner */
(function(){
  const show=(msg,src,line,col,err)=>{
    try{
      const bar=document.getElementById('errbar'); const txt=document.getElementById('errtxt');
      if(!bar||!txt) return false;
      txt.textContent=(err&&err.stack)?err.stack:[msg,src,line+':'+col].filter(Boolean).join(' | ');
      bar.style.display='block';
    }catch(_){}
    return false;
  };
  window.onerror=show;
  window.onunhandledrejection=e=>show('Unhandled promise rejection','','','',e&&(e.reason||e));
})();
</script>

<script>
/* ---------- UI scaffold ---------- */
const NETWORKS=["arbitrum","ethereum","polygon","bsc","avalanche"];
const EVM=new Set(NETWORKS);
const GAS_NATIVE={ ethereum:"ETH", arbitrum:"ETH", polygon:"MATIC", bsc:"BNB", avalanche:"AVAX" };

function paneHTML(nw){
  const pretty=nw[0].toUpperCase()+nw.slice(1);
  const defaultGL = nw==='arbitrum' ? '170000' : nw==='avalanche' ? '185000' : '190000';
  return `
    <div class="card" id="pane-${nw}" ${nw!=='arbitrum'?'style="display:none"':''}>
      <div class="row row-4">
        <div><label>Network</label><input value="${pretty}" readonly></div>
        <div><label>Gas (auto)</label><input id="gas-gwei-${nw}" placeholder="Auto" readonly><div class="help" id="gas-note-${nw}">—</div></div>
        <div><label>Gas Limit</label><input id="gas-limit-${nw}" type="number" step="1000" value="${defaultGL}"><div class="help">Uni/Sushi 150–200k • Curve 340k • Balancer 300k+</div></div>
        <div><label>Est. Gas Cost</label><input id="gas-cost-${nw}" placeholder="—" readonly><div class="help" id="gas-cost-usd-${nw}">—</div></div>
      </div>
      <div class="row row-3" style="margin-top:8px">
        <div><span id="status-${nw}" class="help">Ready.</span></div>
        <div class="help">Stable quotes only • DEX allow-list • Outlier filter ±15%</div>
        <div><label>Manual Scan</label><button class="btn" data-scan="${nw}">Scan ${pretty}</button></div>
      </div>
      <div class="help" id="route-${nw}" style="margin-top:6px;"></div>
      <table class="table" style="margin-top:10px">
        <thead><tr><th>Token</th><th>Buy (DEX @ $)</th><th>Sell (DEX @ $)</th><th class="right">Spread %</th><th class="right">Net @ loan</th></tr></thead>
        <tbody id="rows-${nw}"></tbody>
      </table>
    </div>`;
}

function buildUI(){
  const panes=document.getElementById('panes');
  panes.innerHTML = NETWORKS.map(nw=>paneHTML(nw)).join('');
  const tabbar=document.getElementById('tabbar');
  tabbar.addEventListener('click',e=>{
    const b=e.target.closest('button[data-tab]'); if(!b) return;
    [...tabbar.children].forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const id='pane-'+b.dataset.tab;
    NETWORKS.forEach(nw=>{ const el=document.getElementById('pane-'+nw); if(el) el.style.display=(el.id===id)?'block':'none'; });
  });
}
</script>

<script>
/* ---------- App logic (safe-boot) ---------- */
(function(){
  const DS_BASE="https://api.dexscreener.com";
  const PLATFORM_FEE=0.0009;
  const ALLOWED=["uniswap","uniswap-v3","sushiswap","camelot","balancer","traderjoe","pangolin","pancakeswap","pancakeswap-v3","quickswap"];

  const el=id=>document.getElementById(id);
  const fmtUSD=v=>isFinite(v)?`$${Number(v).toLocaleString(undefined,{maximumFractionDigits:6})}`:"—";

  const RPC={ ethereum:["https://rpc.ankr.com/eth","https://eth-mainnet.public.blastapi.io","https://cloudflare-eth.com"],
              arbitrum:["https://rpc.ankr.com/arbitrum","https://arbitrum.llamarpc.com","https://arb1.arbitrum.io/rpc"],
              polygon:["https://rpc.ankr.com/polygon","https://polygon-bor-rpc.publicnode.com","https://polygon-rpc.com"],
              bsc:["https://rpc.ankr.com/bsc","https://bsc.publicnode.com","https://bsc-dataseed1.binance.org"],
              avalanche:["https://rpc.ankr.com/avalanche","https://ava-mainnet.public.blastapi.io","https://api.avax.network/ext/bc/C/rpc"] };

  async function gasSuggestGwei(nw){
    const eps=RPC[nw]; if(!eps) return null;
    const feeHist={jsonrpc:"2.0",id:1,method:"eth_feeHistory",params:[5,"latest",[10,50,90]]};
    for(const url of eps){
      try{
        const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(feeHist)});
        if(!r.ok) continue;
        const j=await r.json(); const bh=j&&j.result;
        if(!bh?.baseFeePerGas||!bh?.reward) continue;
        const base=parseInt(bh.baseFeePerGas.at(-1),16)/1e9;
        const tip =parseInt((bh.reward.at(-1)||[])[1]||"0x0",16)/1e9;
        return {g:base+tip, base, tip};
      }catch(_){}
    }
    return null;
  }
  async function cgUSD(sym){
    const map={ETH:"ethereum",MATIC:"matic-network",BNB:"binancecoin",AVAX:"avalanche-2"};
    const id=map[sym]; if(!id) return null;
    try{ const r=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd`); if(!r.ok) return null; const j=await r.json(); return j?.[id]?.usd ?? null; }catch(_){ return null; }
  }

  const state={}; NETWORKS.forEach(nw=>state[nw]={gasGwei:null,gasUsd:0,gasNativeUsd:null});

  async function initGas(nw){
    if(!EVM.has(nw)) return;
    const g=await gasSuggestGwei(nw).catch(()=>null);
    const nat=GAS_NATIVE[nw]; const natUsd=await cgUSD(nat).catch(()=>null);
    state[nw].gasGwei=g?g.g:null; state[nw].gasNativeUsd=natUsd??null;
    const gEl=el(`gas-gwei-${nw}`), note=el(`gas-note-${nw}`);
    if(g){ gEl.value=`${g.g.toFixed(1)} Gwei`; note.textContent=`base ${g.base.toFixed(1)} + tip ${g.tip.toFixed(1)} • ${nat} ≈ ${fmtUSD(natUsd)}`; }
    else{ gEl.value=""; note.textContent="auto gas failed (RPC/CORS)."; }
    calcGasUsd(nw);
  }
  function calcGasUsd(nw){
    const g=state[nw].gasGwei, gl=parseFloat(el(`gas-limit-${nw}`).value||"0"), usd=state[nw].gasNativeUsd;
    const native=(g>0 && gl>0)?(g*gl)/1e9:0, cost=native*(usd||0);
    state[nw].gasUsd=cost;
    const sym=GAS_NATIVE[nw];
    el(`gas-cost-${nw}`).value=native?`${native.toFixed(6)} ${sym}`:"";
    el(`gas-cost-usd-${nw}`).textContent=native?`≈ ${fmtUSD(cost)}`:"—";
    return cost;
  }

  async function dsByToken(addr){ const r=await fetch(`${DS_BASE}/latest/dex/tokens/${addr}`).catch(()=>null); if(!r||!r.ok) return null; return r.json(); }

  const TOKENLISTS={
    ethereum:["https://tokens.uniswap.org","https://unpkg.com/@uniswap/default-token-list@latest/build/uniswap-default.tokenlist.json"],
    arbitrum:["https://unpkg.com/@uniswap/default-token-list@latest/build/uniswap-default.tokenlist.json"],
    polygon:["https://unpkg.com/quickswap-default.token-list@latest/build/quickswap-default.tokenlist.json","https://unpkg.com/@uniswap/default-token-list@latest/build/uniswap-default.tokenlist.json"],
    bsc:["https://tokens.pancakeswap.finance/pancakeswap-extended.json"],
    avalanche:["https://raw.githubusercontent.com/traderjoe-xyz/joe-tokenlists/main/joe.tokenlist.json"]
  };
  const SEED={
    ethereum:["0xa0b8...6eb48","0xdac1...1ec7","0xC02a...6Cc2","0x2260...C599","0x6B17...1d0F","0x1f98...F984"],
    arbitrum:["0xaf88...5831","0xfd08...9fb9","0x82af...bab1","0x912C...548","0xda10...0da1"],
    polygon:["0x2791...4174","0xc213...8f","0x7ceB...f619","0x0000...1010","0x8f3C...A063"],
    bsc:["0x8ac7...580d","0x55d3...7955","0xbb4C...95c"],
    avalanche:["0xB97E...8a6E","0x9702...a8c7","0x49D5...0bAB","0x50b7...B218","0xd586...d70"]
  };

  async function getJSON(url){ const r=await fetch(url).catch(()=>null); if(!r||!r.ok) throw new Error(`GET ${url} -> ${r?r.status:'ERR'}`); return r.json(); }
  async function loadTokenAddresses(nw){
    const addrs=new Set();
    (SEED[nw]||[]).forEach(mask=>addrs.add(mask)); // seed (masked in UI)
    for(const url of (TOKENLISTS[nw]||[])){
      try{
        const tl=await getJSON(url);
        for(const t of (tl?.tokens||[])){
          if(!t?.address) continue;
          const ok=(nw==="ethereum"&&t.chainId==1)||(nw==="arbitrum"&&t.chainId==42161)||(nw==="polygon"&&t.chainId==137)||(nw==="bsc"&&t.chainId==56)||(nw==="avalanche"&&t.chainId==43114);
          if(ok) addrs.add(t.address);
        }
      }catch(_){}
    }
    return [...addrs].slice(0,250);
  }

  function dropOutliersByMedian(pairs){
    const prices=pairs.map(p=>Number(p.priceUsd)).filter(x=>isFinite(x)&&x>0);
    if(prices.length<3) return pairs;
    prices.sort((a,b)=>a-b);
    const med=prices[Math.floor(prices.length/2)];
    const low=med*0.85, high=med*1.15;
    return pairs.filter(p=>{ const pr=Number(p.priceUsd); return isFinite(pr) && pr>=low && pr<=high; });
  }
  function consolidatePerDex(pairs){
    const usable=pairs.filter(p=>{
      const q=(p?.quoteToken?.symbol||"").toUpperCase();
      const dex=(p?.dexId||"").toLowerCase();
      const liq=p?.liquidity?.usd||0, vol=p?.volume?.h24||0;
      const allowed=ALLOWED.some(k=>dex.includes(k));
      return allowed && (q==="USDC"||q==="USDT") && liq>=75000 && vol>=15000;
    });
    const trimmed=dropOutliersByMedian(usable);
    const byDex=new Map();
    for(const p of trimmed){
      const key=(p?.dexId||"").toLowerCase();
      const liq=p?.liquidity?.usd||0;
      const cur=byDex.get(key);
      if(!cur || liq>(cur.liq||0)) byDex.set(key,{rec:p,liq});
    }
    return [...byDex.values()].map(v=>v.rec)
      .sort((a,b)=>(b?.liquidity?.usd||0)-(a?.liquidity?.usd||0));
  }
  function prettyDexId(p){
    const raw=(p?.dexId||"").toLowerCase();
    const map={uniswap:"Uniswap V3","uniswap-v3":"Uniswap V3",sushiswap:"SushiSwap",camelot:"Camelot",balancer:"Balancer",quickswap:"QuickSwap",pancakeswap:"PancakeSwap","pancakeswap-v3":"PancakeSwap",traderjoe:"Trader Joe",pangolin:"Pangolin"};
    for(const k in map){ if(raw.includes(k)) return map[k]; }
    return raw? raw.charAt(0).toUpperCase()+raw.slice(1) : "DEX";
  }

  function plForPrincipal(nw, r, principalUSD){
    const spread=(r.sellPrice-r.buyPrice)/r.buyPrice;
    const gross=principalUSD*spread;
    const fee=principalUSD*PLATFORM_FEE;
    const gas=state[nw].gasUsd||0;
    return {spread, net:gross-fee-gas};
  }
  function appendRow(nw, r){
    const tbody=el(`rows-${nw}`);
    const tr=document.createElement('tr');
    const principal=Math.max(100, parseFloat(el('loanUsd').value||"1000"));
    const pl=plForPrincipal(nw,r,principal);
    const spreadPct=(pl.spread*100).toFixed(2);
    tr.className = pl.net>0 ? "pos" : (pl.net>-3 ? "meh" : "neg");
    tr.innerHTML=`<td>${r.base}</td><td>${r.buyDex} @ ${fmtUSD(r.buyPrice)}</td><td>${r.sellDex} @ ${fmtUSD(r.sellPrice)}</td><td class="right">${spreadPct}%</td><td class="right">${fmtUSD(pl.net)}</td>`;
    tbody.appendChild(tr);
  }

  async function mapLimit(items,limit,fn){
    const out=new Array(items.length); let idx=0;
    async function worker(){
      while(idx<items.length){
        const i=idx++;
        try{ out[i]=await fn(items[i],i); await new Promise(r=>setTimeout(r,80)); }
        catch(_){ out[i]=null; }
      }
    }
    const workers=[]; const n=Math.min(limit,items.length||0);
    for(let k=0;k<n;k++) workers.push(worker());
    await Promise.all(workers);
    return out;
  }

  async function scan(nw){
    const status=el(`status-${nw}`), tbody=el(`rows-${nw}`), route=el(`route-${nw}`);
    if(!status||!tbody||!route) return;
    tbody.innerHTML=""; route.textContent="";
    status.innerHTML=`<span class="spinner"></span> Preparing…`;

    await initGas(nw);

    let addrs=[];
    try{ addrs=await loadTokenAddresses(nw); }catch(e){ /* still continue */ }
    if(!addrs.length){ status.textContent="Could not load token addresses (rate-limit?). Try again."; return; }
    status.innerHTML=`<span class="spinner"></span> Scanning ${addrs.length} tokens…`;

    const out=await mapLimit(addrs,10, async(addr)=>{
      const j=await dsByToken(addr);
      if(!j?.pairs?.length) return null;
      const onNet=j.pairs.filter(p=>p.chainId===nw);
      const rows=consolidatePerDex(onNet);
      if(rows.length<2) return null;
      let min=Infinity,max=-Infinity,buy=null,sell=null;
      for(const row of rows){
        const pr=Number(row.priceUsd); if(!isFinite(pr)||pr<=0) continue;
        if(pr<min){min=pr;buy=row;} if(pr>max){max=pr;sell=row;}
      }
      if(!buy||!sell||max<=min) return null;
      const base=(buy.baseToken?.symbol)||(sell.baseToken?.symbol)||"";
      return { base, buyDex:prettyDexId(buy), buyPrice:min, sellDex:prettyDexId(sell), sellPrice:max, spread:(max-min)/min };
    });

    const byToken=new Map();
    out.filter(Boolean).forEach(r=>{
      const cur=byToken.get(r.base);
      if(!cur || r.spread>cur.spread) byToken.set(r.base,r);
    });
    const usable=[...byToken.values()].sort((a,b)=>b.spread-a.spread).slice(0,150);

    status.textContent = usable.length? `Found ${usable.length} opportunities` : "No viable routes with current guards.";
    const bar=el('errbar'); if(bar) bar.style.display = usable.length? 'none':'block';
    usable.forEach(r=>appendRow(nw,r));
    if(usable[0]){
      route.innerHTML=`<span class="tag">Top candidate</span> ${usable[0].base}: Buy ${usable[0].buyDex} @ ${fmtUSD(usable[0].buyPrice)} → Sell ${usable[0].sellDex} @ ${fmtUSD(usable[0].sellPrice)} (${(usable[0].spread*100).toFixed(2)}%)`;
    }
  }

  // build UI and wire events
  buildUI();
  document.getElementById('scanBtn').addEventListener('click',()=>{
    const active=document.querySelector('#tabbar button.active')?.dataset.tab || 'arbitrum';
    scan(active);
  });
  document.getElementById('tabbar').addEventListener('click',e=>{
    const btn=e.target.closest('button[data-tab]'); if(btn) {/* no scan on switch */}
  });
  NETWORKS.forEach(nw=>{
    if(EVM.has(nw)){
      const gl=document.getElementById(`gas-limit-${nw}`);
      if(gl) gl.addEventListener('input',()=>calcGasUsd(nw));
      initGas(nw);
    }
  });

  // first scan
  scan('arbitrum');
})();
</script>
</body>
</html>
