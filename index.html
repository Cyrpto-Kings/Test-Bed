<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Kings TestBed</title>
  <meta name="description" content="TestBed form to simulate flash-loan arbitrage routing with live price checks and two‑leg quotes." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b0d12; --panel:#121623; --ink:#e8eef9; --muted:#98a2b3; --brand:#7c5cff; --accent:#1d9bf0; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --ring:rgba(124,92,255,.35);}    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:radial-gradient(1200px 600px at 100% -10%, rgba(124,92,255,.08), transparent),
    radial-gradient(900px 500px at -10% 110%, rgba(29,155,240,.08), transparent), var(--bg); color:var(--ink)}
    .wrap{max-width:1100px; margin:0 auto; padding:32px 20px 80px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:24px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:42px;height:42px; border-radius:12px; background:linear-gradient(135deg, var(--brand), var(--accent)); display:grid; place-items:center; box-shadow:0 10px 30px rgba(124,92,255,.35)}
    .logo span{font-weight:800; font-size:18px}
    h1{margin:0; font-size:clamp(20px, 2.6vw, 32px)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:8px}
    select, input[type="text"], input[type="email"], input[type="number"]{width:100%; padding:12px 14px; border:1px solid rgba(255,255,255,.15); background:#0f1320; color:var(--ink); border-radius:12px; outline:none; transition:border .2s, box-shadow .2s}
    select:focus, input:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring)}
    .row{display:grid; grid-template-columns:1fr; gap:16px}
    @media (min-width:760px){ .row-3{grid-template-columns:repeat(3, 1fr)} .row-2{grid-template-columns:repeat(2, 1fr)} .row-4{grid-template-columns:repeat(4, 1fr)} }
    .help{font-size:12px; color:var(--muted); margin-top:6px}
    .cta{display:flex; gap:12px; align-items:center; margin-top:18px; flex-wrap:wrap}
    button{appearance:none; border:none; background:linear-gradient(135deg, var(--brand), var(--accent)); color:#fff; padding:14px 18px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:0 10px 24px rgba(124,92,255,.35); transition:transform .08s ease}
    button:active{transform:translateY(1px)}
    .ghost{background:transparent; border:1px solid rgba(255,255,255,.18); color:var(--ink); box-shadow:none}
    .danger{background:linear-gradient(135deg, var(--danger), #b91c1c)}
    footer{margin-top:30px; color:var(--muted); font-size:12px}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(124,92,255,.15); color:#cfd7ff; font-size:12px; font-weight:600}
    .inline{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .out{white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0e1220; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08)}
    .hidden{display:none !important}
    .rs{display:flex; align-items:center; gap:8px}
    .switch{display:flex; align-items:center; gap:8px}
    .bar{height:10px; border-radius:999px; background:rgba(255,255,255,.12); overflow:hidden}
    .bar > span{display:block; height:100%}
    .good{background:linear-gradient(90deg, var(--ok), #16a34a)}
    .bad{background:linear-gradient(90deg, var(--danger), #ef4444)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>CK</span></div>
        <div>
          <h1>Crypto Kings TestBed</h1>
          <div class="inline">
            <span class="pill">Flash‑Loan Arbitrage Simulator</span>
            <small class="help">UI only. No on‑chain execution.</small>
          </div>
        </div>
      </div>
    </header>

    <form id="testbedForm" class="card" autocomplete="on">
      <!-- Global controls -->
      <div class="row row-3">
        <div>
          <label for="network">Network</label>
          <select id="network" name="network" required>
            <option value="" disabled selected>Select a network</option>
            <option value="ethereum">Ethereum</option>
            <option value="arbitrum">Arbitrum</option>
            <option value="polygon">Polygon</option>
            <option value="bsc">BSC</option>
            <option value="avalanche">Avalanche</option>
            <option value="solana">Solana</option>
          </select>
          <div class="help">Determines available platforms, DEXes and gas model.</div>
        </div>
        <div>
          <label for="token">Field 2 — Desired Token</label>
          <select id="token" name="token" required>
            <option value="" disabled selected>Select a token</option>
            <option>WETH</option>
            <option>WBTC</option>
            <option>USDC</option>
            <option>USDT</option>
            <option>DAI</option>
            <option>SOL</option>
            <option>WBNB</option>
            <option>MATIC</option>
            <option>ARB</option>
            <option>OP</option>
            <option>Other / Custom</option>
          </select>
        </div>
        <div>
          <label for="loanAmount">Field 0 — Loan Amount</label>
          <div class="rs">
            <input type="number" id="loanAmount" name="loanAmount" min="0" step="any" placeholder="e.g., 1000" required />
            <span id="loanTokenSymbol" class="help"></span>
          </div>
          <div class="help">Amount to borrow (denominated in base stablecoin for route quotes).</div>
        </div>
      </div>

      <!-- Token address / mint for price lookup -->
      <div class="row row-2">
        <div>
          <label for="tokenAddress">Token Contract / Mint Address</label>
          <input type="text" id="tokenAddress" placeholder="0x… (EVM) or mint (Solana)">
          <div class="help">Used to fetch live prices & route quotes. For EVM, contract address. For Solana, mint.</div>
        </div>
        <div>
          <label for="platform">Field 1 — Flash Loan Platform</label>
          <select id="platform" name="platform" required>
            <option value="" disabled selected>Select a platform</option>
          </select>
        </div>
      </div>

      <!-- DEX routing -->
      <div class="row row-2">
        <div>
          <label for="buyDex">Field 3 — Purchase From DEX</label>
          <select id="buyDex" name="buyDex" required></select>
        </div>
        <div>
          <label for="sellDex">Field 4 — Sell To DEX</label>
          <select id="sellDex" name="sellDex" required></select>
        </div>
      </div>

      <!-- Wallets & confirmations -->
      <div class="row row-2">
        <div>
          <label for="rewardWallet">Field 5 — Wallet Address for Reward</label>
          <input type="text" id="rewardWallet" name="rewardWallet" placeholder="0x… or Solana address" required/>
          <input type="text" id="rewardWalletConfirm" placeholder="Confirm reward wallet" />
          <div class="help">Where any positive PnL should be paid.</div>
        </div>
        <div>
          <label for="feeWallet">Field 6 — Wallet Address for Fees</label>
          <input type="text" id="feeWallet" name="feeWallet" placeholder="0x… or Solana address" required/>
          <input type="text" id="feeWalletConfirm" placeholder="Confirm fee wallet" />
          <div class="help">Wallet to deduct protocol or service fees.</div>
        </div>
      </div>

      <!-- Gas / Slippage / Limits (EVM only shows gas) -->
      <div class="row row-4">
        <div id="gasPriceWrap">
          <label for="gasPrice">Field 7 — Gas Price (Gwei)</label>
          <input type="number" id="gasPrice" name="gasPrice" min="0" step="0.1" placeholder="e.g., 20">
        </div>
        <div id="gasLimitWrap">
          <label for="gasLimit">Gas Limit (units)</label>
          <input type="number" id="gasLimit" name="gasLimit" min="0" step="1000" placeholder="e.g., 300000">
        </div>
        <div id="gasFeeWrap">
          <label for="gasFeeEth">Estimated Gas Fee (ETH)</label>
          <input type="text" id="gasFeeEth" name="gasFeeEth" placeholder="Auto‑calculated" readonly>
          <div class="help">(gasPrice × gasLimit) ÷ 1e9</div>
        </div>
        <div>
          <label for="maxGasEth">Max Gas Spend (ETH)</label>
          <input type="number" id="maxGasEth" name="maxGasEth" min="0" step="any" placeholder="e.g., 0.02">
        </div>
      </div>

      <div class="row row-3">
        <div>
          <label for="slippage">Slippage Tolerance (%)</label>
          <input type="number" id="slippage" name="slippage" min="0" step="0.1" placeholder="e.g., 0.5">
        </div>
        <div>
          <label for="minProfitToken">Min Profit Threshold (Token)</label>
          <input type="number" id="minProfitToken" name="minProfitToken" min="0" step="any" placeholder="e.g., 5">
        </div>
        <div>
          <label for="minProfitGBP">Min Profit Threshold (£)</label>
          <input type="number" id="minProfitGBP" name="minProfitGBP" min="0" step="any" placeholder="e.g., 25">
        </div>
      </div>

      <!-- Email + submission mode -->
      <div class="row row-3">
        <div>
          <label for="email">Notification Email</label>
          <input type="email" id="email" name="email" placeholder="you@example.com" required>
        </div>
        <div>
          <label for="submitMode">Submission Mode</label>
          <select id="submitMode">
            <option value="mailto" selected>Email (mailto)</option>
            <option value="json">Download JSON only</option>
          </select>
        </div>
        <div class="switch">
          <label for="agree">Terms & Disclaimer</label>
          <input type="checkbox" id="agree"> <span class="help">I understand this is a UI demo; no on‑chain execution.</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="notes">Route Notes (optional)</label>
          <input type="text" id="notes" name="notes" placeholder="Any custom parameters or remarks"/>
        </div>
      </div>

      <div class="cta">
        <button id="simulateBtn" type="button">Simulate</button>
        <button id="processBtn" type="submit">Process Trade</button>
        <button id="copyJsonBtn" class="ghost" type="button">Copy JSON</button>
        <button id="downloadJsonBtn" class="ghost" type="button">Download JSON</button>
        <button class="ghost danger" type="reset">Reset</button>
      </div>

      <div id="validation" class="help" style="margin-top:10px"></div>
    </form>

    <footer>
      <p><strong>Disclaimer:</strong> This TestBed is a front‑end demonstration that collects parameters only and composes an email via <code>mailto:</code>. It does not execute trades or interact with blockchains or smart contracts.</p>
      <p class="help">Tip: Replace the mailto flow with a backend endpoint (e.g., /api/submit) when you’re ready.</p>
    </footer>

    <div class="card" style="margin-top:16px">
      <div class="inline" style="margin-bottom:8px"><span class="pill">Preview Payload</span><small class="help">Updates as you type</small></div>
      <div id="preview" class="out">—</div>
      <div class="inline" style="margin-top:10px">
        <span class="help">Profit Gate:</span>
        <div class="bar" style="width:260px"><span id="profitBar" style="width:0%" class="bad"></span></div>
        <span id="profitLabel" class="help">No simulation yet</span>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="inline" style="margin-bottom:8px">
        <span class="pill">Live Price</span>
        <small class="help">Based on token address/mint & selected network</small>
      </div>
      <div id="priceOut" class="out">Set network + token + token address, then pick a DEX to fetch price…</div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="inline" style="margin-bottom:8px">
        <span class="pill">Two‑Leg Quote (Buy → Sell)</span>
        <small class="help">Estimates using public quote APIs (best available route on network)</small>
      </div>
      <div id="quoteOut" class="out">Provide loan amount, network, token address, and choose buy/sell DEX to estimate PnL…</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // --- Mappings ---
    const PLATFORMS = {
      ethereum: ["Aave v3", "Balancer", "Uniswap V3 (Uni Flash)", "DyDx (Perp Flash)", "Other / Custom"],
      arbitrum: ["Aave v3", "Radiant", "Balancer", "Other / Custom"],
      polygon: ["Aave v3", "Balancer", "Other / Custom"],
      bsc: ["PancakeSwap (flash via router)", "Other / Custom"],
      avalanche: ["Trader Joe (flash via router)", "Other / Custom"],
      solana: ["Solend", "MarginFi", "Other / Custom"],
    };

    const DEXES = {
      ethereum: ["Uniswap V3", "SushiSwap", "Curve", "Balancer", "1inch Aggregator", "Other / Custom"],
      arbitrum: ["Uniswap V3", "SushiSwap", "Camelot", "Balancer", "1inch Aggregator", "Other / Custom"],
      polygon: ["Uniswap V3", "SushiSwap", "Balancer", "1inch Aggregator", "QuickSwap", "Other / Custom"],
      bsc: ["PancakeSwap", "ApeSwap", "Other / Custom"],
      avalanche: ["Trader Joe", "Pangolin", "Other / Custom"],
      solana: ["Jupiter", "Raydium", "Orca", "Other / Custom"],
    };

    const EVM_NETWORKS = new Set(["ethereum", "arbitrum", "polygon", "bsc", "avalanche"]);

    // Reference stable (base) addresses (USDC) per network for quote legs
    const USDC = {
      ethereum: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
      arbitrum: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831', // USDC.e (native) Arbitrum
      polygon: '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',
      bsc: '0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d',
      avalanche: '0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E',
      solana: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    };

    const ZEROX_HOST = {
      ethereum: 'https://api.0x.org',
      polygon: 'https://polygon.api.0x.org',
      bsc: 'https://bsc.api.0x.org',
      arbitrum: 'https://arbitrum.api.0x.org',
      avalanche: 'https://avalanche.api.0x.org',
    };

    // --- Helpers ---
    function setOptions(select, items){
      select.innerHTML = '<option value="" disabled selected>Select…</option>' + items.map(x=>`<option>${x}</option>`).join("");
    }

    function formatPreview(){
      const data = collectData();
      const symbol = data.token || "Token";
      if($("loanTokenSymbol")) $("loanTokenSymbol").textContent = symbol;
      const lines = [
        `Network: ${data.network}`,
        `Platform: ${data.platform}`,
        `Token: ${data.token}`,
        `Loan Amount (base): ${data.loanAmount} ${EVM_NETWORKS.has(data.network)?'USDC':'USDC'}`,
        `Token Address: ${data.tokenAddress}`,
        `Buy On: ${data.buyDex}`,
        `Sell To: ${data.sellDex}`,
        `Reward Wallet: ${data.rewardWallet}`,
        `Fee Wallet: ${data.feeWallet}`,
        EVM_NETWORKS.has(data.network) ? `Gas Price (Gwei): ${data.gasPrice}` : `Gas Price: N/A (non‑EVM)`,
        EVM_NETWORKS.has(data.network) ? `Gas Limit: ${data.gasLimit}` : `Gas Limit: N/A (non‑EVM)`,
        EVM_NETWORKS.has(data.network) ? `Est. Gas Fee (ETH): ${data.gasFeeEth}` : `Est. Network Fee: —`,
        `Max Gas Spend (ETH): ${data.maxGasEth}`,
        `Slippage (%): ${data.slippage}`,
        `Min Profit (Token): ${data.minProfitToken}`,
        `Min Profit (£): ${data.minProfitGBP}`,
        `Email: ${data.email}`,
        `Notes: ${data.notes}`
      ];
      $("preview").textContent = lines.join("\n");
      try { localStorage.setItem('ck-testbed-cache', JSON.stringify(data)); } catch(e){}
    }

    function collectData(){
      return {
        network: $("network").value || "",
        token: $("token").value || "",
        platform: $("platform").value || "",
        loanAmount: $("loanAmount").value || "",
        tokenAddress: $("tokenAddress").value || "",
        buyDex: $("buyDex").value || "",
        sellDex: $("sellDex").value || "",
        rewardWallet: $("rewardWallet").value || "",
        rewardWalletConfirm: $("rewardWalletConfirm").value || "",
        feeWallet: $("feeWallet").value || "",
        feeWalletConfirm: $("feeWalletConfirm").value || "",
        gasPrice: $("gasPrice").value || "",
        gasLimit: $("gasLimit").value || "",
        gasFeeEth: $("gasFeeEth").value || "",
        maxGasEth: $("maxGasEth").value || "",
        slippage: $("slippage").value || "",
        minProfitToken: $("minProfitToken").value || "",
        minProfitGBP: $("minProfitGBP").value || "",
        email: $("email").value || "",
        submitMode: $("submitMode").value || "mailto",
        agree: $("agree").checked,
        notes: $("notes").value || "",
      };
    }

    // Gas fee calculator: (gwei * units) / 1e9 = ETH
    function calcGas(){
      const gp = parseFloat($("gasPrice").value);
      const gl = parseFloat($("gasLimit").value);
      if (!isNaN(gp) && !isNaN(gl)) {
        const eth = (gp * gl) / 1e9; // ETH
        $("gasFeeEth").value = eth.toFixed(6);
      } else {
        $("gasFeeEth").value = "";
      }
      formatPreview();
    }

    function looksLikeEVM(addr){ return /^0x[a-fA-F0-9]{40}$/.test(addr.trim()); }
    function looksLikeSol(addr){ return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(addr.trim()); }

    function validate(){
      const d = collectData();
      let msg = "";
      if(!d.network) msg += "• Select a network.\n";
      if(!d.platform) msg += "• Select a flash loan platform.\n";
      if(!d.token) msg += "• Select a token.\n";
      if(!d.loanAmount || Number(d.loanAmount)<=0) msg += "• Enter a valid loan amount.\n";
      if(!d.buyDex) msg += "• Select a buy DEX.\n";
      if(!d.sellDex) msg += "• Select a sell DEX.\n";
      if(d.rewardWallet !== d.rewardWalletConfirm) msg += "• Reward wallet confirmation doesn’t match.\n";
      if(d.feeWallet !== d.feeWalletConfirm) msg += "• Fee wallet confirmation doesn’t match.\n";
      if(d.rewardWallet && !(looksLikeEVM(d.rewardWallet) || looksLikeSol(d.rewardWallet))) msg += "• Reward wallet doesn’t look like a valid EVM or Solana address.\n";
      if(d.feeWallet && !(looksLikeEVM(d.feeWallet) || looksLikeSol(d.feeWallet))) msg += "• Fee wallet doesn’t look like a valid EVM or Solana address.\n";
      if(EVM_NETWORKS.has(d.network)){
        if(!d.gasPrice || !d.gasLimit) msg += "• Provide gas price and gas limit for EVM networks.\n";
        if(d.maxGasEth && d.gasFeeEth && Number(d.gasFeeEth) > Number(d.maxGasEth)) msg += "• Estimated gas exceeds your max gas spend.\n";
      }
      if(d.minProfitToken && Number(d.minProfitToken)<0) msg += "• Min profit (token) must be ≥ 0.\n";
      if(d.minProfitGBP && Number(d.minProfitGBP)<0) msg += "• Min profit (£) must be ≥ 0.\n";
      if(!d.email) msg += "• Provide a notification email.\n";
      if(!d.agree) msg += "• You must accept the Terms & Disclaimer.\n";
      $("validation").textContent = msg;
      return msg === "";
    }

    function refreshForNetwork(){
      const net = $("network").value;
      if(!net){ return; }
      setOptions($("platform"), PLATFORMS[net] || ["Other / Custom"]);
      const dexes = DEXES[net] || ["Other / Custom"];
      setOptions($("buyDex"), dexes);
      setOptions($("sellDex"), dexes);

      // Toggle gas fields for EVM vs Solana
      const showGas = EVM_NETWORKS.has(net);
      ["gasPriceWrap","gasLimitWrap","gasFeeWrap"].forEach(id=>{
        $(id).classList.toggle('hidden', !showGas);
      });

      formatPreview();
      maybeFetchPrice();
    }

    function simulate(){
      const d = collectData();
      let score = 0; // 0..100
      if(d.minProfitToken || d.minProfitGBP) score += 30; else score += 10;
      if(d.slippage && Number(d.slippage) <= 1) score += 30; else if(d.slippage) score += 15;
      if(EVM_NETWORKS.has(d.network)){
        if(d.maxGasEth && d.gasFeeEth && Number(d.maxGasEth) >= Number(d.gasFeeEth)) score += 30;
      } else { score += 30; }
      if(d.buyDex && d.sellDex && d.buyDex !== d.sellDex) score += 10;
      const pct = Math.max(5, Math.min(100, score));
      const bar = $("profitBar");
      bar.style.width = pct + "%";
      bar.className = pct >= 60 ? "good" : "bad";
      $("profitLabel").textContent = pct >= 60 ? "Pass (est.)" : "Fail (est.)";
    }

    function toJSONPayload(){
      const d = collectData();
      const subject = `CK TestBed | NET: ${d.network || 'N/A'} | TOKEN: ${d.token || 'N/A'}`;
      return { subject, timestamp: new Date().toISOString(), ...d };
    }

    function copyJSON(){
      const payload = JSON.stringify(toJSONPayload(), null, 2);
      navigator.clipboard.writeText(payload).then(()=>{
        $("validation").textContent = "JSON copied to clipboard.";
      }).catch(()=>{
        $("validation").textContent = "Couldn’t copy JSON (clipboard blocked).";
      })
    }

    function downloadJSON(){
      const payload = JSON.stringify(toJSONPayload(), null, 2);
      const blob = new Blob([payload], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'ck-testbed-request.json'; a.click();
      URL.revokeObjectURL(url);
    }

    // --- Live price fetching ---
    async function fetchWithTimeout(url, opts={}){
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), opts.timeout || 10000);
      try{
        const res = await fetch(url, {signal: controller.signal});
        clearTimeout(id);
        return res;
      } catch(e){ clearTimeout(id); throw e; }
    }

    async function priceFromDexscreener(address){
      const url = `https://api.dexscreener.com/latest/dex/tokens/${address}`;
      const r = await fetchWithTimeout(url);
      const j = await r.json();
      if(j && j.pairs && j.pairs.length){
        j.pairs.sort((a,b)=> (Number(b.liquidity?.usd||0)) - (Number(a.liquidity?.usd||0)) );
        const p = j.pairs[0];
        return { usd: Number(p.priceUsd||0), dex: p.dexId || p.url || 'dexscreener', source: 'Dexscreener' };
      }
      throw new Error('No pairs from Dexscreener');
    }

    async function priceFromJupiter(mint){
      const url = `https://price.jup.ag/v6/price?ids=${encodeURIComponent(mint)}`;
      const r = await fetchWithTimeout(url);
      const j = await r.json();
      const data = j.data && (j.data[mint] || j.data[Object.keys(j.data)[0]]);
      if(data && data.price){
        return { usd: Number(data.price), dex: 'Jupiter', source: 'Jupiter' };
      }
      throw new Error('No price from Jupiter');
    }

    async function priceFromCoinGecko(network, address){
      const platform = {
        ethereum: 'ethereum', arbitrum: 'arbitrum-one', polygon: 'polygon-pos', bsc: 'binance-smart-chain', avalanche: 'avalanche'
      }[network];
      if(!platform) throw new Error('Unsupported CG platform');
      const url = `https://api.coingecko.com/api/v3/simple/token_price/${platform}?contract_addresses=${address}&vs_currencies=usd`;
      const r = await fetchWithTimeout(url);
      const j = await r.json();
      const key = Object.keys(j)[0];
      if(key && j[key] && j[key].usd){
        return { usd: Number(j[key].usd), dex: 'CoinGecko', source: 'CoinGecko' };
      }
      throw new Error('No price from CoinGecko');
    }

    async function maybeFetchPrice(){
      const d = collectData();
      const out = $("priceOut");
      out.textContent = 'Fetching price…';
      if(!d.network || !d.tokenAddress){
        out.textContent = 'Set network and token address/mint to fetch price.';
        return;
      }
      try{
        let quote;
        if(d.network === 'solana'){
          quote = await priceFromJupiter(d.tokenAddress);
        } else if(looksLikeEVM(d.tokenAddress)){
          try { quote = await priceFromDexscreener(d.tokenAddress); }
          catch(e){ quote = await priceFromCoinGecko(d.network, d.tokenAddress); }
        } else {
          out.textContent = 'Token address format not recognised for this network.';
          return;
        }
        out.textContent = `Price: $${quote.usd.toFixed(6)} USD  • Source: ${quote.source}`;
      } catch(err){
        out.textContent = 'Could not fetch price. Check address/mint and try again.';
      }
    }

    // --- Two‑leg quote (Base→Token then Token→Base) ---
    async function twoLegQuote(){
      const d = collectData();
      const out = $("quoteOut");
      if(!d.network || !d.tokenAddress || !d.loanAmount){
        out.textContent = 'Need network, token address/mint, and loan amount.';
        return;
      }
      out.textContent = 'Quoting route…';
      try{
        const slippage = Math.max(0, Number(d.slippage || 0))/100; // decimal
        if(d.network === 'solana'){
          const baseMint = USDC.solana;
          const amountBase = Math.round(Number(d.loanAmount) * 1e6); // USDC 6 decimals
          // Leg 1: USDC -> TOKEN
          const leg1Url = `https://quote-api.jup.ag/v6/quote?inputMint=${baseMint}&outputMint=${d.tokenAddress}&amount=${amountBase}&slippageBps=${Math.round(slippage*10000)}`;
          const r1 = await fetchWithTimeout(leg1Url);
          const j1 = await r1.json();
          if(!j1 || !j1.outAmount) throw new Error('Jupiter leg-1 failed');
          const tokenOut = Number(j1.outAmount); // token in smallest units
          const tokenDecimals = j1.otherAmountThreshold ? undefined : undefined; // not reliably present
          // Leg 2: TOKEN -> USDC (sell back the amount received)
          const leg2Url = `https://quote-api.jup.ag/v6/quote?inputMint=${d.tokenAddress}&outputMint=${baseMint}&amount=${tokenOut}&slippageBps=${Math.round(slippage*10000)}`;
          const r2 = await fetchWithTimeout(leg2Url);
          const j2 = await r2.json();
          if(!j2 || !j2.outAmount) throw new Error('Jupiter leg-2 failed');
          const usdcBack = Number(j2.outAmount); // in 6 decimals
          const grossPnlUsdc = (usdcBack - amountBase) / 1e6;
          // Net after gas: Solana gas negligible here; keep as gross
          out.textContent = `SOLANA two‑leg estimate (USDC base):\nBuy on ${d.buyDex || 'best'} → Sell on ${d.sellDex || 'best'}\nStart: ${Number(d.loanAmount).toFixed(2)} USDC\nEnd: ${ (usdcBack/1e6).toFixed(2) } USDC\nGross PnL: ${grossPnlUsdc.toFixed(2)} USDC`;
        } else if (EVM_NETWORKS.has(d.network)){
          const host = ZEROX_HOST[d.network];
          const base = USDC[d.network];
          const amountBase = Math.round(Number(d.loanAmount) * 1e6); // USDC 6 decimals
          // Leg 1: USDC -> TOKEN
          const l1 = `${host}/swap/v1/price?sellToken=${base}&buyToken=${d.tokenAddress}&sellAmount=${amountBase}`;
          const r1 = await fetchWithTimeout(l1);
          const q1 = await r1.json();
          if(!q1 || !q1.buyAmount) throw new Error('0x leg-1 failed');
          const tokenOut = BigInt(q1.buyAmount);
          // Leg 2: TOKEN -> USDC
          const l2 = `${host}/swap/v1/price?sellToken=${d.tokenAddress}&buyToken=${base}&sellAmount=${tokenOut.toString()}`;
          const r2 = await fetchWithTimeout(l2);
          const q2 = await r2.json();
          if(!q2 || !q2.buyAmount) throw new Error('0x leg-2 failed');
          const usdcBack = Number(q2.buyAmount) / 1e6;
          const grossPnlUsdc = usdcBack - Number(d.loanAmount);
          // subtract user‑entered gas estimate converted to USD via priceOut (rough):
          let gasUsd = 0;
          try{
            if($("gasFeeEth").value){
              // naive ETH only; for non‑ETH EVM this is off
              const ethPrice = await (await fetchWithTimeout('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd')).json();
              const ethUsd = (ethPrice.ethereum && ethPrice.ethereum.usd) ? Number(ethPrice.ethereum.usd) : 0;
              gasUsd = Number($("gasFeeEth").value) * ethUsd;
            }
          } catch(e){}
          const netUsd = grossPnlUsdc - gasUsd;
          out.textContent = `EVM two‑leg estimate (USDC base via 0x):\nBuy on ${d.buyDex || 'best'} → Sell on ${d.sellDex || 'best'}\nStart: ${Number(d.loanAmount).toFixed(2)} USDC\nEnd: ${ usdcBack.toFixed(2) } USDC\nGross PnL: ${grossPnlUsdc.toFixed(2)} USDC\nEst. Gas (USD): ${gasUsd.toFixed(2)}\nNet PnL (USD): ${netUsd.toFixed(2)}`;
        } else {
          out.textContent = 'Network not supported for route quoting.';
        }
      } catch(err){
        $("quoteOut").textContent = 'Could not fetch quotes (API limits or invalid token). Try again.';
      }
    }

    // Event wiring
    ["loanAmount","platform","token","tokenAddress","buyDex","sellDex","rewardWallet","rewardWalletConfirm","feeWallet","feeWalletConfirm","gasPrice","gasLimit","maxGasEth","slippage","minProfitToken","minProfitGBP","email","notes","submitMode"].forEach(id=>{
      $(id).addEventListener("input", ()=>{ if(id==="gasPrice"||id==="gasLimit"){calcGas();} else {formatPreview();} });
      $(id).addEventListener("change", ()=>{ if(id==="buyDex"||id==="sellDex"||id==="tokenAddress"||id==="token"){ maybeFetchPrice(); twoLegQuote(); } if(id==="gasPrice"||id==="gasLimit"){calcGas();} else {formatPreview();}});
    });
    $("network").addEventListener('change', ()=>{ refreshForNetwork(); twoLegQuote(); });

    $("simulateBtn").addEventListener('click', ()=>{ if(validate()) { simulate(); twoLegQuote(); } });
    $("copyJsonBtn").addEventListener('click', copyJSON);
    $("downloadJsonBtn").addEventListener('click', downloadJSON);

    document.getElementById("testbedForm").addEventListener("submit", function(e){
      e.preventDefault();
      if(!validate()){ return; }
      const data = collectData();
      const subject = encodeURIComponent(`CK TestBed | NET: ${data.network} | TOKEN: ${data.token}`);
      const body = encodeURIComponent($("preview").textContent + "\n\nSent from Crypto Kings TestBed");

      if(data.submitMode === 'mailto'){
        const href = `mailto:${data.email}?subject=${subject}&body=${body}`;
        window.location.href = href;
      } else {
        downloadJSON();
      }
    });

    // initial render + restore cache if any
    try{
      const cached = localStorage.getItem('ck-testbed-cache');
      if(cached){
        const d = JSON.parse(cached);
        ["network","token","platform","loanAmount","tokenAddress","buyDex","sellDex","rewardWallet","rewardWalletConfirm","feeWallet","feeWalletConfirm","gasPrice","gasLimit","gasFeeEth","maxGasEth","slippage","minProfitToken","minProfitGBP","email","notes","submitMode"].forEach(id=>{ if(d[id]!==undefined && $(id)) $(id).value = d[id]; });
        refreshForNetwork();
        calcGas();
        maybeFetchPrice();
        twoLegQuote();
      } else {
        refreshForNetwork();
        formatPreview();
      }
    } catch(e){ formatPreview(); }
  </script>
</body>
</html>
