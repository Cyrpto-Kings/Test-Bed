<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crypto Kings • TestBed v9.9.28</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --ink:#0f172a; --sub:#475569;
    --muted:#94a3b8; --line:#eef0f4; --ok:#059669; --bad:#e11d48;
    --pill:#eef2ff; --brand1:#6d28d9; --brand2:#2563eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
  .ck-wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;gap:12px}
  .logo{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,#4f46e5,#22c55e);display:grid;place-items:center;color:#fff;font-weight:800}
  .badge{background:#f1f5f9;color:#0f172a;border:1px solid #e2e8f0;padding:4px 10px;border-radius:999px;font-size:12px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:14px 0}
  .pill{background:var(--pill);border:1px solid #e7e9ff;color:#334155;border-radius:999px;padding:6px 10px;font-size:12px}
  .btn{border:none;border-radius:12px;padding:10px 16px;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--brand1),var(--brand2));box-shadow:0 6px 18px rgba(37,99,235,.18);cursor:pointer}
  .btn.secondary{background:#e2e8f0;color:#0f172a;font-weight:600;box-shadow:none}
  .card{background:var(--card);border-radius:16px;padding:14px;border:1px solid var(--line)}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .input{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff;min-width:160px}
  .hint{color:var(--sub);font-size:12px}
  .results-card{overflow:hidden;border-radius:14px}
  .results-table{width:100%;border-collapse:collapse;table-layout:fixed}
  .results-table thead th{font-weight:700;color:#334155;background:#f6f7fb}
  .results-table th,.results-table td{padding:10px 12px;border-bottom:1px solid #eef0f4}
  .right{text-align:right}
  .mono{font-variant-numeric:tabular-nums}
  .row-ok{background:#f2fff7}
  .row-bad{background:#fff6f6}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
  .chips .pill.ghost{background:#fff;border-color:var(--line)}
  .sticky-head{position:sticky;top:0;z-index:5}

  /* Mobile layout */
  @media (max-width:720px){
    .results-table thead{display:none}
    .results-table tbody tr{
      display:grid;grid-template-columns:1fr 1fr;grid-row-gap:6px;padding:10px 12px;border-bottom:1px solid #eef0f4
    }
    .results-table tbody tr>td{border:0;padding:0}
    .cell{display:flex;justify-content:space-between;gap:8px}
    .lbl{color:#64748b;font-size:12px;margin-right:8px}
    .val{text-align:right}
    .select-td{grid-column:1/-1;order:-2;margin-bottom:4px}
    .token-td{grid-column:1/-1;font-weight:700;order:-1}
    .buy-td,.sell-td,.spread-td,.back-td,.pl-td{grid-column:auto}
    .btn{width:100%}
  }

  .log{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
       background:#0b1220;color:#a7f3d0;border-radius:12px;padding:10px;white-space:pre-wrap;border:1px solid #0f1b34}
  footer{color:#64748b;text-align:center;margin:20px 0}
</style>
</head>
<body>
  <div class="ck-wrap">
    <header>
      <div class="logo">CK</div>
      <div>
        <div style="font-weight:800">Crypto Kings</div>
        <div class="hint">TestBed v9.9.28 • Arbitrum</div>
      </div>
      <span class="badge" id="rpcBadge">RPC: custom</span>
      <span class="badge" id="tokensBadge">Tokens: —</span>
    </header>

    <div class="card">
      <div class="controls">
        <label class="hint">Loan Amount (USDC):</label>
        <input id="loanInput" class="input mono" type="number" step="100" min="100" value="10000" />
        <button id="scanBtn" class="btn">Scan</button>
        <button id="stopBtn" class="btn secondary">Stop</button>
      </div>
      <div class="chips">
        <span class="pill ghost" id="gasPill">Gas: —</span>
        <span class="pill ghost" id="ethPill">ETH: —</span>
        <span class="pill ghost" id="progressPill">—</span>
      </div>

      <div class="results-card card" style="padding:0;margin-top:10px">
        <div class="chips" style="padding:12px">
          <button id="selectAllProfitableBtn" class="btn secondary" style="color:#0f172a">Select all profitable</button>
          <button id="clearBtn" class="btn secondary">Clear</button>
          <span id="selectedTotalPill" class="pill">++$0</span>
          <button id="execPreviewBtn" class="btn" style="margin-left:auto">Execute Selected (Preview)</button>
        </div>

        <table class="results-table">
          <thead class="sticky-head">
            <tr>
              <th style="width:42px"></th>
              <th>Token</th>
              <th>Buy (DEX @ $)</th>
              <th>Sell (DEX @ $)</th>
              <th class="right">Spread %</th>
              <th class="right">USDC Back</th>
              <th class="right">Net P/L</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
            <!-- rows injected -->
          </tbody>
        </table>
      </div>

      <div style="margin-top:12px">
        <div id="log" class="log">Ready.\n</div>
      </div>

      <div class="hint" style="margin-top:10px">
        Net P/L = (loan ÷ buyPrice × sellPrice) − per-leg DEX fees (0.3%/leg) − slippage buffer (0.2%/leg) − flash (0.09%) − gas. Pools must be on Arbitrum.
      </div>
    </div>

    <footer>© 2025 Crypto Kings Limited — All rights reserved.</footer>
  </div>

<script>
/* ============================
   1) Expanded token universe
   ============================ */
const TOKENS = [
  "WETH","WBTC","USDC","USDCe","USDT","DAI","ARB","wstETH","FRAX","LUSD",
  "AAVE","UNI","CRV","BAL","SNX","COMP","MKR","CVX","LDO","RPL","FXS",
  "GMX","GNS","MAGIC","RDNT","PENDLE","JONES","GRAIL","DPX","PLS","SUSHI",
  "LINK","GRT","ENS","STG","LQTY","HOP","BOND","ALCX",
  "RAM","CAMELOT","TRADERJOE","SADDLE",
  "AURA","ANGLE","VELO","PERP","1INCH","BADGER","BNT","DODO","OP",
  "SPA","GNO","RDPX","UMAMI","TCR"
].filter((v,i,a)=>a.indexOf(v)===i);

document.querySelector("#tokensBadge").textContent = `Tokens: ${TOKENS.length}`;

/* Expose to an existing scanner (if you have one wired elsewhere) */
window.DEFAULT_TOKENS = TOKENS;
window.SCAN_TOKENS = TOKENS;

/* ============================
   2) Utilities
   ============================ */
const logEl = document.getElementById('log');
function log(line){ logEl.textContent += (line.endsWith('\n')? line : line+'\n'); logEl.scrollTop = logEl.scrollHeight; }
function toNum(s){ if(s==null) return NaN; const n = String(s).replace(/[,$+\s]/g,''); return Number(n); }
function fmtUSD(n){ return Number(n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}); }
function pill(id, text){ const el=document.getElementById(id); if(el) el.textContent=text; }

/* ============================
   3) Rendering & sorting
   ============================ */
const tbody = document.getElementById('resultsBody');

function renderRows(routes){
  // routes: [{token,buyDex,buyPrice,sellDex,sellPrice,usdcBack,netPL}]
  tbody.innerHTML = '';
  for(const r of routes){
    const tr = document.createElement('tr');
    tr.dataset.netpl = r.netPL;
    tr.className = (r.netPL>0)? 'row-ok':'row-bad';
    tr.innerHTML = `
      <td class="select-td"><input type="checkbox" class="row-cb"></td>
      <td class="token-td">${r.token}</td>
      <td class="buy-td"><span class="cell"><span class="lbl">Buy</span><span class="val">${r.buyDex} @ ${Number(r.buyPrice).toLocaleString(undefined,{maximumFractionDigits:5})}</span></span></td>
      <td class="sell-td"><span class="cell"><span class="lbl">Sell</span><span class="val">${r.sellDex} @ ${Number(r.sellPrice).toLocaleString(undefined,{maximumFractionDigits:5})}</span></span></td>
      <td class="spread-td right mono">${(r.spreadPct??((r.sellPrice-r.buyPrice)/r.buyPrice*100)).toFixed(2)}%</td>
      <td class="back-td right mono">${fmtUSD(r.usdcBack)}</td>
      <td class="pl-td right mono ${r.netPL>0?'ok':'bad'}">${(r.netPL>=0?'+':'-')+fmtUSD(Math.abs(r.netPL)).replace('$','')}</td>
    `;
    tbody.appendChild(tr);
  }
  sortRows();              // profit-first ordering
  wireCheckHandlers();     // keep selected total in sync
}

function sortRows(){
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.forEach(tr=>{
    const pl = Number(tr.dataset.netpl||-1e99);
    const cell = tr.querySelector('.pl-td');
    tr.classList.toggle('row-ok', pl>0);
    tr.classList.toggle('row-bad', pl<=0);
    if(cell){ cell.classList.toggle('ok', pl>0); cell.classList.toggle('bad', pl<=0); }
  });
  rows.sort((a,b)=>{
    const pa = Number(a.dataset.netpl||-1e99), pb = Number(b.dataset.netpl||-1e99);
    const ap = pa>0, bp = pb>0;
    if(ap!==bp) return bp-ap;
    return pb-pa;
  });
  rows.forEach(tr=>tbody.appendChild(tr));
  updateSelectedTotal();
}

function updateSelectedTotal(){
  const cbs = tbody.querySelectorAll('.row-cb:checked');
  let sum = 0;
  cbs.forEach(cb=>{
    const tr = cb.closest('tr');
    const v = Number(tr?.dataset?.netpl||0);
    if(isFinite(v)) sum += v;
  });
  const pillEl = document.getElementById('selectedTotalPill');
  if(pillEl){
    pillEl.textContent = (sum>=0? '++$':'−$') + Math.abs(sum).toLocaleString(undefined,{maximumFractionDigits:2});
  }
}

function wireCheckHandlers(){
  tbody.querySelectorAll('.row-cb').forEach(cb=>{
    cb.addEventListener('change', updateSelectedTotal);
  });
}

/* “Select all profitable” & Clear */
document.getElementById('selectAllProfitableBtn').addEventListener('click',()=>{
  tbody.querySelectorAll('tr').forEach(tr=>{
    const cb = tr.querySelector('.row-cb');
    if(cb) cb.checked = Number(tr.dataset.netpl||-1e99) > 0;
  });
  updateSelectedTotal();
});
document.getElementById('clearBtn').addEventListener('click',()=>{
  tbody.querySelectorAll('.row-cb').forEach(cb=>cb.checked=false);
  updateSelectedTotal();
});

/* ============================
   4) Scan wiring
   ============================ */
let scanning=false;
document.getElementById('scanBtn').addEventListener('click', async ()=>{
  if(scanning) return;
  scanning=true;
  tbody.innerHTML=''; updateSelectedTotal();
  const loan = Number(document.getElementById('loanInput').value||10000);
  pill('progressPill','Scanning…'); log(`[${new Date().toTimeString().slice(0,8)}] CLICK Scan; tokens=${TOKENS.length}; loan=${loan.toLocaleString()}`);
  try{
    /* ------------------------------------------
       TODO: call your real scanner here.
       It should return an array of:
       { token, buyDex, buyPrice, sellDex, sellPrice, usdcBack, netPL, spreadPct? }
       ------------------------------------------ */

    let routes = [];
    if (typeof window.fetchRoutes === 'function'){
      // If you already wired a live scanner elsewhere, we call it
      routes = await window.fetchRoutes({tokens:TOKENS, loan});
    }else{
      // Minimal fallback: empty (no mock data)
      routes = [];
    }

    // Render (and auto sort by profit)
    renderRows(routes);

    // Progress
    pill('progressPill', `Done. Found ${routes.length} route(s).`);
  }catch(err){
    console.error(err);
    log(`Error: ${err.message||err}`);
    pill('progressPill','Error.');
  }finally{
    scanning=false;
  }
});

document.getElementById('stopBtn').addEventListener('click',()=>{ scanning=false; pill('progressPill','Stopped.'); });

/* ============================
   5) Exec preview stub
   ============================ */
document.getElementById('execPreviewBtn').addEventListener('click', ()=>{
  const selected = Array.from(tbody.querySelectorAll('.row-cb:checked')).map(cb=>{
    const tr = cb.closest('tr');
    const tds = tr.querySelectorAll('td');
    return {
      token: tds[1].textContent.trim(),
      buy:   tds[2].innerText.replace(/\n/g,' ').trim(),
      sell:  tds[3].innerText.replace(/\n/g,' ').trim(),
      spread: tds[4].textContent.trim(),
      back:   tds[5].textContent.trim(),
      pl:     tds[6].textContent.trim()
    };
  });
  if(!selected.length){ alert('Select at least one profitable route first.'); return; }
  let msg = 'Preview — routes to execute:\n\n';
  selected.forEach((r,i)=>{ msg += `${i+1}. ${r.token}: ${r.buy} → ${r.sell} | back ${r.back} | P/L ${r.pl}\n`; });
  alert(msg);
});

/* ============================
   6) Optional: expose a helper to your live scanner
   ============================ */
window.renderRows = renderRows;   // you can call renderRows(routes) from your live code
window.ckLog      = log;          // and ckLog('line') to append to the UI log
</script>
</body>
</html>
