<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Crypto Kings v9.9.20 — Arbitrum Scanner (Reality Check)</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280;
    --brand1:#3b82f6; --brand2:#9333ea; --ok:#16a34a; --bad:#ef4444;
    --border:#e5e7eb; --shadow:0 2px 14px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{background:#111;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--brand1),var(--brand2));display:grid;place-items:center;font-weight:900}
  .title{display:flex;flex-direction:column}
  .title .v{font-size:12px;opacity:.85}
  nav{display:flex;gap:16px;align-items:center}
  nav a{color:#fff;text-decoration:none;font-weight:700;opacity:.9}
  nav a:hover{opacity:1}
  .hamb{display:none;cursor:pointer;width:36px;height:36px;border-radius:8px;border:1px solid #333;display:grid;place-items:center}
  .hamb span{display:block;width:18px;height:2px;background:#fff;position:relative}
  .hamb span:before,.hamb span:after{content:"";position:absolute;left:0;height:2px;width:18px;background:#fff}
  .hamb span:before{top:-6px}.hamb span:after{top:6px}
  @media (max-width:760px){
    nav{display:none;position:absolute;left:0;right:0;top:58px;background:#0d0f13;padding:10px 16px;flex-direction:column}
    nav.open{display:flex}
    .hamb{display:grid}
  }
  .wrap{max-width:1024px;margin:0 auto;padding:18px 12px 40px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:var(--shadow)}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="number"],input[readonly]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:#111;outline:none}
  input:focus{border-color:var(--brand1);box-shadow:0 0 0 3px rgba(59,130,246,.2)}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:760px){ .row-4{grid-template-columns:repeat(4,1fr)} }
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:800;color:white;background:linear-gradient(135deg,var(--brand1),var(--brand2));cursor:pointer}
  .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--border)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .pill{background:#eef2ff;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
  .muted{color:var(--muted)}
  .right{text-align:right}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px;text-align:left}
  th{color:#374151;background:#fafafa;position:sticky;top:0;z-index:1}
  .pos{color:var(--ok);font-weight:700}
  .neg{color:var(--bad);font-weight:700}
  .log{font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0f172a;color:#a7f3d0;border-radius:10px;padding:10px;max-height:300px;overflow:auto}
  footer{background:#111;color:#cbd5e1;padding:22px;margin-top:28px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:22px}
  footer b{color:#fff}
  .center{display:flex;justify-content:center;align-items:center}
  .spinner{border:4px solid rgba(0,0,0,.08);border-top:4px solid var(--brand1);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  details{margin-top:10px}
  summary{cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">CK</div>
    <div class="title">
      <div style="font-weight:900;">Crypto Kings</div>
      <div class="v">v9.9.20 — Arbitrum (Reality Check)</div>
    </div>
  </div>
  <div class="hamb" id="hamb"><span></span></div>
  <nav id="nav">
    <a href="#">Home</a>
    <a href="#">Who we are</a>
    <a href="#">What we do</a>
    <a href="#">Connect with us</a>
  </nav>
</header>

<div class="wrap">
  <!-- Controls -->
  <div class="card">
    <div class="row row-4">
      <div>
        <label for="loan">Loan Amount (USDC)</label>
        <input id="loan" type="number" min="1" step="1" value="10000"/>
      </div>
      <div>
        <label for="gasLimit">Gas Limit (2 swaps + callback)</label>
        <input id="gasLimit" type="number" step="1000" value="380000"/>
      </div>
      <div>
        <label for="modeNote">Profile</label>
        <input id="modeNote" value="liq≥1.5×loan (≥$20k) • fresh≤90m OR ≥5 txns/24h • spread cap 25%" readonly/>
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="kpi">
          <div id="rpcPill" class="pill">RPC: —</div>
          <div id="gasPill" class="pill">Gas: —</div>
          <div id="ethPill" class="pill">WETH: —</div>
          <div id="countPill" class="pill">Tokens: —</div>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <button id="scanBtn" class="btn">Scan</button>
      <button id="stopBtn" class="btn ghost" disabled>Stop</button>
      <div id="status" class="pill" style="align-self:center">Idle.</div>
    </div>
  </div>

  <!-- Results -->
  <div class="card" id="resultsCard">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-weight:800;margin-bottom:6px;">Results</div>
        <div class="muted" id="summary">—</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="selectProfBtn" class="btn ghost" title="Select all profitable rows">Select all profitable</button>
        <button id="clearSelBtn" class="btn ghost">Clear</button>
        <div class="pill" id="selTotalPill">Selected total: +$0</div>
        <button id="previewBtn" class="btn" title="Preview execution of selected">Execute Selected (Preview)</button>
      </div>
    </div>

    <div id="loading" class="center" style="height:52px;display:none;margin-top:8px">
      <div class="spinner"></div>
    </div>

    <div style="overflow:auto;margin-top:8px;">
      <table>
        <thead>
          <tr>
            <th><input id="selectAll" type="checkbox"/></th>
            <th>Token</th>
            <th>Buy DEX</th>
            <th class="right">Price</th>
            <th>Sell DEX</th>
            <th class="right">Price</th>
            <th class="right">Spread %</th>
            <th class="right">USDC Back</th>
            <th class="right">Net P/L</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <details>
      <summary>Per-DEX debug (last token processed)</summary>
      <div id="perDex" class="log"></div>
    </details>
  </div>

  <!-- Logs -->
  <div class="card">
    <div style="font-weight:800;margin-bottom:6px;">Details / Logs</div>
    <div id="log" class="log"></div>
  </div>

  <div class="muted" style="font-size:12px;margin:8px 2px;">
    Net P/L = (loan ÷ buyPrice × sellPrice) − 0.3%+0.2% per leg − flash (0.09%) − gas (gwei×limit/1e9×ETH$).
    Pools must be liquid (≥ 1.5× loan, min $20k), fresh (≤ 90m) <i>or</i> active (≥5 txns/24h), and raw spread ≤ 25%.
  </div>
</div>

<footer>
  <div><b>Crypto Kings</b><br/>© 2025 All Rights Reserved</div>
  <div><b>Explore</b><br/>Home<br/>About<br/>Services<br/>Contact</div>
  <div><b>Legal</b><br/>Privacy<br/>Terms<br/>Disclaimer</div>
  <div><b>Social</b><br/>Twitter<br/>Telegram<br/>Discord</div>
</footer>

<script>
/* ====== Mobile hamburger ====== */
document.getElementById('hamb').addEventListener('click',()=>{ document.getElementById('nav').classList.toggle('open'); });

/* ====== Profile (Reality Check) ====== */
const FLASH_FEE = 0.0009;        // 0.09% Aave v3
const DEX_FEE_PER_LEG = 0.003;   // 0.30% per swap
const SLIPPAGE_BUF = 0.002;      // 0.20% per leg buffer
const GAS_LIMIT_DEFAULT = 380000;
const LIQ_MULTIPLIER = 1.5;      // ≥ 1.5× loan
const LIQ_FLOOR_USD = 20000;     // at least $20k
const FRESH_MAX_MIN = 90;        // ≤ 90 minutes
const FRESH_ALT_MIN_TXNS = 5;    // OR ≥5 txns/24h
const SPREAD_CAP_PCT = 25;       // ≤ 25% raw spread
const MIN_NET_USD = 1;           // auto-select threshold

/* ====== Helpers ====== */
const $ = id => document.getElementById(id);
const logEl = $("log"), tbody = $("tbody"), perDexEl = $("perDex");
function log(m){ const t=new Date().toLocaleTimeString(); logEl.innerHTML+=`[${t}] ${m}<br>`; logEl.scrollTop=logEl.scrollHeight; }
function fmtUSD(n,dp=2){ if(!isFinite(n)) return "—"; return '$'+Number(n).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:dp}); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function isFresh(ts){ if(!ts) return false; const ageMin=(Date.now()-new Date(ts).getTime())/60000; return ageMin<=FRESH_MAX_MIN; }

/* ====== RPC & tokens ====== */
const RPCS = [
  "https://arb1.arbitrum.io/rpc",
  "https://arbitrum.llamarpc.com",
  "https://rpc.ankr.com/arbitrum",
  "https://arbitrum-one.publicnode.com"
];
const ALLOW_DEX = new Set(["uniswap","sushiswap","camelot","balancer","zyberswap","woofi","traderjoe"]);
const TOKENS = {
  WETH:"0x82af49447d8a07e3bd95bd0d56f35241523fbab1",
  USDC:"0xaf88d065e77c8cC2239327C5EDb3A432268e5831",
  USDT:"0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",
  DAI :"0xda10009cbd5d07dd0cecc61fc93d7c9000da1",
  ARB :"0x912CE59144191C1204E64559FE8253a0e49E6548",
  LINK:"0xf97f4df75117a78c1A5a0DBb814Af92458539FB4",
  GMX :"0xfc5A1A6EB076a2C7aD06eD22C90d7E710E35ad0a",
  AAVE:"0xba5DdD1f9d7F570dc94a51479a000E3BCE967196",
  WBTC:"0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f",
  RDNT:"0x3082CC23568eA640225c2467653dB90e9250AaA0",
  PENDLE:"0x0c880f6761F1af8d9Aa9C466984b80DAb9a8c9e8",
  FRAX:"0x17FC002b466eEc40DaE837Fc4bE5c67993ddBd6F",
  CRV :"0x11cdb42b0eb46d95f990bedd4695a6e3fa034978",
  BAL :"0x040d1EdC9569d4Bab2D15287Dc5A4F10F56a56B8",
  LDO :"0xFdb794692724153d1488CcdBE0C56c252596735F",
  UNI :"0xfa7f8980b0f1e64a2062791cc3b0871572f1f7f0",
  wstETH:"0x5979D7b546E38E414F7E9822514be443A4800529",
  SNX :"0xd1f5e3e226fcae7112c8d9a60082f4acb7cd9f75",
  COMP:"0xb9d7cb7d0a7f620f2de913c2c9b391d4bdf6eb9f",
  YFI :"0x82e90eb7034c1df7a3e14d6e50e55cdd0d9c9a6a",
  GRT :"0x23a941036ae778ac51ab04cea08ed6e2fe103614",
  STG :"0x6694340fc020c5e6b96567843da2df01b2ce1eb6",
  LQTY:"0x27f8d68b2c4bba6aefaf5f12576cd3d7b5f9e9bf",
  RPL :"0xB766039CC6DB368759C1E56B79AFda051DFE4Bbf",
  MKR :"0x2e0b2d5b7d38d0fdb59bd4cb4ce8b063a6baf5f4",
  ENS :"0x65559aa14915a70190438ef90104769e5e890a00",
  CVX :"0xb952a807345991bd529fded05009f5e80fe8fdd1",
  FXS :"0x5e8422345238f34275888049021821e8e08caa1f",
  SUSHI:"0x1b02da8cb0d097eb8d57a175b88c7d8b47997506",
  LUSD:"0x93b346b6bc2548da6a1e7d98e9a421719f1b2f2a",
  MAGIC:"0x539bdE0d7Dbd336b79148AA742883198BBF60342",
  BADGER:"0xe4e43864ea18d5e5211352a4b810383460ab7fcf",
  DODO:"0x69e8b9528cabda89fe846c67675b5d73d463a916",
  BNT :"0x4d5bd4bb54efc5b10f2beabf0c1b62de5a5d3a1a",
  OP  :"0x4200000000000000000000000000000000000042"
};

/* ====== Math (realistic) ====== */
function bestPerDex(pairs){
  const by=new Map();
  for(const p of pairs){
    const dex=(p?.dexId||"").toLowerCase();
    if(![...ALLOW_DEX].some(d=>dex.includes(d))) continue;
    const liq=Number(p?.liquidity?.usd||0);
    if(!isFinite(liq)||liq<=0) continue;
    const prev=by.get(dex);
    if(!prev || liq>(prev.liquidity?.usd||0)) by.set(dex,p);
  }
  return Array.from(by.values());
}
function cp_USDC_to_TOKEN(loanUSDC, priceUsd, liqUsd, perLegCost){
  if(!(loanUSDC>0&&priceUsd>0&&liqUsd>0)) return 0;
  const Ru=liqUsd/2, Rt=(liqUsd/2)/priceUsd;
  const usdcIn=loanUSDC*(1-perLegCost);
  return Rt*(usdcIn/(Ru+usdcIn));
}
function cp_TOKEN_to_USDC(tokenIn, priceUsd, liqUsd, perLegCost){
  if(!(tokenIn>0&&priceUsd>0&&liqUsd>0)) return 0;
  const Ru=liqUsd/2, Rt=(liqUsd/2)/priceUsd;
  const tIn=tokenIn*(1-perLegCost);
  return Ru*(tIn/(Rt+tIn));
}
function computePL({loanUSDC,buyPx,sellPx,buyLiq,sellLiq,ethUsd,gasGwei,gasLimit}){
  const perLeg=DEX_FEE_PER_LEG + SLIPPAGE_BUF;
  const tokens = cp_USDC_to_TOKEN(loanUSDC,buyPx,buyLiq,perLeg);
  const back   = cp_TOKEN_to_USDC(tokens,sellPx,sellLiq,perLeg);
  const rawPct = ((sellPx-buyPx)/buyPx)*100;
  if(rawPct>SPREAD_CAP_PCT) return {pnl:null, why:"capped"};
  const gasUsd = (gasGwei*gasLimit/1e9)*ethUsd;
  const flash  = loanUSDC*FLASH_FEE;
  const pnl    = back - loanUSDC - gasUsd - flash;
  return {usdcBack:back,pnl,rawPct,gasUsd,flashUsd:flash};
}

/* ====== Fetchers ====== */
async function fetchGas(){
  const payload={jsonrpc:"2.0",id:1,method:"eth_feeHistory",params:[5,"latest",[10,50,90]]};
  for(const url of RPCS){
    try{
      const r=await fetch(url,{method:"POST",headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok) continue;
      const j=await r.json(); const bh=j?.result; if(!bh?.baseFeePerGas) continue;
      const base=parseInt(bh.baseFeePerGas.at(-1),16)/1e9;
      const tip50=parseInt((bh.reward.at(-1)||[])[1]||"0x0",16)/1e9;
      return {host:new URL(url).host,gwei:base+tip50};
    }catch(_){}
  }
  for(const url of RPCS){
    try{
      const r=await fetch(url,{method:"POST",headers:{'content-type':'application/json'},body:JSON.stringify({jsonrpc:"2.0",id:2,method:"eth_gasPrice",params:[]})});
      const j=await r.json(); const wei=parseInt(j?.result||"0x0",16); if(wei>0) return {host:new URL(url).host,gwei:wei/1e9};
    }catch(_){}
  }
  return null;
}
async function fetchETHUSD(){
  try{
    const r=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd",{cache:"no-store"});
    const j=await r.json(); const p=j?.ethereum?.usd; if(typeof p==="number") return p;
  }catch(_){}
  return null;
}
async function fetchPairs(addr){
  const url=`https://api.dexscreener.com/latest/dex/tokens/${addr}`;
  const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error("Dexscreener "+r.status);
  const j=await r.json(); return (j?.pairs||[]).filter(p=>p.chainId==="arbitrum");
}

/* ====== Scan ====== */
let abort=false; let renderedRows=[]; const state={ethUsd:3500,gasGwei:0.05};
$("countPill").textContent="Tokens: "+Object.keys(TOKENS).length;

async function scan(){
  abort=false; renderedRows=[]; updateSelectionTotal();
  $("loading").style.display="flex"; tbody.innerHTML=""; $("summary").textContent="—"; logEl.innerHTML=""; perDexEl.innerHTML="";
  $("status").textContent="Fetching gas & ETH…";

  // defaults
  $("ethPill").textContent="WETH: "+fmtUSD(state.ethUsd);
  $("gasPill").textContent=`Gas: ${state.gasGwei.toFixed(2)} gwei`;

  // live
  try{ const g=await fetchGas(); if(g){ state.gasGwei=g.gwei; $("gasPill").textContent=`Gas: ${g.gwei.toFixed(2)} gwei`; $("rpcPill").textContent="RPC: "+g.host; } }catch(_){}
  try{ const e=await fetchETHUSD(); if(e){ state.ethUsd=e; $("ethPill").textContent="WETH: "+fmtUSD(e); } }catch(_){}

  const loanUSDC = Number($("loan").value)||10000;
  const gasLimit = Number($("gasLimit").value)||GAS_LIMIT_DEFAULT;
  const requiredLiq = Math.max(LIQ_FLOOR_USD, LIQ_MULTIPLIER*loanUSDC);

  $("status").textContent="Scanning tokens…";
  const out=[]; const entries=Object.entries(TOKENS); let done=0;

  for(const [sym,addr] of entries){
    if(abort) break;
    try{
      const all=await fetchPairs(addr);
      if(!all.length){ log(`${sym}: no pools on Arbitrum`); progress(++done,entries.length,loanUSDC); await sleep(40); continue; }

      // loosened freshness: either updated ≤ 90m OR >= 5 txns in 24h
      const fresh = all.filter(p=>{
        const liq = Number(p?.liquidity?.usd||0);
        const updated = p?.updatedAt || p?.info?.lastUpdatedAt || p?.pairCreatedAt;
        const t24 = (p?.txns?.h24?.buys||0) + (p?.txns?.h24?.sells||0);
        const okFresh = isFresh(updated) || t24 >= FRESH_ALT_MIN_TXNS;
        return liq >= requiredLiq && okFresh;
      });
      if(!fresh.length){ log(`${sym}: thin or stale (liq<${LIQ_MULTIPLIER}×loan/${LIQ_FLOOR_USD} floor or not fresh/active)`); progress(++done,entries.length,loanUSDC); await sleep(35); continue; }

      const perDex = bestPerDex(fresh);
      if(!perDex.length){ log(`${sym}: no allowed DEX after filter`); progress(++done,entries.length,loanUSDC); await sleep(30); continue; }

      // debug dump per-DEX prices for last token processed (overwrites each token; expand after a run to see final one)
      perDexEl.innerHTML = perDex.map(p=>`${sym} :: ${(p.dexId||'').toUpperCase()} | px ${Number(p.priceUsd||0).toFixed(6)} | liq ${fmtUSD(Number(p?.liquidity?.usd||0))}`).join('<br>');

      // pick buy/sell across DEX
      let min=Infinity,max=-Infinity,buy=null,sell=null;
      for(const p of perDex){
        const px=Number(p?.priceUsd||NaN); if(!isFinite(px)) continue;
        if(px<min){ min=px; buy=p; } if(px>max){ max=px; sell=p; }
      }
      if(!(buy&&sell)){ log(`${sym}: could not pick buy/sell`); progress(++done,entries.length,loanUSDC); await sleep(25); continue; }

      const spread=((max-min)/min)*100;
      if(spread<=0){ progress(++done,entries.length,loanUSDC); await sleep(20); continue; }
      if(spread>SPREAD_CAP_PCT){ log(`${sym}: spread ${spread.toFixed(2)}% > ${SPREAD_CAP_PCT}% cap`); progress(++done,entries.length,loanUSDC); await sleep(20); continue; }

      // P/L (constant-product approximation)
      const res=computePL({
        loanUSDC,
        buyPx:min, sellPx:max,
        buyLiq:Number(buy?.liquidity?.usd||0),
        sellLiq:Number(sell?.liquidity?.usd||0),
        ethUsd:state.ethUsd, gasGwei:state.gasGwei, gasLimit
      });
      if(!res || res.pnl==null){ progress(++done,entries.length,loanUSDC); await sleep(20); continue; }

      out.push({
        sym,
        buy:{dex:(buy?.dexId||"").toUpperCase(),price:min},
        sell:{dex:(sell?.dexId||"").toUpperCase(),price=max},
        spreadPct:res.rawPct, usdcBack:res.usdcBack, netPL:res.pnl
      });

    }catch(err){ log(`${sym}: error ${err.message||err}`); }
    progress(++done,entries.length,loanUSDC); await sleep(40);
  }

  out.sort((a,b)=> (b.netPL||-1)-(a.netPL||-1));
  renderRows(out);
  $("status").textContent=`Done. Listed ${out.length} route(s).`;
  if(!out.length) log("No routes after filters — try smaller loan, or wait for busier hours.");
  $("loading").style.display="none";
}
function progress(done,total,loan){ $("summary").textContent=`Progress ${done}/${total} • loan ${fmtUSD(loan)}`; }

/* ====== Render / Selection / Preview ====== */
let renderedRows=[];
function renderRows(rows){
  tbody.innerHTML=""; renderedRows = rows.slice();
  rows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    const good=r?.netPL>=MIN_NET_USD;
    tr.innerHTML=`
      <td><input type="checkbox" class="rowChk" data-i="${i}" ${good?'checked':''}></td>
      <td>${r.sym}</td>
      <td>${r.buy.dex}</td>
      <td class="right">${fmtUSD(r.buy.price,5)}</td>
      <td>${r.sell.dex}</td>
      <td class="right">${fmtUSD(r.sell.price,5)}</td>
      <td class="right">${r.spreadPct.toFixed(2)}%</td>
      <td class="right">${fmtUSD(r.usdcBack)}</td>
      <td class="right ${r.netPL>=0?'pos':'neg'}">${(r.netPL>=0?'+':'')+(isFinite(r.netPL)?r.netPL.toFixed(2):'0.00')}</td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll(".rowChk").forEach(chk=>chk.addEventListener("change",updateSelectionTotal));
  $("selectAll").checked=false; updateSelectionTotal();
}
function updateSelectionTotal(){
  let tot=0; tbody.querySelectorAll(".rowChk:checked").forEach(chk=>{
    const i=Number(chk.dataset.i||"-1"); const r=renderedRows[i]; if(r && isFinite(r.netPL)) tot += r.netPL;
  });
  $("selTotalPill").textContent=`Selected total: ${(tot>=0?'+':'')+fmtUSD(Math.abs(tot)).replace('$','+$')}`;
}
$("selectAll").addEventListener("change",e=>{
  const on=e.target.checked; tbody.querySelectorAll(".rowChk").forEach(cb=>cb.checked=on); updateSelectionTotal();
});
$("selectProfBtn").addEventListener("click",()=>{
  tbody.querySelectorAll(".rowChk").forEach(cb=>{
    const i=Number(cb.dataset.i||"-1"); const r=renderedRows[i];
    cb.checked = !!(r && r.netPL>=MIN_NET_USD);
  });
  $("selectAll").checked=false; updateSelectionTotal();
});
$("clearSelBtn").addEventListener("click",()=>{
  tbody.querySelectorAll(".rowChk").forEach(cb=>cb.checked=false); $("selectAll").checked=false; updateSelectionTotal();
});
$("previewBtn").addEventListener("click",()=>{
  const loan=Number($("loan").value)||0;
  const sel=[...tbody.querySelectorAll(".rowChk:checked")].map(cb=>renderedRows[Number(cb.dataset.i)]);
  if(!sel.length){ alert("No rows selected."); return; }
  let tot=0; sel.forEach(r=>tot+=r.netPL||0);
  const lines=sel.map(r=>`${r.sym}: ${r.buy.dex} @ ${r.buy.price.toFixed(5)} → ${r.sell.dex} @ ${r.sell.price.toFixed(5)} | back ${r.usdcBack.toFixed(2)} | net ${(r.netPL>=0?'+':'')+r.netPL.toFixed(2)}`).join('\n');
  alert(`Execution preview (mock)\nLoan: ${fmtUSD(loan)}\n\n${lines}\n\nSelected total: ${(tot>=0?'+':'')+tot.toFixed(2)} USDC`);
});

/* ====== Buttons / Init ====== */
$("scanBtn").addEventListener("click",()=>{ $("stopBtn").disabled=false; scan().finally(()=>$("stopBtn").disabled=true); });
$("stopBtn").addEventListener("click",()=>{ abort=true; $("status").textContent="Stopping…"; });

/* ====== Hamburger ====== */
document.getElementById('countPill').textContent="Tokens: "+Object.keys(TOKENS).length;
</script>
</body>
</html>
