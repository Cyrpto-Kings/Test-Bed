<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Kings — TestBed v9.9.30+</title>
<link rel="preconnect" href="https://api.dexscreener.com">
<style>
  :root{
    --bg:#0b0d10; --panel:#10151a; --panel-2:#0f1318; --text:#e8eef6; --muted:#a9b3c1;
    --brand1:#4f46e5; --brand2:#15b0ff; --ok:#16a34a; --danger:#ef4444; --chip:#151b22;
    --card-pos:#0f1a13; --card-neg:#1a1010; --border:#1e2733; --ring:#2b3646;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.4 system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  /* Header */
  .header{position:sticky;top:0;z-index:50;background:rgba(11,13,16,.65);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
  .h-inner{display:flex;align-items:center;gap:14px;padding:12px 16px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--brand1),var(--brand2));display:grid;place-items:center;font-weight:800}
  .brand h1{font-size:18px;margin:0}
  .sub{color:var(--muted);font-size:13px}
  .hamb{margin-left:auto;border:1px solid var(--border);background:var(--panel);border-radius:10px;width:38px;height:34px;display:grid;place-items:center;cursor:pointer}
  .hamb span{width:18px;height:2px;background:#cfd8e3;display:block;position:relative}
  .hamb span:before,.hamb span:after{content:"";position:absolute;left:0;width:18px;height:2px;background:#cfd8e3}
  .hamb span:before{top:-6px}.hamb span:after{top:6px}
  .menu{display:none;position:absolute;right:12px;top:56px;background:var(--panel);border:1px solid var(--border);border-radius:12px;min-width:220px;overflow:hidden}
  .menu a{display:block;padding:12px 14px;border-bottom:1px solid var(--border);font-size:14px}
  .menu a:last-child{border-bottom:none}
  /* Pills row */
  .pills{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 0}
  .pill{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted)}
  /* Panel */
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:16px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .field{flex:1;min-width:190px}
  .input{width:100%;background:var(--panel-2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
  .btn{border:0;color:#fff;background:linear-gradient(90deg,var(--brand1),var(--brand2));padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700}
  .btn.secondary{background:var(--panel-2);border:1px solid var(--border);color:var(--text)}
  .btn.ghost{background:transparent;border:1px dashed var(--ring);color:var(--muted)}
  .muted{color:var(--muted)}
  /* Results */
  .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0 12px}
  .chip-total{background:var(--chip);border:1px solid var(--border);padding:10px 14px;border-radius:999px}
  .results{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:680px){ .results{grid-template-columns:1fr 1fr} }
  .card{border:1px solid var(--border);border-radius:16px;padding:14px;background:var(--panel-2)}
  .card.pos{background:var(--card-pos);border-color:#133a24}
  .card.neg{background:var(--card-neg);border-color:#3a1919}
  .cardHead{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px}
  .sym{font-weight:800;letter-spacing:.3px}
  .profit{font-weight:800}
  .profit.pos{color:var(--ok)} .profit.neg{color:var(--danger)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .item{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px}
  .item small{color:var(--muted);display:block}
  .sel{display:flex;align-items:center;gap:8px}
  /* Logs */
  pre{background:#0a0e13;border:1px solid #15202b;color:#7af56c;padding:14px;border-radius:12px;white-space:pre-wrap;max-height:320px;overflow:auto}
  /* Footer */
  .footer{border-top:1px solid var(--border);background:#0a0e12}
  .fgrid{display:grid;grid-template-columns:1fr;gap:12px;padding:18px 0}
  @media(min-width:720px){ .fgrid{grid-template-columns:repeat(4,1fr)} }
  .ft h4{margin:0 0 8px;font-size:15px}
  .ft a{display:block;color:var(--muted);font-size:14px;padding:4px 0}
</style>
</head>
<body>

<header class="header">
  <div class="h-inner wrap">
    <div class="brand">
      <div class="logo">CK</div>
      <div>
        <h1>Crypto Kings</h1>
        <div class="sub">TestBed v9.9.30 • Arbitrum</div>
      </div>
    </div>
    <div class="hamb" id="hamb"><span></span></div>
    <nav class="menu" id="menu">
      <a href="#">Home</a>
      <a href="#">Who we are</a>
      <a href="#">What we do</a>
      <a href="#">Connect with us</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <div class="pills" id="pills">
    <span class="pill" id="rpcPill">RPC: custom</span>
    <span class="pill" id="tokensPill">Tokens: 0</span>
    <span class="pill" id="gasPill">Gas: —</span>
    <span class="pill" id="ethPill">ETH: —</span>
  </div>

  <!-- Controls -->
  <section class="panel">
    <div class="row" style="align-items:flex-end">
      <div class="field">
        <label class="muted">Loan Amount (USDC):</label>
        <input id="loan" class="input" type="number" value="10000" min="100" step="100">
      </div>
      <button id="scan" class="btn">Scan</button>
      <button id="stop" class="btn secondary">Stop</button>
    </div>
    <div id="status" class="muted" style="margin-top:10px">Ready.</div>
  </section>

  <!-- Actions -->
  <section class="panel">
    <div class="actions">
      <button id="selectProf" class="btn secondary">Select all profitable</button>
      <button id="clearSel" class="btn ghost">Clear</button>
      <div id="selectedTotal" class="chip-total">++$0</div>
      <div style="flex:1"></div>
      <button id="execute" class="btn">Execute Selected (Preview)</button>
    </div>

    <div id="results" class="results"></div>

    <details style="margin-top:12px">
      <summary class="muted">Details / Logs</summary>
      <pre id="logs"></pre>
    </details>
    <p class="muted" style="margin:12px 0 0">
      Net P/L = (loan ÷ buyPrice × sellPrice) – per-leg DEX fees (0.3%/leg) – slippage buffer (0.2%/leg) – flash (0.09%) – gas.
      Pools must be on Arbitrum. Profitable routes are auto-sorted to the top.
    </p>
  </section>
</main>

<footer class="footer">
  <div class="wrap fgrid">
    <div class="ft"><h4>Crypto Kings</h4>
      <a href="#">About</a><a href="#">Team</a><a href="#">Careers</a>
    </div>
    <div class="ft"><h4>Product</h4>
      <a href="#">TestBed</a><a href="#">Docs</a><a href="#">Roadmap</a>
    </div>
    <div class="ft"><h4>Legal</h4>
      <a href="#">Terms</a><a href="#">Privacy</a><a href="#">Risk</a>
    </div>
    <div class="ft"><h4>Contact</h4>
      <a href="#">Telegram</a><a href="#">X / Twitter</a><a href="#">Email</a>
    </div>
  </div>
  <div class="wrap" style="color:var(--muted);padding:0 0 18px;">© 2025 Crypto Kings Limited. All rights reserved.</div>
</footer>

<script>
(() => {
  // ---------- Config ----------
  const ARB_RPC = "https://arbitrum-one.publicnode.com"; // public RPC for gas price
  const TOKENS = [
    "WETH","USDC","USDT","DAI","ARB","LINK","GMX","AAVE","WBTC","RDNT",
    "PENDLE","FRAX","CRV","BAL","UNI","wstETH","SNX","COMP","YFI","GRT",
    "STG","LQTY","RPL","MKR","ENS","CVX","FXS","SUSHI","LUSD","MAGIC",
    "BADGER","DODO","BNT","OP","ALCX","DPX","rDPX","GRAIL","GNS","JOE",
    "KYBERSWAP","RAMSES","CAMELOT","TRADERJOE","PANCAKESWAP","CHRONOS",
    "KYBER","SUSHISWAP","UNISWAP V3","KYBERSWAP ELASTIC"
  ].slice(0,50);

  const DEX_ALLOW = [
    "Uniswap","Uniswap V3","SushiSwap","Camelot","Ramses",
    "KyberSwap Elastic","Trader Joe","PancakeSwap","Chronos","DeltaSwap"
  ];

  const DEXS_NAME_NORMALIZE = d => d
    .replace(/\s+/g,' ').trim()
    .replace(/v3/gi,'V3')
    .replace(/elastic/i,'Elastic');

  const FEES = { dexPerLeg:0.003, slipPerLeg:0.002, flash:0.0009 };
  const GAS_LIMIT = 380000; // two swaps + callback rough
  const log = s => (logs.textContent += s + "\n");
  const setStatus = s => status.textContent = s;
  const $ = sel => document.querySelector(sel);

  const pills = {
    rpc: $("#rpcPill"),
    tokens: $("#tokensPill"),
    gas: $("#gasPill"),
    eth: $("#ethPill")
  };

  const loanEl = $("#loan");
  const resultsEl = $("#results");
  const totalEl = $("#selectedTotal");

  let STOP=false, ETHUSD=0, GAS=0;

  // ---------- UI ----------
  $("#hamb").onclick = () => {
    const m = $("#menu");
    m.style.display = (m.style.display==='block'?'none':'block');
  };
  window.addEventListener('click',e=>{
    if(!e.target.closest('#hamb') && !e.target.closest('#menu')) $("#menu").style.display='none';
  });

  $("#selectProf").onclick = () => {
    resultsEl.querySelectorAll(".card.pos input[type=checkbox]").forEach(c=>{
      c.checked = true;
    });
    updateSelectedTotal();
  };
  $("#clearSel").onclick = () => {
    resultsEl.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
    updateSelectedTotal();
  };
  resultsEl.addEventListener("change", e=>{
    if(e.target.matches("input[type=checkbox]")) updateSelectedTotal();
  });

  function updateSelectedTotal(){
    let sum = 0;
    resultsEl.querySelectorAll(".card input[type=checkbox]:checked").forEach(cb=>{
      sum += Number(cb.dataset.net || 0);
    });
    totalEl.textContent = (sum>=0? "++$":"-$") + Math.abs(sum).toFixed(2);
  }

  // ---------- Core ----------
  async function rpcGasPriceWei(){
    try{
      const res = await fetch(ARB_RPC, {
        method:"POST",
        headers:{"content-type":"application/json"},
        body: JSON.stringify({jsonrpc:"2.0",id:1,method:"eth_gasPrice",params:[]})
      });
      const j = await res.json();
      return Number(BigInt(j.result))/1e9; // gwei
    }catch(e){
      log("[gas] fallback 0.01 gwei");
      return 0.01;
    }
  }

  async function fetchPairsForSymbol(sym){
    // Dexscreener search on Arbitrum; returns many pairs; we'll filter by DEX + quote USDC/USDT
    const q = encodeURIComponent(sym + " arbitrum");
    const url = `https://api.dexscreener.com/latest/dex/search?q=${q}`;
    const r = await fetch(url);
    if(!r.ok) return [];
    const data = await r.json();
    if(!data.pairs) return [];
    return data.pairs.filter(p=>{
      const chain = (p.chainId||"").toLowerCase();
      if(chain!=="arbitrum") return false;
      const dex = DEXS_NAME_NORMALIZE(p.dexId||"");
      const quote = (p.quoteToken?.symbol||"").toUpperCase();
      const okDex = DEX_ALLOW.some(d=>DEXS_NAME_NORMALIZE(d)===DEXS_NAME_NORMALIZE(dex));
      const okQuote = (quote==="USDC" || quote==="USDT");
      return okDex && okQuote && Number(p.liquidity?.usd||0) > 20000; // minimal liq
    });
  }

  function bestRouteFromPairs(pairs, loanUSDC){
    // Find min buy price & max sell price across allowed DEX
    let bestBuy=null, bestSell=null;
    for(const p of pairs){
      const dex = DEXS_NAME_NORMALIZE(p.dexId||"");
      const price = Number(p.priceUsd||0);
      if(!price || price<=0) continue;
      // Buy: want lowest price
      if(!bestBuy || price<bestBuy.price) bestBuy = {dex, price};
      // Sell: want highest price
      if(!bestSell || price>bestSell.price) bestSell = {dex, price};
    }
    if(!bestBuy || !bestSell || bestSell.price<=0) return null;

    // P/L math
    const buyPrice = bestBuy.price;
    const sellPrice = bestSell.price;

    const tokenOut = loanUSDC / buyPrice;
    // fees + slippage both legs
    const feeFactor = (1 - FEES.dexPerLeg - FEES.slipPerLeg);
    const tokenAfterBuy = tokenOut * feeFactor;
    const usdcBack = tokenAfterBuy * sellPrice * feeFactor;

    // flash + gas
    const flashFee = loanUSDC * FEES.flash;
    const gasCost = (GAS/1e9) * GAS_LIMIT * ETHUSD; // (gwei -> wei) already a number in gwei; convert to ETH then USD
    const net = usdcBack - loanUSDC - flashFee - gasCost;
    const spread = ((sellPrice - buyPrice)/buyPrice) * 100;

    return {
      buyDex: bestBuy.dex, sellDex: bestSell.dex,
      buyPrice, sellPrice, spread, usdcBack, net
    };
  }

  function renderRoutes(routes){
    // Sort profitable first (net desc), then by spread desc
    routes.sort((a,b)=> (b.net - a.net) || (b.spread - a.spread));
    resultsEl.innerHTML = "";
    for(const r of routes){
      const pos = r.net >= 0;
      const card = document.createElement("div");
      card.className = "card " + (pos?"pos":"neg");
      card.innerHTML = `
        <div class="cardHead">
          <div class="sel">
            <input type="checkbox" ${pos?"checked":""} data-net="${r.net.toFixed(2)}">
            <div class="sym">${r.sym}</div>
          </div>
          <div class="profit ${pos?"pos":"neg"}">${pos?"+$":"-$"}${Math.abs(r.net).toFixed(2)}</div>
        </div>
        <div class="grid">
          <div class="item">
            <small>Buy @ DEX</small>
            <div>${r.buyDex}</div>
            <small class="muted">$${r.buyPrice.toFixed(6)}</small>
          </div>
          <div class="item">
            <small>Sell @ DEX</small>
            <div>${r.sellDex}</div>
            <small class="muted">$${r.sellPrice.toFixed(6)}</small>
          </div>
          <div class="item">
            <small>Spread %</small>
            <div>${r.spread.toFixed(2)}%</div>
          </div>
          <div class="item">
            <small>USDC Back</small>
            <div>$${r.usdcBack.toFixed(2)}</div>
          </div>
        </div>
      `;
      resultsEl.appendChild(card);
    }
    updateSelectedTotal();
  }

  async function scan(){
    STOP=false;
    logs.textContent = "";
    resultsEl.innerHTML = "";
    const loan = Number(loanEl.value||0);
    if(!loan || loan<=0){ setStatus("Enter a loan amount."); return; }

    pills.tokens.textContent = `Tokens: ${TOKENS.length}`;
    setStatus("Fetching gas & ETH...");
    const gwei = await rpcGasPriceWei(); // number in gwei
    GAS = gwei * 1e9; // wei
    pills.gas.textContent = `Gas: ${gwei.toFixed(2)} gwei`;

    // ETH price via WETH/USDC best
    try{
      const res = await fetch("https://api.dexscreener.com/latest/dex/search?q=WETH arbitrum");
      const j = await res.json();
      const weth = (j.pairs||[]).filter(p=> (p.chainId||"").toLowerCase()==="arbitrum" && (p.quoteToken?.symbol||"").toUpperCase().startsWith("USDC"))
                                 .sort((a,b)=> (Number(b.liquidity?.usd||0) - Number(a.liquidity?.usd||0)))[0];
      ETHUSD = Number(weth?.priceUsd||0) || 4000;
    }catch(_){ ETHUSD = 4000; }
    pills.eth.textContent = `ETH: US$${ETHUSD.toLocaleString(undefined,{maximumFractionDigits:2})}`;

    setStatus("Scanning live quotes...");
    let done=0;
    const out = [];
    for(const sym of TOKENS){
      if(STOP) break;
      try{
        const pairs = await fetchPairsForSymbol(sym);
        if(pairs.length===0){ log(`[${new Date().toTimeString().slice(0,8)}] ${sym}: no Arbitrum/USDC(USDT) pairs`); continue; }
        const r = bestRouteFromPairs(pairs, loan);
        if(r){
          out.push({sym, ...r});
          log(`[${new Date().toTimeString().slice(0,8)}] ${sym}: ${r.buyDex} -> ${r.sellDex} | spread ${r.spread.toFixed(2)}% | net ${r.net.toFixed(2)}`);
        }else{
          log(`[${new Date().toTimeString().slice(0,8)}] ${sym}: no profitable route`);
        }
      }catch(e){
        log(`[${new Date().toTimeString().slice(0,8)}] ${sym}: error ${e.message}`);
      }
      done++;
      setStatus(`Progress ${done}/${TOKENS.length} • loan $${loan.toLocaleString()}`);
    }

    renderRoutes(out);
    setStatus(`Done. Found ${out.filter(r=>r.net>=0).length} profitable route(s), ${out.length} total rows.`);
  }

  // ---------- Wire ----------
  $("#scan").onclick = scan;
  $("#stop").onclick = () => { STOP=true; setStatus("Stopped."); };
  $("#execute").onclick = () => {
    const picked = [];
    resultsEl.querySelectorAll(".card input[type=checkbox]:checked").forEach(cb=>{
      const card = cb.closest(".card");
      const sym = card.querySelector(".sym").textContent.trim();
      const profit = cb.dataset.net;
      picked.push({sym, profit});
    });
    alert(picked.length ? `Preview executing ${picked.length} route(s)\n\n` + picked.map(p=>`${p.sym}: $${Number(p.profit).toFixed(2)}`).join("\n") : "Nothing selected.");
  };

  // init
  pills.rpc.textContent = "RPC: publicnode";
  pills.tokens.textContent = `Tokens: ${TOKENS.length}`;
  setStatus("Ready.");
})();
</script>
</body>
</html>
