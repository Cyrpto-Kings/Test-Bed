<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Crypto Kings Test Bed v9.5.1 — Arbitrum (Quoter + Fixed Header)</title>
<style>
  :root{
    --bg:#f6f7f9; --surface:#fff; --ink:#111827; --muted:#6b7280;
    --brand:#7c5cff; --brand2:#1d9bf0; --ring:rgba(124,92,255,.35);
    --border:#e5e7eb; --border-strong:#d1d5db; --ok:#10b981; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column;min-height:100vh;overflow-x:hidden;}

  .container{max-width:1100px;width:100%;margin:0 auto;padding:0 16px}
  main{flex:1}

  /* Topbar (flex, robust on mobile) */
  .topbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border)}
  .topbar-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;flex-wrap:wrap}
  .brandbox{display:flex;align-items:center;gap:10px}
  .home-link{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
  .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(29,155,240,.18)}
  .logo span{font-size:14px;font-weight:900;color:white}
  .brand{font-weight:800;letter-spacing:.3px;white-space:nowrap}
  .chip{display:inline-block;padding:2px 8px;border:1px solid var(--border-strong);border-radius:999px;font-size:12px;background:#eef2ff;color:#3b3b6d}

  /* Nav */
  .nav{display:flex;align-items:center;gap:18px}
  .nav a{color:#111827;text-decoration:none;font-weight:600;font-size:14px}
  .nav a:hover{text-decoration:underline}
  .nav-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .hamburger{display:none;appearance:none;border:1px solid var(--border-strong);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .hamburger:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}
  @media (max-width:980px){ .nav{display:none} .hamburger{display:inline-flex} }

  /* Mobile sheet */
  .mobile-nav{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:60;align-items:flex-start;justify-content:flex-end}
  .mobile-sheet{background:#fff;width:min(88%,380px);height:100%;box-shadow:-10px 0 30px rgba(0,0,0,.2);border-left:1px solid var(--border);padding:16px;display:flex;flex-direction:column;gap:10px}
  .mobile-sheet header{display:flex;justify-content:space-between;align-items:center}
  .mobile-sheet ul{list-style:none;margin:0;padding:0;display:grid;gap:10px}
  .mobile-sheet a{color:#111827;text-decoration:none;font-weight:700}
  .mobile-close{appearance:none;border:1px solid var(--border-strong);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}

  /* Controls & Actions */
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .group{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:6px 8px}
  .group input{width:160px;padding:8px 10px;border:1px solid var(--border-strong);border-radius:8px}
  .group input:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;color:white;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 6px 16px rgba(124,92,255,.15);min-height:44px}
  .btn.ghost{background:#fff;color:#111;border:1px solid var(--border-strong);box-shadow:none}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  @media (max-width:560px){ .group input{width:140px} .actions .btn{flex:1 1 calc(50% - 8px)} }

  main .wrap{padding:16px 0 80px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:960px){ .row-4{grid-template-columns:repeat(4,1fr)} }
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[readonly]{background:#f9fafb;color:#4b5563}

  /* Table -> responsive cards */
  .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch}
  table{min-width:980px;width:100%}
  .table{border-collapse:collapse;margin-top:10px;background:#fff;border:1px solid var(--border)}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;text-align:left;white-space:nowrap}
  .table th{color:#374151;font-weight:700;background:#f9fafb}
  .table tr:nth-child(even){background:#fafafa}
  .right{text-align:right}
  .pos{background:#ecfdf5} .neg{background:#fef2f2} .meh{background:#f9fafb}
  @media (max-width:560px){
    table{min-width:0}
    .table thead{display:none}
    .table tr{display:grid;grid-template-columns:1fr;gap:6px;background:#fff;border:1px solid var(--border);border-radius:12px;margin:10px 0;padding:10px 10px}
    .table td{display:flex;justify-content:space-between;align-items:center;gap:10px;white-space:normal;border:0;padding:6px 0}
    .table td::before{content:attr(data-label);font-size:12px;color:#6b7280;margin-right:10px;flex:0 0 auto}
    .right{text-align:right}
  }

  .spinner{border:4px solid rgba(0,0,0,.08);border-top:4px solid var(--brand);border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

  footer{background:#fff;border-top:1px solid var(--border);margin-top:40px}
  .footer-inner{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:30px 0}
  footer h4{margin:0 0 8px;font-size:14px;color:#374151}
  footer ul{list-style:none;margin:0;padding:0;font-size:13px;color:#4b5563}
  footer li{margin:4px 0}
  footer a{color:inherit;text-decoration:none}
  footer a:hover{text-decoration:underline}
  .copyright{border-top:1px solid var(--border);padding:12px 0;font-size:12px;color:#6b7280;text-align:center}
  @media (max-width:960px){ .footer-inner{grid-template-columns:1fr 1fr} }
  @media (max-width:560px){ .footer-inner{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="topbar" style="padding-top: env(safe-area-inset-top)">
    <div class="container topbar-inner">
      <!-- Left: brand/home -->
      <div class="brandbox">
        <a class="home-link" href="/">
          <div class="logo" aria-label="Home"><span>CK</span></div>
          <div class="brand">Crypto Kings</div>
        </a>
        <span class="chip">v9.5.1</span>
      </div>

      <!-- Center: desktop nav -->
      <div class="nav" aria-label="Main">
        <a href="/">Home</a>
        <a href="#" title="Who we are">Who we are</a>
        <a href="#" title="What we do">What we do</a>
        <a href="#" title="Connect with us">Connect with us</a>
      </div>

      <!-- Right: controls & actions -->
      <div class="nav-right">
        <div class="controls">
          <div class="group">
            <label for="loanUsd" class="help">Loan Size (USD)</label>
            <input id="loanUsd" type="number" min="100" max="500000" step="500" value="100000" inputmode="decimal">
          </div>
        </div>
        <div class="actions">
          <button id="scanBtn" class="btn">Scan (Uni v3 quotes)</button>
          <button id="executeBtn" class="btn" disabled>Execute (mock)</button>
          <button id="connectBtn" class="btn ghost">Connect</button>
          <button id="hamburger" class="hamburger" aria-label="Open menu">☰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Nav Sheet -->
  <div id="mobileNav" class="mobile-nav" aria-hidden="true">
    <div class="mobile-sheet">
      <header>
        <strong>Menu</strong>
        <button id="mobileClose" class="mobile-close" aria-label="Close menu">✕</button>
      </header>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="#" title="Who we are">Who we are</a></li>
        <li><a href="#" title="What we do">What we do</a></li>
        <li><a href="#" title="Connect with us">Connect with us</a></li>
      </ul>
    </div>
  </div>

  <main class="container wrap">
    <div class="card">
      <div class="row row-4">
        <div><label>Network</label><input value="Arbitrum" readonly></div>
        <div><label>Gas (auto)</label><input id="gas-gwei" placeholder="Auto" readonly><div class="help" id="gas-note">—</div></div>
        <div><label>Gas Limit</label><input id="gas-limit" type="number" step="1000" value="170000"><div class="help">Uni/Sushi ~170–200k • Curve ~340k • Balancer ~300k</div></div>
        <div><label>Est. Gas Cost</label><input id="gas-cost" placeholder="—" readonly><div class="help" id="gas-cost-usd">—</div></div>
      </div>

      <div class="row" style="margin-top:6px">
        <div><span id="status" class="help">Ready.</span></div>
      </div>

      <div class="table-wrap">
        <table class="table" id="oppsTable">
          <thead>
            <tr>
              <th>Token</th>
              <th>Uni v3 Buy (best tier)</th>
              <th>Uni v3 Sell (best tier)</th>
              <th class="right">Raw Spread %</th>
              <th class="right">Net (after Aave fee + gas)</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer>
    <div class="container footer-inner">
      <div>
        <div class="logo"><span>CK</span></div>
        <p class="help">On-chain quoter (Arbitrum, Uniswap v3) for realistic P/L.</p>
      </div>
      <div>
        <h4>Quick</h4>
        <ul>
          <li><a href="#" id="lkScan">Scan</a></li>
          <li><a href="#" id="lkExec">Execute</a></li>
        </ul>
      </div>
      <div><h4>Networks</h4><ul><li>Arbitrum (active)</li><li>Others (soon)</li></ul></div>
      <div><h4>Contact</h4><ul><li><a href="mailto:info@example.com">info@example.com</a></li></ul></div>
    </div>
    <div class="copyright">© 2025 Crypto Kings. All rights reserved.</div>
  </footer>

  <!-- Wallet modal -->
  <div id="walletModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:70">
    <div style="background:#fff;color:#111;max-width:420px;width:95%;border-radius:12px;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,.25)">
      <header style="padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800">Connect a wallet</header>
      <div style="padding:12px;display:grid;gap:10px">
        <div class="w-item" id="wMetaMask" style="display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer;background:#fafafa">
          <div class="w-icon" style="width:26px;height:26px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center">
            <svg viewBox="0 0 64 64" width="22" height="22"><path fill="#e4761b" d="M2 2l24 18-4-10zM62 2L38 20l4-10z"/><path fill="#f6851b" d="M10 38l16-4 2 12-2 6L18 50zM54 38l-16-4-2 12 2 6 8-2z"/></svg>
          </div>
          <div><strong>MetaMask</strong><div class="help">EVM (Arbitrum)</div></div>
        </div>
        <div class="w-item" id="wManual" style="display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer;background:#fafafa">
          <div class="w-icon" style="width:26px;height:26px;border-radius:8px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800">@</div>
          <div><strong>Manual address</strong><div class="help">Paste wallet address</div></div>
        </div>
      </div>
      <div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end">
        <button id="walletClose" class="mobile-close">Close</button>
      </div>
    </div>
  </div>

  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" crossorigin="anonymous"></script>

<script>
/* Error banner (non-blocking) */
(function(){
  const show=(msg,src,line,col,err)=>{
    try{
      const bar=document.createElement('div');
      bar.style.margin='12px auto'; bar.style.maxWidth='1100px';
      bar.innerHTML='<div style="background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d;padding:10px 12px;border-radius:10px"><strong>App notice</strong><pre style="white-space:pre-wrap;margin:6px 0 0;font-size:12px;color:#7f1d1d">'+(err&&err.stack ? err.stack : [msg,src,line+':'+col].filter(Boolean).join(' | '))+'</pre></div>';
      document.body.prepend(bar);
    }catch(_){}
    return false;
  };
  window.onerror=show;
  window.onunhandledrejection=e=>show('Unhandled promise rejection','','','',e&&(e.reason||e));
})();
</script>

<script>
/* App v9.5.1 — Arbitrum + Uni v3 QuoterV2 + hardened init */
(function(){
  /* Utilities */
  const $ = (id)=>document.getElementById(id);
  const on = (el,ev,fn)=>{ if(el) el.addEventListener(ev,fn); };
  const fmtUSD=v=>isFinite(v)?`$${Number(v).toLocaleString(undefined,{maximumFractionDigits:6})}`:"—";
  const shortAddr=a=>a?`${a.slice(0,6)}…${a.slice(-4)}`:"";

  /* Header menu (mobile) */
  on($("hamburger"),"click", ()=>{ const m=$("mobileNav"); if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); } });
  on($("mobileClose"),"click", ()=>{ const m=$("mobileNav"); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } });
  on($("mobileNav"),"click", (e)=>{ const m=$("mobileNav"); if(e.target===m) $("mobileClose").click(); });

  /* DeFi constants */
  const PLATFORM_FEE=0.0009; // Aave v3 ~0.09%
  const GAS_NATIVE="ETH";
  const RPC_ARB="https://arbitrum.llamarpc.com";
  const CHAIN_ID=42161;

  const UNI = {
    QUOTER_V2: "0x61fFE014bA17989E743c5F6cB21bF9697530B21e",
    WETH: "0x82aF49447D8a07e3bd95BD0d56f35241523fBab1",
    USDC: "0xaf88d065e77c8cC2239327C5EDb3A432268e5831",
    FEES: [500,3000,10000]
  };

  /* Ethers provider */
  const provider = new ethers.providers.JsonRpcProvider(RPC_ARB, { chainId:CHAIN_ID, name:"arbitrum" });

  /* ABIs */
  const ERC20_ABI=[ "function decimals() view returns (uint8)" ];
  const QUOTER_ABI=[ "function quoteExactInputSingle(address,address,uint24,uint256,uint160) external returns (uint256 amountOut, uint160, uint32, uint256)" ];

  /* State */
  const state={ rows:[], account:null };
  const gas={ gwei:null, usdPerNative:null, usd:0 };

  /* Gas auto */
  async function gasSuggestGwei(){
    try{
      const payload={jsonrpc:"2.0",id:1,method:"eth_feeHistory",params:[5,"latest",[10,50,90]]};
      const r=await fetch(RPC_ARB,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      if(!r.ok) return null;
      const j=await r.json(); const bh=j&&j.result;
      if(!bh?.baseFeePerGas||!bh?.reward) return null;
      const base=parseInt(bh.baseFeePerGas.at(-1),16)/1e9;
      const tip =parseInt((bh.reward.at(-1)||[])[1]||"0x0",16)/1e9;
      return {g:base+tip, base, tip};
    }catch(_){ return null; }
  }
  async function cgETH(){
    try{
      const r=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd");
      if(!r.ok) return null; const j=await r.json();
      return j?.ethereum?.usd ?? null;
    }catch(_){ return null; }
  }
  async function initGas(){
    const g=await gasSuggestGwei(); const ethUsd=await cgETH();
    gas.gwei=g?g.g:null; gas.usdPerNative=ethUsd??null;
    if(g){ $("gas-gwei").value=`${g.g.toFixed(1)} Gwei`; $("gas-note").textContent=`base ${g.base.toFixed(1)} + tip ${g.tip.toFixed(1)} • ETH ≈ ${fmtUSD(ethUsd)}`; }
    else{ $("gas-gwei").value=""; $("gas-note").textContent="auto gas failed."; }
    calcGasUSD();
  }
  function calcGasUSD(){
    const gl=parseFloat($("gas-limit").value||"0");
    const native=(gas.gwei>0 && gl>0)?(gas.gwei*gl)/1e9:0;
    gas.usd = native*(gas.usdPerNative||0);
    $("gas-cost").value = native? `${native.toFixed(6)} ${GAS_NATIVE}` : "";
    $("gas-cost-usd").textContent = native? `≈ ${fmtUSD(gas.usd)}` : "—";
  }

  /* Token universe (majors + tokenlist sample) */
  async function getTokenAddresses(){
    const set=new Set([
      UNI.USDC, // USDC
      "0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9", // USDT
      UNI.WETH, // WETH
      "0x912CE59144191C1204E64559FE8253a0e49E6548", // ARB
      "0xda10009cbd5d07dd0cecc66161fc93d7c9000da1" // DAI (fixed)
    ]);
    try{
      const r=await fetch("https://unpkg.com/@uniswap/default-token-list@latest/build/uniswap-default.tokenlist.json");
      if(r.ok){
        const tl=await r.json();
        tl.tokens.filter(t=>t.chainId===42161).slice(0,120).forEach(t=>set.add(t.address));
      }
    }catch(_){}
    return [...set];
  }

  /* On-chain helpers */
  async function getDecimals(token){
    try{ const c=new ethers.Contract(token, ERC20_ABI, provider); return await c.decimals(); }
    catch(_){ return 18; }
  }
  async function bestQuoteIn_USDC_to_TOKEN(token, tokenDecimals, amountUSDC){
    const q=new ethers.Contract(UNI.QUOTER_V2, QUOTER_ABI, provider);
    const inAmt = ethers.utils.parseUnits(String(amountUSDC), 6);
    let best=null;
    for(const fee of UNI.FEES){
      try{
        const [out]=await q.callStatic.quoteExactInputSingle(UNI.USDC, token, fee, inAmt, 0);
        if(out.gt(0)){
          const units = Number(ethers.utils.formatUnits(out, tokenDecimals));
          if(!best || units>best.units) best={fee,units};
        }
      }catch(_){}
    }
    return best;
  }
  async function bestQuoteOut_TOKEN_to_USDC(token, tokenDecimals, unitsTOKEN){
    const q=new ethers.Contract(UNI.QUOTER_V2, QUOTER_ABI, provider);
    const inAmt = ethers.utils.parseUnits(String(unitsTOKEN), tokenDecimals);
    let best=null;
    for(const fee of UNI.FEES){
      try{
        const [out]=await q.callStatic.quoteExactInputSingle(token, UNI.USDC, fee, inAmt, 0);
        if(out.gt(0)){
          const usd = Number(ethers.utils.formatUnits(out, 6));
          if(!best || usd>best.usd) best={fee,usd};
        }
      }catch(_){}
    }
    return best;
  }
  const rawSpreadPct=(buyUSDC, sellUSDC)=> ((sellUSDC - buyUSDC)/Math.max(1e-9,buyUSDC))*100;

  async function evaluateToken(token){
    try{
      const dec = await getDecimals(token);
      const loanUSD = clampLoan();
      const buy = await bestQuoteIn_USDC_to_TOKEN(token, dec, loanUSD);
      if(!buy) return null;
      const sell = await bestQuoteOut_TOKEN_to_USDC(token, dec, buy.units);
      if(!sell) return null;

      const buyCostUSD=loanUSD, sellProUSD=sell.usd;
      const rawPct=rawSpreadPct(buyCostUSD, sellProUSD);
      const aaveFeeUSD=loanUSD*PLATFORM_FEE;
      const netUSD=sellProUSD - buyCostUSD - aaveFeeUSD - (gas.usd||0);

      return { token, dec, buyTier:buy.fee, sellTier:sell.fee, buyUSDC:buyCostUSD, sellUSDC:sellProUSD, rawPct, netUSD };
    }catch(_){ return null; }
  }

  function clampLoan(){
    let v=parseFloat($("loanUsd").value||"0"); if(!isFinite(v)) v=100000;
    v=Math.max(100, Math.min(500000, v)); v=Math.round(v/100)*100;
    $("loanUsd").value=String(v); return v;
  }

  function renderRows(rows){
    const tbody=$("rows"); if(!tbody) return; tbody.innerHTML="";
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.className = (r.netUSD>0) ? "pos" : (r.netUSD>-3 ? "meh" : "neg");
      tr.innerHTML = `
        <td data-label="Token"><code>${shortAddr(r.token)}</code><div class="help">Uni v3 tiers: buy ${r.buyTier/10000}% • sell ${r.sellTier/10000}%</div></td>
        <td data-label="Uni v3 Buy">USDC → TOKEN (best of 0.05/0.3/1%)</td>
        <td data-label="Uni v3 Sell">TOKEN → USDC (best of 0.05/0.3/1%)</td>
        <td class="right" data-label="Raw Spread">${r.rawPct.toFixed(2)}%</td>
        <td class="right" data-label="Net">${fmtUSD(r.netUSD)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function scan(){
    const status=$("status"); const rowsEl=$("rows");
    if(rowsEl) rowsEl.innerHTML="";
    if(status) status.innerHTML=`<span class="spinner"></span> Initialising…`;
    await initGas();

    let addrs=[];
    try{ addrs = await getTokenAddresses(); }
    catch(e){ if(status) status.textContent='Token list error'; }

    if(!addrs.length){ if(status) status.textContent="No token addresses yet. Try again."; return; }

    if(status) status.innerHTML=`<span class="spinner"></span> Scanning ${addrs.length} tokens via Uniswap Quoter…`;

    const SAMPLE=80, CONCURRENCY=6, list=addrs.slice(0,SAMPLE);
    const out=new Array(list.length); let i=0, done=0;

    async function worker(){
      while(i<list.length){
        const idx=i++; const t=list[idx];
        out[idx]=await evaluateToken(t);
        done++; if(status && done%5===0) status.textContent=`Quoting ${done}/${list.length}…`;
      }
    }
    await Promise.all(Array.from({length:CONCURRENCY}, worker));

    const rows=out.filter(Boolean).sort((a,b)=>b.netUSD-a.netUSD);
    if(status) status.textContent = rows.length ? `Found ${rows.length} Uni v3 round-trip routes (loan ${fmtUSD(clampLoan())}).` : "No viable Uni v3 routes at this size.";
    state.rows=rows; renderRows(rows);
    if($("executeBtn")) $("executeBtn").disabled=!rows.length;
  }

  /* Wallet + mock execute */
  function openWallet(){ const m=$("walletModal"); if(m) m.style.display='flex'; }
  function closeWallet(){ const m=$("walletModal"); if(m) m.style.display='none'; }
  async function connectMetaMask(){
    if(!window.ethereum){ alert('MetaMask not detected.'); return; }
    try{
      const accs=await window.ethereum.request({method:'eth_requestAccounts'});
      state.account=accs&&accs[0]||null;
      const b=$("connectBtn"); if(b) { b.textContent=state.account?shortAddr(state.account):'Connect'; b.classList.add('ghost'); }
      closeWallet();
    }catch(_){ alert('Connection rejected.'); }
  }
  function connectManual(){
    const addr=prompt('Paste Arbitrum (EVM) address:'); if(!addr) return;
    state.account=addr.trim();
    const b=$("connectBtn"); if(b){ b.textContent=shortAddr(state.account); b.classList.add('ghost'); }
    closeWallet();
  }
  function executeMock(){
    if(!state.account){ alert('Connect wallet first.'); return; }
    if(!state.rows.length){ alert('Scan first.'); return; }
    const top=state.rows.slice(0,Math.min(5,state.rows.length)).map(r=>`• ${shortAddr(r.token)}  net ${fmtUSD(r.netUSD)} (tiers ${r.buyTier/10000}%/${r.sellTier/10000}%)`).join('\n');
    const txid='0x'+Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('');
    alert(`(Mock) Execute batch on ARBITRUM
Wallet: ${shortAddr(state.account)}
Loan: ${fmtUSD(clampLoan())}
Routes: ${state.rows.length}
Top:
${top}

TxID: ${txid}`);
  }

  /* Wire UI safely */
  on($("scanBtn"),"click", scan);
  on($("executeBtn"),"click", executeMock);
  on($("connectBtn"),"click", openWallet);
  on($("walletClose"),"click", closeWallet);
  on($("wMetaMask"),"click", connectMetaMask);
  on($("wManual"),"click", connectManual);
  on($("lkScan"),"click", e=>{ e.preventDefault(); scan(); });
  on($("lkExec"),"click", e=>{ e.preventDefault(); executeMock(); });
  on($("gas-limit"),"input", calcGasUSD);
  on($("loanUsd"),"change", calcGasUSD);

  /* Init (no auto-scan to avoid rate limits; page renders regardless) */
  (async()=>{ try{ await initGas(); }catch(_){ /* noop */ } })();
})();
</script>
</body>
</html>
