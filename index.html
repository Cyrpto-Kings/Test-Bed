<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Kings Test Bed v9.2.1 — Arbitrum Focus + Batch</title>
<style>
  :root{
    --bg:#f5f6f8; --surface:#fff; --ink:#111827; --muted:#6b7280;
    --brand:#7c5cff; --brand2:#1d9bf0; --ring:rgba(124,92,255,.35);
    --border:#e5e7eb; --border-strong:#d1d5db; --ok:#10b981; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1100px;margin:0 auto;padding:0 16px}

  /* Topbar (simple) */
  .topbar{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid var(--border)}
  .topbar-inner{display:flex;align-items:center;gap:12px;padding:10px 0}
  .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(29,155,240,.18)}
  .logo span{font-size:14px;font-weight:900;color:white}
  .brand{font-weight:800;letter-spacing:.3px}
  .chip{display:inline-block;padding:2px 8px;border:1px solid var(--border-strong);border-radius:999px;font-size:12px;background:#eef2ff;color:#3b3b6d}
  .spacer{flex:1}
  .group{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:6px 8px}
  .group input{width:140px;padding:8px 10px;border:1px solid var(--border-strong);border-radius:8px}
  .group input:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring)}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;color:white;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 6px 16px rgba(124,92,255,.15)}
  .btn.ghost{background:#fff;color:#111;border:1px solid var(--border-strong);box-shadow:none}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .wrap{padding:18px 0 80px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[readonly]{background:#f9fafb;color:#4b5563}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:960px){ .row-2{grid-template-columns:repeat(2,1fr)} .row-3{grid-template-columns:repeat(3,1fr)} .row-4{grid-template-columns:repeat(4,1fr)} }
  .help{font-size:12px;color:var(--muted)}
  .table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border:1px solid var(--border)}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
  .table th{color:#374151;font-weight:700;background:#f9fafb}
  .table tr:nth-child(even){background:#fafafa}
  .right{text-align:right}
  .pos{background:#ecfdf5} .neg{background:#fef2f2} .meh{background:#f9fafb}
  .spinner{border:4px solid rgba(0,0,0,.08);border-top:4px solid var(--brand);border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .errbar{margin-top:12px}
  .errbar .box{background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d;padding:10px 12px;border-radius:10px}
  .errbar .box pre{white-space:pre-wrap;word-break:break-word;margin:6px 0 0;font-size:12px;color:#7f1d1d}

  /* Wallet modal (MetaMask + Manual) */
  #walletModal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
  .w-card{background:#fff;color:#111;max-width:420px;width:95%;border-radius:12px;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,.25)}
  .w-card header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800}
  .w-body{padding:12px 12px 16px;display:grid;grid-template-columns:1fr;gap:10px}
  .w-item{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer;background:#fafafa}
  .w-item:hover{background:#f3f4f6}
  .w-icon{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center}
  .w-foot{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
</style>
</head>
<body>
  <div class="topbar">
    <div class="container topbar-inner">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="logo"><span>CK</span></div>
        <div class="brand">Crypto Kings</div>
        <span class="chip">v9.2.1</span>
      </div>
      <div class="spacer"></div>
      <div class="group">
        <label for="loanUsd" class="help">Loan Size (USD)</label>
        <input id="loanUsd" type="number" min="100" max="100000" step="100" value="1000">
      </div>
      <label class="group" style="gap:6px">
        <input id="autoRescan" type="checkbox" checked><span class="help">Auto (60s)</span>
      </label>
      <button id="scanBtn" class="btn">Scan</button>
      <button id="autoBtn" class="btn">Auto Select</button>
      <button id="autoAllBtn" class="btn">Select All Profitable</button>
      <button id="execBtn" class="btn" disabled>Execute</button>
      <button id="execAllBtn" class="btn" disabled>Execute All</button>
      <button id="connectBtn" class="btn ghost">Connect</button>
    </div>
  </div>

  <div class="container wrap">
    <div id="errbar" class="errbar" style="display:none;">
      <div class="box"><strong>App notice</strong><pre id="errtxt"></pre></div>
    </div>

    <!-- ARBITRUM ONLY -->
    <div class="card" id="pane-arbitrum">
      <div class="row row-4">
        <div><label>Network</label><input value="Arbitrum" readonly></div>
        <div><label>Gas (auto)</label><input id="gas-gwei-arbitrum" placeholder="Auto" readonly><div class="help" id="gas-note-arbitrum">—</div></div>
        <div><label>Gas Limit</label><input id="gas-limit-arbitrum" type="number" step="1000" value="170000"><div class="help">Uni/Sushi ~170–200k • Curve ~340k • Balancer ~300k</div></div>
        <div><label>Est. Gas Cost</label><input id="gas-cost-arbitrum" placeholder="—" readonly><div class="help" id="gas-cost-usd-arbitrum">—</div></div>
      </div>

      <div class="row row-3" style="margin-top:8px">
        <div><span id="status-arbitrum" class="help">Ready.</span></div>
        <div class="help">Stable quotes only • DEX allow-list • Outlier ±25%</div>
        <div><label>Manual Scan</label><button class="btn" data-scan="arbitrum">Scan Arbitrum</button></div>
      </div>

      <div class="help" id="route-arbitrum" style="margin-top:6px;"></div>

      <table class="table" style="margin-top:10px">
        <thead><tr><th>Token</th><th>Buy (DEX @ $)</th><th>Sell (DEX @ $)</th><th class="right">Spread %</th><th class="right">Net @ loan</th></tr></thead>
        <tbody id="rows-arbitrum"></tbody>
      </table>
    </div>
  </div>

  <!-- Wallet modal -->
  <div id="walletModal">
    <div class="w-card">
      <header>Connect a wallet</header>
      <div class="w-body">
        <div class="w-item" id="wMetaMask">
          <div class="w-icon" style="background:#fff">
            <svg viewBox="0 0 64 64" width="22" height="22"><path fill="#e4761b" d="M2 2l24 18-4-10zM62 2L38 20l4-10z"/><path fill="#f6851b" d="M10 38l16-4 2 12-2 6L18 50zM54 38l-16-4-2 12 2 6 8-2z"/></svg>
          </div>
          <div><strong>MetaMask</strong><div class="help">EVM (Arbitrum)</div></div>
        </div>
        <div class="w-item" id="wManual">
          <div class="w-icon" style="background:#111;color:#fff;font-weight:800">@</div>
          <div><strong>Manual address</strong><div class="help">Paste wallet address</div></div>
        </div>
      </div>
      <div class="w-foot">
        <button id="walletClose" class="btn ghost">Close</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Error banner ---------- */
(function(){
  const show=(msg,src,line,col,err)=>{
    try{
      const bar=document.getElementById('errbar'); const txt=document.getElementById('errtxt');
      if(!bar||!txt) return false;
      txt.textContent=(err&&err.stack)?err.stack:[msg,src,line+':'+col].filter(Boolean).join(' | ');
      bar.style.display='block';
    }catch(_){}
    return false;
  };
  window.onerror=show;
  window.onunhandledrejection=e=>show('Unhandled promise rejection','','','',e&&(e.reason||e));
})();
</script>

<script>
/* ---------- App (Arbitrum only, with batch) ---------- */
(function(){
  const DS_BASE="https://api.dexscreener.com";
  const PLATFORM_FEE=0.0009; // 0.09%
  const NETWORK="arbitrum";
  const GAS_NATIVE="ETH";
  const ALLOWED=["uniswap","uniswap-v3","sushiswap","camelot","balancer","kyber","kyberswap","curve"];

  const el=id=>document.getElementById(id);
  const fmtUSD=v=>isFinite(v)?`$${Number(v).toLocaleString(undefined,{maximumFractionDigits:6})}`:"—";
  const shortAddr=a=>a ? `${a.slice(0,6)}…${a.slice(-4)}` : "";

  const state={ selected:null, selectedBatch:null, account:null, chainId:null, timer:null };
  const gasState={ gasGwei:null, gasUsd:0, gasNativeUsd:null };

  /* timed fetch helpers */
  async function fetchWithTimeout(url, opts={}, ms=8000){
    const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(), ms);
    try{ return await fetch(url, { ...opts, signal: ctrl.signal }); }
    finally{ clearTimeout(id); }
  }
  async function safeJSON(url, ms=8000){
    const r=await fetchWithTimeout(url, {}, ms).catch(()=>null);
    if(!r || !r.ok) return null;
    try{ return await r.json(); }catch(_){ return null; }
  }

  /* wallet */
  function openWallet(){ document.getElementById('walletModal').style.display='flex'; }
  function closeWallet(){ document.getElementById('walletModal').style.display='none'; }
  async function connectMetaMask(){
    if(!window.ethereum){ alert('MetaMask not detected.'); return; }
    try{
      const accs=await window.ethereum.request({method:'eth_requestAccounts'});
      state.account=accs&&accs[0]||null;
      state.chainId=await window.ethereum.request({method:'eth_chainId'});
      el('connectBtn').textContent=shortAddr(state.account)||'Connect';
      el('connectBtn').classList.add('ghost');
      el('execBtn').disabled=!state.selected;
      el('execAllBtn').disabled=!(state.selectedBatch && state.selectedBatch.routes?.length);
      closeWallet();
    }catch(_){ alert('Connection rejected.'); }
  }
  function connectManual(){
    const addr=prompt('Paste Arbitrum (EVM) address:'); if(!addr) return;
    state.account=addr.trim(); state.chainId='manual';
    el('connectBtn').textContent=shortAddr(state.account);
    el('connectBtn').classList.add('ghost');
    el('execBtn').disabled=!state.selected;
    el('execAllBtn').disabled=!(state.selectedBatch && state.selectedBatch.routes?.length);
    closeWallet();
  }

  /* gas (Arbitrum) */
  const RPC_ARB=["https://rpc.ankr.com/arbitrum","https://arbitrum.llamarpc.com","https://arb1.arbitrum.io/rpc"];
  async function gasSuggestGwei(){
    const payload={jsonrpc:"2.0",id:1,method:"eth_feeHistory",params:[5,"latest",[10,50,90]]};
    for(const url of RPC_ARB){
      try{
        const r=await fetchWithTimeout(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)},9000);
        if(!r||!r.ok) continue;
        const j=await r.json(); const bh=j&&j.result;
        if(!bh?.baseFeePerGas||!bh?.reward) continue;
        const base=parseInt(bh.baseFeePerGas.at(-1),16)/1e9;
        const tip =parseInt((bh.reward.at(-1)||[])[1]||"0x0",16)/1e9;
        return {g:base+tip, base, tip};
      }catch(_){}
    }
    return null;
  }
  async function cgUSD(){
    const j=await safeJSON(`https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd`,10000);
    return j?.ethereum?.usd ?? null;
  }
  async function initGas(){
    const g=await gasSuggestGwei().catch(()=>null);
    const natUsd=await cgUSD().catch(()=>null);
    gasState.gasGwei=g?g.g:null; gasState.gasNativeUsd=natUsd??null;
    const gEl=el('gas-gwei-arbitrum'), note=el('gas-note-arbitrum');
    if(g){ gEl.value=`${g.g.toFixed(1)} Gwei`; note.textContent=`base ${g.base.toFixed(1)} + tip ${g.tip.toFixed(1)} • ETH ≈ ${fmtUSD(natUsd)}`; }
    else{ gEl.value=""; note.textContent="auto gas failed."; }
    calcGasUsd();
  }
  function calcGasUsd(){
    const g=gasState.gasGwei, gl=parseFloat(el('gas-limit-arbitrum').value||"0"), usd=gasState.gasNativeUsd;
    const native=(g>0 && gl>0)?(g*gl)/1e9:0, cost=native*(usd||0);
    gasState.gasUsd=cost;
    el('gas-cost-arbitrum').value=native?`${native.toFixed(6)} ${GAS_NATIVE}`:"";
    el('gas-cost-usd-arbitrum').textContent=native?`≈ ${fmtUSD(cost)}`:"—";
    return cost;
  }

  /* Dexscreener */
  async function dsByToken(addr){ return await safeJSON(`${DS_BASE}/latest/dex/tokens/${addr}`,9000); }

  const TOKENLISTS={
    arbitrum:["https://unpkg.com/@uniswap/default-token-list@latest/build/uniswap-default.tokenlist.json"]
  };
  const SEED={
    arbitrum:["0xaf88d065e77c8cC2239327C5EDb3A432268e5831","0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9","0x82af49447d8a07e3bd95bd0d56f35241523fbab1","0x912CE59144191C1204E64559FE8253a0e49E6548","0xda10009cbd5d07dd0cecc66161fc93d7c9000da1"]
  };
  async function getJSON(url){ const j=await safeJSON(url,10000); if(!j) throw new Error(`GET ${url} failed`); return j; }
  async function loadTokenAddresses(){
    const addrs=new Set(SEED.arbitrum||[]);
    for(const url of (TOKENLISTS.arbitrum||[])){
      try{
        const tl=await getJSON(url);
        for(const t of (tl?.tokens||[])){
          if(!t?.address) continue;
          if(t.chainId==42161) addrs.add(t.address);
        }
      }catch(_){}
    }
    return [...addrs].slice(0,450);
  }

  const MIN_LIQ=25000, MIN_VOL=10000, OUTLIER_BAND=0.25;

  function dropOutliersByMedian(pairs){
    const prices=pairs.map(p=>Number(p.priceUsd)).filter(x=>isFinite(x)&&x>0);
    if(prices.length<3) return pairs;
    prices.sort((a,b)=>a-b);
    const med=prices[Math.floor(prices.length/2)];
    const low=med*(1-OUTLIER_BAND), high=med*(1+OUTLIER_BAND);
    return pairs.filter(p=>{ const pr=Number(p.priceUsd); return isFinite(pr) && pr>=low && pr<=high; });
  }
  function consolidatePerDex(pairs){
    const usable=pairs.filter(p=>{
      const q=(p?.quoteToken?.symbol||"").toUpperCase();
      const dex=(p?.dexId||"").toLowerCase();
      const liq=p?.liquidity?.usd||0, vol=p?.volume?.h24||0;
      const allowed=ALLOWED.some(k=>dex.includes(k));
      return allowed && (q==="USDC"||q==="USDT") && liq>=MIN_LIQ && vol>=MIN_VOL;
    });
    const trimmed=dropOutliersByMedian(usable);
    const byDex=new Map();
    for(const p of trimmed){
      const key=(p?.dexId||"").toLowerCase();
      const liq=p?.liquidity?.usd||0;
      const cur=byDex.get(key);
      if(!cur || liq>(cur.liq||0)) byDex.set(key,{rec:p,liq});
    }
    return [...byDex.values()].map(v=>v.rec)
             .sort((a,b)=>(b?.liquidity?.usd||0)-(a?.liquidity?.usd||0));
  }
  function prettyDexId(p){
    const raw=(p?.dexId||"").toLowerCase();
    const map={uniswap:"Uniswap V3","uniswap-v3":"Uniswap V3",sushiswap:"SushiSwap",camelot:"Camelot",balancer:"Balancer",kyber:"KyberSwap","kyberswap":"KyberSwap",curve:"Curve"};
    for(const k in map){ if(raw.includes(k)) return map[k]; }
    return raw? raw.charAt(0).toUpperCase()+raw.slice(1) : "DEX";
  }

  function appendRow(r){
    const tbody=el('rows-arbitrum');
    const tr=document.createElement('tr');
    const principal=Math.min(100000, Math.max(100, parseFloat(el('loanUsd').value||"1000")));
    const gas=gasState.gasUsd||0;
    const spread=(r.sellPrice-r.buyPrice)/r.buyPrice;
    const gross=principal*spread;
    const fee=principal*PLATFORM_FEE;
    const net=gross-fee-gas;
    tr.className = net>0 ? "pos" : (net>-3 ? "meh" : "neg");
    tr.innerHTML=`<td>${r.base}</td><td>${r.buyDex} @ ${fmtUSD(r.buyPrice)}</td><td>${r.sellDex} @ ${fmtUSD(r.sellPrice)}</td><td class="right">${(spread*100).toFixed(2)}%</td><td class="right">${fmtUSD(net)}</td>`;
    tbody.appendChild(tr);
  }

  async function mapLimit(items,limit,fn,delay=80){
    const out=new Array(items.length); let idx=0;
    async function worker(){
      while(idx<items.length){
        const i=idx++;
        try{ out[i]=await fn(items[i],i); if(delay) await new Promise(r=>setTimeout(r,delay)); }
        catch(_){ out[i]=null; }
      }
    }
    const workers=[]; const n=Math.min(limit,items.length||0);
    for(let k=0;k<n;k++) workers.push(worker());
    await Promise.all(workers);
    return out;
  }

  async function scanArbitrum(){
    const status=el('status-arbitrum'), tbody=el('rows-arbitrum'), route=el('route-arbitrum');
    tbody.innerHTML=""; route.textContent="";
    status.innerHTML=`<span class="spinner"></span> Preparing…`;

    await initGas();

    let addrs=[]; try{ addrs=await loadTokenAddresses(); }catch(_){}
    if(!addrs.length){ status.textContent="Could not load token addresses. Try again."; return; }
    status.innerHTML=`<span class="spinner"></span> Scanning ${addrs.length} tokens…`;

    const out=await mapLimit(addrs,10, async(addr)=>{
      const j=await dsByToken(addr);
      if(!j || !Array.isArray(j.pairs) || !j.pairs.length) return null;
      const onNet=j.pairs.filter(p=>p.chainId===NETWORK);
      const rows=consolidatePerDex(onNet);
      if(rows.length<2) return null;
      let min=Infinity,max=-Infinity,buy=null,sell=null;
      for(const row of rows){
        const pr=Number(row.priceUsd); if(!isFinite(pr)||pr<=0) continue;
        if(pr<min){min=pr;buy=row;} if(pr>max){max=pr;sell=row;}
      }
      if(!buy||!sell||max<=min) return null;
      const base=(buy.baseToken?.symbol)||(sell.baseToken?.symbol)||"";
      return { base, buyDex:prettyDexId(buy), buyPrice:min, sellDex:prettyDexId(sell), sellPrice:max, spread:(max-min)/min };
    }, 60);

    const byToken=new Map();
    out.filter(Boolean).forEach(r=>{
      const cur=byToken.get(r.base);
      if(!cur || r.spread>cur.spread) byToken.set(r.base,r);
    });
    const usable=[...byToken.values()].sort((a,b)=>b.spread-a.spread).slice(0,150);

    status.textContent = usable.length? `Found ${usable.length} opportunities` : "No viable routes with current guards.";
    usable.forEach(r=>appendRow(r));
    if(usable[0]){
      route.innerHTML=`<span class="help"><span class="mono">Top:</span> ${usable[0].base} — Buy ${usable[0].buyDex} @ ${fmtUSD(usable[0].buyPrice)} → Sell ${usable[0].sellDex} @ ${fmtUSD(usable[0].sellPrice)} (${(usable[0].spread*100).toFixed(2)}%)</span>`;
    }

    // reset selections after a new scan
    state.selected = null;
    state.selectedBatch = null;
    el('execBtn').disabled = true;
    el('execAllBtn').disabled = true;
  }

  /* -------- Selection helpers (single & batch) -------- */
  function readRoutesFromTable() {
    const rows = Array.from(document.querySelectorAll('#rows-arbitrum tr'));
    return rows.map(tr=>{
      const tds = tr.querySelectorAll('td');
      if (tds.length < 5) return null;
      const token = tds[0].textContent.trim();
      const buy   = tds[1].textContent.trim();   // "DEX @ $price"
      const sell  = tds[2].textContent.trim();
      const net   = parseFloat(tds[4].textContent.replace(/[,$]/g,''));
      return isFinite(net) ? { token, buy, sell, net } : null;
    }).filter(Boolean);
  }

  function autoSelect(){
    const routes = readRoutesFromTable();
    if(!routes.length){ alert('No routes yet. Click Scan.'); return; }
    let best = routes.reduce((a,b)=> a.net>b.net?a:b);
    if(!best){ alert('No viable routes.'); return; }
    state.selected={ network:'arbitrum', ...best };
    el('route-arbitrum').innerHTML=`<span class="help"><span class="mono">Selected:</span> ${best.token} — ${best.buy} → ${best.sell} • Est. net ${fmtUSD(best.net)}</span>`;
    el('execBtn').disabled=!state.account;
    alert(`Selected:\n${best.token}\n${best.buy} → ${best.sell}\nNet @ loan: ${fmtUSD(best.net)}`);
  }

  function autoSelectAll() {
    const routes = readRoutesFromTable();
    const profitable = routes.filter(r => r.net > 0);
    if (!profitable.length) { alert('No profitable routes yet.'); return; }
    state.selectedBatch = { network:'arbitrum', routes: profitable };
    const total = profitable.reduce((s,r)=>s + r.net, 0);
    el('route-arbitrum').innerHTML =
      `<span class="help"><span class="mono">Selected (batch):</span> ${profitable.length} routes • Est. net ${fmtUSD(total)}</span>`;
    el('execAllBtn').disabled = !state.account;
    alert(`Selected ${profitable.length} profitable routes.\nCombined est. net: ${fmtUSD(total)}\n(Execute All is mock for now)`);
  }

  /* -------- Execute (mock) -------- */
  function randTxId(){ return '0x' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function executeMock(){
    if(!state.account){ alert('Connect wallet (or set manual address) first.'); return; }
    if(!state.selected){ alert('Auto Select a route first.'); return; }
    const txid=randTxId();
    alert(`(Mock) Executed on ARBITRUM\n${state.selected.token}\n${state.selected.buy} → ${state.selected.sell}\nWallet: ${shortAddr(state.account)}\nTxID: ${txid}`);
  }
  function executeAllMock() {
    if (!state.account) { alert('Connect wallet first.'); return; }
    if (!state.selectedBatch || !state.selectedBatch.routes?.length) { alert('Select All Profitable first.'); return; }
    const txid = randTxId();
    const total = state.selectedBatch.routes.reduce((s,r)=>s + r.net, 0);
    const lines = state.selectedBatch.routes.slice(0,10).map(r => `• ${r.token}: ${r.buy} → ${r.sell} (${fmtUSD(r.net)})`);
    const more  = state.selectedBatch.routes.length > 10 ? `\n…and ${state.selectedBatch.routes.length - 10} more` : '';
    alert(`(Mock) Batch Execute on ARBITRUM\nWallet: ${shortAddr(state.account)}\nRoutes: ${state.selectedBatch.routes.length}\nCombined est. net: ${fmtUSD(total)}${more}\n\nSample:\n${lines.join('\n')}\n\nTxID: ${txid}`);
  }

  /* wire UI */
  document.getElementById('scanBtn').addEventListener('click', scanArbitrum);
  document.getElementById('autoBtn').addEventListener('click', autoSelect);
  document.getElementById('autoAllBtn').addEventListener('click', autoSelectAll);
  document.getElementById('execBtn').addEventListener('click', executeMock);
  document.getElementById('execAllBtn').addEventListener('click', executeAllMock);
  document.getElementById('gas-limit-arbitrum').addEventListener('input', calcGasUsd);

  document.getElementById('connectBtn').addEventListener('click', openWallet);
  document.getElementById('walletClose').addEventListener('click', closeWallet);
  document.getElementById('wMetaMask').addEventListener('click', connectMetaMask);
  document.getElementById('wManual').addEventListener('click', connectManual);

  // Auto rescan
  function startAuto(){
    clearInterval(state.timer);
    state.timer=setInterval(()=>{ if(!document.getElementById('autoRescan').checked) return; scanArbitrum(); }, 60000);
  }
  startAuto();

  // initial gas + first scan
  initGas(); scanArbitrum();
})();
</script>
</body>
</html>
