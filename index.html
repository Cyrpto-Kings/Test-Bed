<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Crypto Kings • TestBed (Arbitrum)</title>
<style>
:root{
  --bg:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
  --card:#f9fafb; --ok:#059669; --warn:#b45309; --bad:#e11d48;
  --g1:#2563eb; --g2:#7c3aed;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
header{background:#111;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,#4f46e5,#22c55e);display:grid;place-items:center;font-weight:800}
.container{max-width:1200px;margin:0 auto;padding:16px}
.panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:16px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.hint{color:var(--muted);font-size:12px}
input[type=text],input[type=number]{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-width:160px}
button{border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
.btn-primary{color:#fff;background:linear-gradient(135deg,var(--g1),var(--g2));box-shadow:0 8px 24px rgba(37,99,235,.2)}
.btn-ghost{background:#eef2f7;color:#111}
.btn-mini{padding:6px 10px;border-radius:8px;font-weight:600}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#111}
.toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding-bottom:10px;border-bottom:1px solid var(--line);margin-bottom:10px}
table{width:100%;border-collapse:collapse;table-layout:fixed}
thead th{background:#f3f4f6;border-bottom:1px solid var(--line);padding:10px 12px;color:#374151;font-weight:700}
tbody td{border-bottom:1px solid var(--line);padding:10px 12px;vertical-align:top}
.right{text-align:right}
.mono{font-variant-numeric:tabular-nums}
tr.profit{background:#ecfdf5}
tr.loss{background:#fff1f2}
.ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
.tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;background:#fff}
.logs{background:#0b1220;color:#a7f3d0;border:1px solid #0f1b34;border-radius:12px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;max-height:320px;overflow:auto}
.logs .err{color:#fecaca}
footer{background:#111;color:#ddd;padding:24px}
.foot{max-width:1200px;margin:0 auto;display:grid;gap:18px;grid-template-columns:repeat(4,1fr)}
footer h4{color:#fff;margin:0 0 10px;font-size:16px}
footer ul{list-style:none;margin:0;padding:0}
footer li{margin:6px 0}
@media(max-width:800px){ .foot{grid-template-columns:1fr 1fr} }
@media(max-width:560px){ .foot{grid-template-columns:1fr} }
@media(max-width:720px){
  thead{display:none}
  tbody tr{display:grid;grid-template-columns:1fr 1fr;grid-row-gap:6px;padding:10px 12px}
  tbody td{border:0;padding:0}
  td.sel{grid-column:1/-1;order:-3;margin-bottom:4px}
  td.tok{grid-column:1/-1;font-weight:700;order:-2}
  td.flags{grid-column:1/-1;order:-1;margin-top:6px}
  .cell{display:flex;justify-content:space-between;gap:8px}
  .lbl{color:#6b7280;font-size:12px;margin-right:8px}
  .val{text-align:right}
  .toolbar .btn-primary,.toolbar .btn-ghost{width:100%}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">CK</div>
    <div>
      <div style="font-weight:800;line-height:1">Crypto Kings</div>
      <div class="hint">Arbitrum Scanner</div>
    </div>
  </div>
  <button id="connectBtn" class="btn-ghost">Connect Wallet</button>
</header>

<div class="container">
  <!-- Contract Settings -->
  <div class="panel">
    <div style="font-weight:700;margin-bottom:8px">Contract Settings</div>
    <div class="row">
      <input id="execContract" type="text" placeholder="Executor contract address (0x…)" style="min-width:360px" value="0x43327acEAd76dCD48A09cc93A509a2FE7b1f0f5c"/>
      <input id="feeWallet" type="text" placeholder="Profit wallet (0x…)" style="min-width:320px"/>
      <input id="payoutWalletB" type="text" placeholder="2nd profit wallet (optional)" style="min-width:320px"/>
      <input id="splitPctB" type="number" min="0" max="100" step="1" value="0" title="% of profit to wallet B"/>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="hint">Loan target ($):</label>
      <input id="loanUsd" type="number" min="50" step="10" value="500" title="Desired notional per probe in USD"/>
      <input id="wethAmt" type="number" min="0.00001" step="0.00001" value="0.20" title="Computed WETH (auto)"/>
      <button id="fundBtn" class="btn-ghost" title="Wrap tiny ETH→WETH and send premium">Fund Premium</button>
      <button id="flashBtn" class="btn-primary">Start Flash Loan (WETH)</button>
    </div>
    <div class="chips">
      <span class="pill" id="rpcPill">RPC: —</span>
      <span class="pill" id="tokensPill">Tokens: —</span>
      <span class="pill" id="gasPill">Gas: —</span>
      <span class="pill" id="ethPill">ETH: —</span>
      <span class="pill" id="progPill">Idle.</span>
    </div>
  </div>

  <!-- Scan Panel -->
  <div class="panel">
    <div class="row">
      <label class="hint">Scan count:</label>
      <input id="batch" type="number" min="30" max="300" step="10" value="120" title="How many tokens to scan"/>
      <label class="hint">Concurrency:</label>
      <input id="concur" type="number" min="5" max="30" step="1" value="15" title="How many tokens in parallel"/>
      <label class="hint"><input id="useV3" type="checkbox"/> Include UniV3</label>
      <label class="hint"><input id="onlyProfitable" type="checkbox" checked/> Only profitable</label>
      <label class="hint">Min P/L ($):</label>
      <input id="minProfitUsd" type="number" step="0.01" value="0"/>
      <button id="scanBtn" class="btn-primary" style="margin-left:auto">Scan</button>
      <button id="stopBtn" class="btn-ghost">Stop</button>
    </div>
  </div>

  <!-- Results Panel -->
  <div class="panel">
    <div class="toolbar">
      <button id="selectProfitable" class="btn-ghost">Select all profitable</button>
      <button id="clearSel" class="btn-ghost">Clear</button>
      <span id="selTotal" class="pill">++$0</span>
      <button id="execSelected" class="btn-primary" style="margin-left:auto">Execute Selected</button>
    </div>
    <table id="results">
      <thead>
        <tr>
          <th style="width:42px">Select</th>
          <th>Token</th>
          <th>Buy (DEX @ $)</th>
          <th>Sell (DEX @ $)</th>
          <th class="right">Spread %</th>
          <th class="right">USDC Back</th>
          <th class="right">Net P/L</th>
          <th>Executable?</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- Logs Panel -->
  <div class="panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div style="font-weight:700">Details / Logs</div>
      <div class="row">
        <button id="selfTestBtn" class="btn-mini btn-ghost" title="Run boot checks again">Run Self-Test</button>
        <button id="copyLogBtn" class="btn-mini btn-ghost" title="Copy full log to clipboard">Copy Log</button>
        <button id="downloadLogBtn" class="btn-mini btn-ghost" title="Download log as .txt">Download Log</button>
        <button id="summarizeLogBtn" class="btn-mini btn-ghost" title="Show error summary">Summarize Errors</button>
        <button id="clearLogBtn" class="btn-mini btn-ghost" title="Clear the log">Clear</button>
      </div>
    </div>
    <div id="log" class="logs">[boot] waiting…</div>
  </div>
</div>

<footer>
  <div class="foot">
    <div><h4>Crypto Kings</h4><ul><li>Arbitrage Scanner</li><li>DeFi Tools</li><li>Risk Analysis</li></ul></div>
    <div><h4>Company</h4><ul><li>Who we are</li><li>What we do</li><li>Connect with us</li></ul></div>
    <div><h4>Resources</h4><ul><li>Docs</li><li>Blog</li><li>Support</li></ul></div>
    <div><h4>Legal</h4><ul><li>Privacy</li><li>Terms</li><li>Disclaimer</li></ul></div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
/* ========== Lightweight logger + error buckets ========== */
const buckets=new Map();
const logEl=()=>document.getElementById('log');
function log(s, cls){ const L=logEl(); if(!L) return; const line=(cls?`<span class="${cls}">${s}</span>`:s); L.innerHTML+=(line.endsWith("\\n")?line:line+"\\n"); L.scrollTop=L.scrollHeight; }
function buckAdd(e){
  const msg=((e&&(e.message||e.reason||e.name||""))+"").slice(0,220);
  const b=buckets.get(msg)||{c:0}; b.c++; buckets.set(msg,b);
}
window.addEventListener('error',e=>{buckAdd(e);});
window.addEventListener('unhandledrejection',e=>{buckAdd(e.reason||e);});
document.getElementById('summarizeLogBtn').onclick=()=>{ 
  if(!buckets.size){ log("[summary] no errors captured"); return; }
  log("[summary] top errors:");
  [...buckets.entries()].sort((a,b)=>b[1].c-a[1].c).slice(0,30).forEach(([k,v])=>log(\`  • \${v.c}× \${k}\`));
};
document.getElementById('copyLogBtn').onclick=async()=>{ try{ await navigator.clipboard.writeText(logEl().innerText||""); alert("Log copied."); }catch{} };
document.getElementById('downloadLogBtn').onclick=()=>{ const b=new Blob([logEl().innerText||""],{type:"text/plain"}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u;a.download=\`ck-log-\${Date.now()}.txt\`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);};
document.getElementById('clearLogBtn').onclick=()=>{ logEl().innerHTML=""; };

/* ========== Helpers: safe fetch with timeout & JSON ========== */
function safeFetch(url, opts={}, timeoutMs=3000){
  return Promise.race([
    fetch(url, opts),
    new Promise((_,rej)=>setTimeout(()=>rej(new Error("fetch-timeout:"+url)), timeoutMs))
  ]);
}
async function safeJson(url, opts={}, timeoutMs=3000, fallback=null){
  try{
    const r=await safeFetch(url, opts, timeoutMs);
    if(!r.ok) throw new Error("http-"+r.status);
    return await r.json();
  }catch(e){ buckAdd(e); return fallback; }
}

/* ========== CONFIG ========== */
const ARBITRUM_CHAIN_ID_DEC=42161, ARBITRUM_CHAIN_ID_HEX="0xa4b1";
const RPC_URL="https://arb-mainnet.g.alchemy.com/v2/h4YaGX9cc_WywAx5cvsez";
let READ_PROVIDER = new ethers.providers.JsonRpcProvider(RPC_URL);

// assets & routers
const WETH="0x82af49447d8a07e3bd95bd0d56f35241523fbab1".toLowerCase();
const USDC="0xaf88d065e77c8cc2239327c5edb3a432268e5831".toLowerCase();
const USDCe="0xff970a61a04b1ca14834a43f5de4533ebddb5cc8".toLowerCase();
const ROUTER_SUSHI_V2="0x1b02da8cb0d097eb8d57a175b88c7d8b47997506";
const ROUTER_CAMELOT_V2="0xc873fecbd354f5a56e00e710b90ef4201db2448d";
const UNIV3_QUOTER="0x61fFE014bA17989E743c5F6cB21bF9697530B21e";

// fees & runtime
const DEX_FEE_PCT=0.003, SLIP_PCT=0.0015, FLASH_PCT=0.0005;
const GAS_LIMIT=380000;
let   GAS_GWEI=0.12;
const CALL_TIMEOUT_MS=1500;   // per call
const TOKEN_BUDGET_MS=5000;   // per token

// abis
const V2_ABI=["function getAmountsOut(uint amountIn, address[] calldata path) view returns (uint[] memory amounts)"];
const V3_QUOTER_ABI=[
 "function quoteExactInputSingle((address tokenIn,address tokenOut,uint24 fee,uint256 amountIn,uint160 sqrtPriceLimitX96)) external returns (uint256 amountOut)"
];

/* ========== UI helpers ========== */
const $=s=>document.querySelector(s); const tbody=$("#tbody");
function usd(n){ return Number(n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}); }
function addr(a){ return (a||"").toLowerCase(); }
function estGasWei(){ const gp=ethers.utils.parseUnits(String(GAS_GWEI||0.12),"gwei"); return gp.mul(GAS_LIMIT); }
function feesWei(x){ const pct=(DEX_FEE_PCT+SLIP_PCT)*2 + FLASH_PCT; const ppm=Math.floor(pct*1e6); return x.mul(ppm).div(1e6); }

/* ========== wallet (MetaMask/Trust) ========== */
let __provider,__signer,__account;
function getInjected(){
  const eth=window.ethereum; if(!eth) return null;
  if(eth.providers&&Array.isArray(eth.providers)){
    const mm=eth.providers.find(p=>p.isMetaMask);
    const tw=eth.providers.find(p=>p.isTrust||p.isTrustWallet);
    return mm||tw||eth.providers[0];
  }
  return eth;
}
async function connectWallet(){
  const inj=getInjected(); if(!inj){ alert("Install MetaMask or Trust Wallet"); return; }
  __provider=new ethers.providers.Web3Provider(inj,"any");
  await __provider.send("eth_requestAccounts",[]);
  const net=await __provider.getNetwork();
  if(Number(net.chainId)!==ARBITRUM_CHAIN_ID_DEC){
    try{ await __provider.send("wallet_switchEthereumChain",[{chainId:ARBITRUM_CHAIN_ID_HEX}]); }
    catch(e){ throw new Error("Switch to Arbitrum One"); }
  }
  __signer=__provider.getSigner(); __account=await __signer.getAddress();
  $("#rpcPill").textContent="RPC: Alchemy"; log("wallet: "+__account);
  const feeBox=$("#feeWallet"); if(feeBox) feeBox.value=__account;
}
document.getElementById("connectBtn").onclick=()=>connectWallet();

/* ========== gas/eth price with fallbacks ========== */
let ETH_USD=null;
async function fetchEthUsd(){
  const j=await safeJson("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd",{},3000,null);
  ETH_USD=Number(j?.ethereum?.usd)||2500;
  $("#ethPill").textContent="ETH: "+ (j? usd(ETH_USD):"(fallback)");
}
async function fetchGasGwei(){
  try{
    const body={jsonrpc:"2.0",id:1,method:"eth_gasPrice",params:[]};
    const r=await safeFetch(RPC_URL,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(body)},3000);
    const j=await r.json(); const wei=parseInt(j?.result||"0x0",16);
    GAS_GWEI=wei? (wei/1e9):0.12;
    $("#gasPill").textContent="Gas: "+GAS_GWEI.toFixed(2)+" gwei";
  }catch(_){ $("#gasPill").textContent="Gas: (fallback)"; GAS_GWEI=0.12; }
}

/* ========== token set (static + auto-discover) ========== */
const STATIC_TOKENS={
  WETH, WBTC:"0x2f2a2543b76a4166549f7aab2e75bef0aefc5b0f", USDC, USDCe,
  USDT:"0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",
  DAI:"0xda10009cbd5d07dd0cecc66161fc93d7c9000da1",
  ARB:"0x912ce59144191c1204e64559fe8253a0e49e6548",
  LINK:"0xf97f4df75117a78c1a5a0dbb814af92458539fb4",
  GMX:"0xfc5a1a6eb076a2c7ad06ed22c90d7e710e35ad0a",
  AAVE:"0xba5dd0aba5b2c9f812b76ea2f6c2c5a92f76e8b7",
  RDNT:"0x0c4681e6c0235179ec3d4f4fc4df3d14fdd96017",
  PENDLE:"0x0c880f6761f1af8d9aa9c466984b80dab9a8c9e8",
  FRAX:"0x17fc002b466eec40dae837fc4be5c67993ddbd6f",
  CRV:"0x11cdb42b0eb46d95f990bedd4695a6e3fa034978",
  BAL:"0x040d1edc9569d4bab2d15287dc5a4f10f56a56b8",
  UNI:"0xfa7f8980b0f1e64a2062791cc3b0871572f1f7f0",
  wstETH:"0x5979d7b546e38e414f7e9822514be443a4800529",
  SNX:"0xb9f747162ab1e95d07361f9048bcdf943f76d1e4",
  COMP:"0x354a6da3fcde098f8389cad84b0182725c6c91de",
  YFI:"0x82e64f49ed5ec1b2a7c5f7f3e8a1c09b5536a21d",
  SUSHI:"0xd4d42f0b6def4ce0383636770a832df0a4c82bba",
  LUSD:"0x93b346b6bc2548da6a1e7d98e9a4219436829d2d",
  MAGIC:"0x539bde0d7dbd336b79148aa742883198bbf60342",
  GRT:"0x23a941036ae778ac51ab04cea08ed6e2fe103614",
  DPX:"0x6c2c066cfd6a5d39b2abc4d3a63180ab15f23e2e",
  RDPX:"0x32eb7902d4134bf98a28b963d26de779af92a212",
  GRAIL:"0x3d9907f9a368ad0a51be60f7da3b97cf940982d8",
  JOE:"0x6e2bbf01dcad2e37f9b924b7e0e1f8f6a6f6282d",
};
function toSymbolList(obj){ return Object.keys(obj); }
async function autoDiscoverSymbols(limit){
  const out=new Map();
  const j=await safeJson("https://api.dexscreener.com/latest/dex/search?q=arbitrum%20usdc",{},3500,null);
  (j?.pairs||[]).filter(p=>p.chainId==="arbitrum").forEach(p=>{
    const sym=(p?.baseToken?.symbol||"").toUpperCase();
    const addrx=(p?.baseToken?.address||"").toLowerCase();
    if(/^0x[a-f0-9]{40}$/.test(addrx) && sym && addrx!==WETH) out.set(sym,addrx);
  });
  const picks=[...out.entries()].slice(0,limit);
  const obj={}; picks.forEach(([s,a])=>obj[s]=a);
  return obj;
}

/* ========== quoting (with guards/timeouts) ========== */
function validPath(path){
  if(!Array.isArray(path) || path.length<2) return false;
  for(let i=0;i<path.length-1;i++){ if(addr(path[i])===addr(path[i+1])) return false; }
  return true;
}
function buildV2Paths(token){
  const stables=[USDC,USDCe];
  const base=[[WETH, token]];
  for(const s of stables){
    if(addr(token)===addr(s)) continue; // avoid ...USDC,USDC
    base.push([WETH, s, token]);
  }
  return base.filter(validPath);
}
function withTimeout(promise, ms, tag="timeout"){
  return Promise.race([
    promise,
    new Promise((_,rej)=>setTimeout(()=>rej(new Error(tag)), ms))
  ]);
}
async function v2GetOut(amountWei, path, routerAddr){
  const c=new ethers.Contract(routerAddr,V2_ABI,READ_PROVIDER);
  const call=c.getAmountsOut(amountWei,path);
  return withTimeout(call, CALL_TIMEOUT_MS, "timeout v2");
}
async function v3Quote(tokenIn,tokenOut,fee,amt){
  try{
    const iface=new ethers.utils.Interface(V3_QUOTER_ABI);
    const data=iface.encodeFunctionData("quoteExactInputSingle",[{tokenIn:addr(tokenIn),tokenOut:addr(tokenOut),fee,amountIn:amt,sqrtPriceLimitX96:0}]);
    const raw=await withTimeout(READ_PROVIDER.call({to:UNIV3_QUOTER,data}), CALL_TIMEOUT_MS, "timeout v3");
    const [amountOut]=iface.decodeFunctionResult("quoteExactInputSingle",raw);
    return amountOut;
  }catch(e){ buckAdd(e); throw e; } // soft-fail counted, not spammed
}
async function quoteRoundTripAllDexes(amountWei, token, includeV3=false){
  const rows=[];
  if(addr(token)===WETH) return rows;
  // v2 combos, sanitized paths
  const paths=buildV2Paths(token);
  const combos=[
    {buy:"SUSHI v2", buyAddr:ROUTER_SUSHI_V2, sell:"CAMELOT v2", sellAddr:ROUTER_CAMELOT_V2},
    {buy:"CAMELOT v2", buyAddr:ROUTER_CAMELOT_V2, sell:"SUSHI v2", sellAddr:ROUTER_SUSHI_V2}
  ];
  for(const c of combos){
    for(const p of paths){
      try{
        const buyOut=await v2GetOut(amountWei,p,c.buyAddr);
        const mid=buyOut[buyOut.length-1]; if(mid.isZero()) continue;
        const sellPath=[...p].reverse();
        const sellOut=await v2GetOut(mid,sellPath,c.sellAddr);
        const back=sellOut[sellOut.length-1];
        rows.push({buyDex:c.buy, sellDex:c.sell, backWei:back, ok:true, buyMid:mid, amountWei});
      }catch(_){ /* skip quietly */ }
    }
  }
  if(includeV3){
    for(const f of [500,3000,10000]){
      try{
        const mid=await v3Quote(WETH,token,f,amountWei);
        if(!mid || mid.isZero()) continue;
        const back=await v3Quote(token,WETH,f,mid);
        rows.push({buyDex:`UniV3 ${f/10000}%`, sellDex:`UniV3 ${f/10000}%`, backWei:back, ok:true, buyMid:mid, amountWei});
      }catch(_){ /* skip */ }
    }
  }
  return rows;
}

/* ========== profit & rendering ========== */
async function weiToUsdc(wei){
  try{
    const out=await v2GetOut(wei,[WETH,USDC],ROUTER_SUSHI_V2);
    return Number(ethers.utils.formatUnits(out[out.length-1],6));
  }catch(_){ return 0; }
}
function renderRows(rows){
  const onlyProf=!!document.getElementById('onlyProfitable').checked;
  const minUsd=Number(document.getElementById('minProfitUsd').value||0);
  rows.forEach(r=>{ r.netPLUsd = ETH_USD ? Number(ethers.utils.formatUnits(r.netPLWei,18))*ETH_USD : 0; });
  let view=rows;
  if(onlyProf) view=view.filter(r=>r.netPLUsd>0 && r.netPLUsd>=minUsd);
  view.sort((a,b)=>(b.netPLUsd||-1e99)-(a.netPLUsd||-1e99));

  const tbody=document.getElementById("tbody"); tbody.innerHTML="";
  for(const r of view){
    const spreadPct=((Number(ethers.utils.formatUnits(r.backWei,18))/Number(ethers.utils.formatUnits(r.amountWei,18)))-1)*100;
    const tr=document.createElement("tr");
    tr.className=r.netPLUsd>0?"profit":"loss";
    tr.dataset.netpl=r.netPLUsd;
    tr.dataset.token=r.tokenSym;
    tr.dataset.tokenAddr=r.tokenAddr||"";
    tr.dataset.buyDex=r.buyDex; tr.dataset.sellDex=r.sellDex;
    tr.innerHTML=`
      <td class="sel"><input type="checkbox" class="pick" ${r.netPLUsd>0?"checked":""}></td>
      <td class="tok">${r.tokenSym}</td>
      <td><div class="cell"><span class="lbl">Buy</span><span class="val">${r.buyDex}</span></div></td>
      <td><div class="cell"><span class="lbl">Sell</span><span class="val">${r.sellDex}</span></div></td>
      <td class="right mono">${Number.isFinite(spreadPct)?spreadPct.toFixed(2):"—"}%</td>
      <td class="right mono">${usd(r.usdcBack||0)}</td>
      <td class="right mono ${r.netPLUsd>0?'ok':'bad'}">${(r.netPLUsd>=0?'+':'-')+usd(Math.abs(r.netPLUsd)).replace('$','')}</td>
      <td class="flags"><span class="tag ${r.netPLUsd>0?'ok':'warn'}">${r.ok?'Router-verified':'—'}</span></td>
    `;
    tbody.appendChild(tr);
  }
  updateSelectedTotal();
}
function updateSelectedTotal(){
  let sum=0; document.querySelectorAll("#tbody .pick:checked").forEach(cb=>{ const tr=cb.closest("tr"); sum+=Number(tr.dataset.netpl||0); });
  document.getElementById("selTotal").textContent=(sum>=0?'++$':'−$')+Math.abs(sum).toLocaleString(undefined,{maximumFractionDigits:2});
}
document.getElementById("results").addEventListener("change",e=>{ if(e.target.classList.contains("pick")) updateSelectedTotal(); });

/* ========== probe sizing ($ → WETH) ========== */
async function computeProbeWei(){
  const usdTarget=Number(document.getElementById("loanUsd").value||500);
  try{
    const out=await v2GetOut(ethers.utils.parseEther("1"),[WETH,USDC],ROUTER_SUSHI_V2);
    const ethPrice=Number(ethers.utils.formatUnits(out[out.length-1],6)); // USDC per 1 WETH
    const weth=usdTarget/ethPrice;
    document.getElementById("wethAmt").value = Number(weth).toFixed(6);
    return ethers.utils.parseEther(String(weth));
  }catch(_){
    const ethPrice=ETH_USD||2500; const weth=usdTarget/ethPrice;
    document.getElementById("wethAmt").value = Number(weth).toFixed(6);
    return ethers.utils.parseEther(String(weth));
  }
}

/* ========== per-token scan ========== */
async function scanToken(sym, amountWei, includeV3){
  const tAddr=(STATIC_TOKENS[sym]||"").toLowerCase();
  if(!/^0x[a-f0-9]{40}$/.test(tAddr) || tAddr===WETH) return [];
  try{
    const routes=await quoteRoundTripAllDexes(amountWei,tAddr,includeV3);
    const gasWei=estGasWei(); const feeWei=feesWei(amountWei);
    const rows=[];
    for(const r of routes){
      const backWei=r.backWei;
      const netBack=backWei.sub(feeWei).sub(gasWei);
      const netPL=netBack.sub(amountWei);
      const usdcBack=await weiToUsdc(backWei).catch(()=>0);
      rows.push({tokenSym:sym, tokenAddr:tAddr, buyDex:r.buyDex, sellDex:r.sellDex, usdcBack, netPLWei:netPL, ok:r.ok, backWei, amountWei});
    }
    return rows;
  }catch(e){ buckAdd(e); return []; }
}

/* ========== parallel scan orchestrator ========== */
let scanning=false, stopFlag=false;
async function runScan(){
  if(scanning) return; scanning=true; stopFlag=false;
  try{
    log("[scan] starting…");
    await Promise.all([fetchEthUsd(),fetchGasGwei()]);
    const probeWei=await computeProbeWei();

    const want = Number(document.getElementById("batch").value||120);
    let symbols = toSymbolList(STATIC_TOKENS).slice(0, want);
    document.getElementById("tokensPill").textContent="Tokens: "+symbols.length;

    const includeV3 = !!document.getElementById("useV3").checked;
    const concur = Math.max(5, Math.min(30, Number(document.getElementById("concur").value||15)));

    log(\`[scan] tokens=\${symbols.length} • concurrency=\${concur} • probe=\${ethers.utils.formatUnits(probeWei,18)} WETH (~$\${document.getElementById("loanUsd").value})\`);

    const allRows=[]; let done=0;
    async function worker(queue){
      while(queue.length && !stopFlag){
        const sym = queue.shift();
        document.getElementById("progPill").textContent=\`Scanning \${done+1}/\${symbols.length} — \${sym}\`;
        const started=Date.now();
        const rows = await Promise.race([
          scanToken(sym, probeWei, includeV3),
          new Promise(res=>setTimeout(()=>res([]), TOKEN_BUDGET_MS))
        ]);
        allRows.push(...rows);
        done++;
        const dur=Date.now()-started;
        if(dur> TOKEN_BUDGET_MS) buckAdd(new Error("token-budget "+sym));
      }
    }
    const queue=[...symbols];
    const workers=Array.from({length:concur},()=>worker(queue));
    await Promise.all(workers);

    allRows.forEach(r=>{ r.netPLUsd = ETH_USD ? Number(ethers.utils.formatUnits(r.netPLWei,18))*ETH_USD : 0; });
    renderRows(allRows);
    const greens=allRows.filter(r=>r.netPLUsd>0).length;
    document.getElementById("progPill").textContent=\`Done. Green=\${greens} / Rows=\${allRows.length}.\`;
  }catch(e){
    log("SCAN FATAL: "+(e?.message||e),"err");
  }finally{
    scanning=false;
  }
}
document.getElementById("scanBtn").onclick=runScan;
document.getElementById("stopBtn").onclick=()=>{ stopFlag=true; document.getElementById("progPill").textContent="Stopped."; };
document.getElementById("selectProfitable").onclick=()=>{
  document.querySelectorAll("#tbody tr").forEach(tr=>{
    const cb=tr.querySelector(".pick");
    if(cb) cb.checked = (Number(tr.dataset.netpl||-1e99)>0);
  });
  updateSelectedTotal();
};
document.getElementById("clearSel").onclick=()=>{ document.querySelectorAll("#tbody .pick").forEach(cb=>cb.checked=false); updateSelectedTotal(); };
document.getElementById("execSelected").onclick=()=>{ alert("Execution wiring unchanged in this build.\nScan first and pick a single row."); };

/* ========== HARDENED BOOT FLOW ========== */
let __booted=false;
async function boot(){
  if(__booted) return; __booted=true;
  try{
    logEl().innerHTML="[boot] starting…\n";
    document.getElementById("rpcPill").textContent="RPC: Alchemy";
    document.getElementById("tokensPill").textContent="Tokens: "+toSymbolList(STATIC_TOKENS).length;

    await Promise.all([fetchEthUsd(),fetchGasGwei()]);

    // auto-discover (soft-fail, no stall)
    const extra = await autoDiscoverSymbols(180).catch(()=> ({}));
    if(extra && typeof extra==="object") Object.assign(STATIC_TOKENS, extra);
    document.getElementById("tokensPill").textContent="Tokens: "+toSymbolList(STATIC_TOKENS).length;

    await computeProbeWei();
    log("[self-test] OK. Click Scan.");
  }catch(e){
    buckAdd(e);
    log("[boot] FAILED: "+(e?.message||e),"err");
  }
}
document.getElementById("selfTestBtn").onclick=boot;
// Triple trigger: DOMContentLoaded, window.load, and a fallback timer
document.addEventListener("DOMContentLoaded", ()=>boot().catch(e=>log("boot DCL err: "+(e?.message||e),"err")));
window.addEventListener("load", ()=>boot().catch(e=>log("boot load err: "+(e?.message||e),"err")));
setTimeout(()=>{ if(!__booted) boot().catch(e=>log("boot timer err: "+(e?.message||e),"err")); }, 300);
</script>
</body>
</html>
