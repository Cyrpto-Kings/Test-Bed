<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Kings</title>
  <meta name="description" content="Flash‑loan arbitrage simulator with live pricing and two‑leg quotes." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b0d12; --panel:#121623; --ink:#e8eef9; --muted:#98a2b3; --brand:#7c5cff; --accent:#1d9bf0; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --ring:rgba(124,92,255,.35);}    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:radial-gradient(1200px 600px at 100% -10%, rgba(124,92,255,.08), transparent),
    radial-gradient(900px 500px at -10% 110%, rgba(29,155,240,.08), transparent), var(--bg); color:var(--ink)}
    .wrap{max-width:1100px; margin:0 auto; padding:32px 20px 80px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:24px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:42px;height:42px; border-radius:12px; background:linear-gradient(135deg, var(--brand), var(--accent)); display:grid; place-items:center; box-shadow:0 10px 30px rgba(124,92,255,.35)}
    .logo span{font-weight:800; font-size:18px}
    h1{margin:0; font-size:clamp(20px, 2.6vw, 32px)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:8px}
    select, input[type="text"], input[type="email"], input[type="number"]{width:100%; padding:12px 14px; border:1px solid rgba(255,255,255,.15); background:#0f1320; color:var(--ink); border-radius:12px; outline:none; transition:border .2s, box-shadow .2s}
    select:focus, input:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring)}
    .row{display:grid; grid-template-columns:1fr; gap:16px}
    @media (min-width:760px){ .row-3{grid-template-columns:repeat(3, 1fr)} .row-2{grid-template-columns:repeat(2, 1fr)} .row-4{grid-template-columns:repeat(4, 1fr)} }
    .help{font-size:12px; color:var(--muted); margin-top:6px}
    .cta{display:flex; gap:12px; align-items:center; margin-top:18px; flex-wrap:wrap}
    button{appearance:none; border:none; background:linear-gradient(135deg, var(--brand), var(--accent)); color:#fff; padding:14px 18px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:0 10px 24px rgba(124,92,255,.35); transition:transform .08s ease}
    button:active{transform:translateY(1px)}
    .ghost{background:transparent; border:1px solid rgba(255,255,255,.18); color:var(--ink); box-shadow:none}
    .danger{background:linear-gradient(135deg, var(--danger), #b91c1c)}
    footer{margin-top:30px; color:var(--muted); font-size:12px}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(124,92,255,.15); color:#cfd7ff; font-size:12px; font-weight:600}
    .inline{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .out{white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0e1220; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08)}
    .hidden{display:none !important}
    .rs{display:flex; align-items:center; gap:8px}
    .switch{display:flex; align-items:center; gap:8px}
    .bar{height:10px; border-radius:999px; background:rgba(255,255,255,.12); overflow:hidden}
    .bar > span{display:block; height:100%}
    .good{background:linear-gradient(90deg, var(--ok), #16a34a)}
    .bad{background:linear-gradient(90deg, var(--danger), #ef4444)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>CK</span></div>
        <div>
          <h1>Crypto Kings</h1>
          <div class="inline">
            <span class="pill">Flash‑Loan Arbitrage Made Simple</span>
          </div>
        </div>
      </div>
    </header>

    <form id="testbedForm" class="card" autocomplete="on">
      <!-- Global controls -->
      <div class="row row-3">
        <div>
          <label for="network">Network</label>
          <select id="network" name="network" required onchange="window.__ck_refreshForNetwork && window.__ck_refreshForNetwork()">
            <option value="" disabled selected>Select a network</option>
            <option value="ethereum">Ethereum</option>
            <option value="arbitrum">Arbitrum</option>
            <option value="polygon">Polygon</option>
            <option value="bsc">BSC</option>
            <option value="avalanche">Avalanche</option>
            <option value="solana">Solana</option>
          </select>
          <div class="help">Determines available platforms, DEXes and gas model.</div>
        </div>
        <div>
          <label for="token">Field 2 — Desired Token</label>
          <select id="token" name="token" required>
            <option value="" disabled selected>Select a token</option>
            <option>WETH</option>
            <option>WBTC</option>
            <option>USDC</option>
            <option>USDT</option>
            <option>DAI</option>
            <option>SOL</option>
            <option>WBNB</option>
            <option>MATIC</option>
            <option>ARB</option>
            <option>OP</option>
            <option>Other / Custom</option>
          </select>
        </div>
        <div>
          <label for="loanAmount">Field 0 — Loan Amount</label>
          <div class="rs">
            <input type="number" id="loanAmount" name="loanAmount" min="0" step="any" placeholder="e.g., 1000" required />
            <span id="loanTokenSymbol" class="help"></span>
          </div>
          <div class="help">Amount to borrow (USDC base for quotes).</div>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label for="tokenAddress">Token Contract / Mint Address</label>
          <input type="text" id="tokenAddress" placeholder="0x… (EVM) or mint (Solana)">
          <div class="help">Auto-fills for common tokens. Used for prices & quotes.</div>
        </div>
        <div>
          <label for="platform">Field 1 — Flash Loan Platform</label>
          <select id="platform" name="platform" required>
            <option value="" disabled selected>Select…</option>
          </select>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label for="buyDex">Field 3 — Purchase From DEX</label>
          <select id="buyDex" name="buyDex" required>
            <option value="" disabled selected>Select…</option>
          </select>
        </div>
        <div>
          <label for="sellDex">Field 4 — Sell To DEX</label>
          <select id="sellDex" name="sellDex" required>
            <option value="" disabled selected>Select…</option>
          </select>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label for="rewardWallet">Field 5 — Wallet Address for Reward</label>
          <input type="text" id="rewardWallet" name="rewardWallet" placeholder="0x… or Solana address" required/>
          <input type="text" id="rewardWalletConfirm" placeholder="Confirm reward wallet" />
        </div>
        <div>
          <label for="feeWallet">Field 6 — Wallet Address for Fees</label>
          <input type="text" id="feeWallet" name="feeWallet" placeholder="0x… or Solana address" required/>
          <input type="text" id="feeWalletConfirm" placeholder="Confirm fee wallet" />
        </div>
      </div>

      <div class="row row-4">
        <div id="gasPriceWrap">
          <label for="gasPrice">Field 7 — Gas Price (Gwei)</label>
          <input type="number" id="gasPrice" name="gasPrice" min="0" step="0.1" placeholder="e.g., 20">
        </div>
        <div id="gasLimitWrap">
          <label for="gasLimit">Gas Limit (units)</label>
          <input type="number" id="gasLimit" name="gasLimit" min="0" step="1000" placeholder="e.g., 300000">
        </div>
        <div id="gasFeeWrap">
          <label for="gasFeeEth">Estimated Gas Fee (ETH)</label>
          <input type="text" id="gasFeeEth" name="gasFeeEth" placeholder="Auto‑calculated" readonly>
          <div class="help">(gasPrice × gasLimit) ÷ 1e9</div>
        </div>
        <div>
          <label for="maxGasEth">Max Gas Spend (ETH)</label>
          <input type="number" id="maxGasEth" name="maxGasEth" min="0" step="any" placeholder="e.g., 0.02">
        </div>
      </div>

      <div class="row row-3">
        <div>
          <label for="slippage">Slippage Tolerance (%)</label>
          <input type="number" id="slippage" name="slippage" min="0" step="0.1" placeholder="e.g., 0.5">
        </div>
        <div>
          <label for="minProfitToken">Min Profit Threshold (Token)</label>
          <input type="number" id="minProfitToken" name="minProfitToken" min="0" step="any" placeholder="e.g., 5">
        </div>
        <div>
          <label for="minProfitGBP">Min Profit Threshold (£)</label>
          <input type="number" id="minProfitGBP" name="minProfitGBP" min="0" step="any" placeholder="e.g., 25">
        </div>
      </div>

      <div class="row row-3">
        <div>
          <label for="email">Notification Email</label>
          <input type="email" id="email" name="email" placeholder="you@example.com" required>
        </div>
        <div>
          <label for="submitMode">Submission Mode</label>
          <select id="submitMode">
            <option value="mailto" selected>Email (mailto)</option>
            <option value="json">Download JSON only</option>
          </select>
        </div>
        <div class="switch">
          <label for="agree">Terms & Disclaimer</label>
          <input type="checkbox" id="agree"> <span class="help">I understand this is a UI demo; no on‑chain execution.</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="notes">Route Notes (optional)</label>
          <input type="text" id="notes" name="notes" placeholder="Any custom parameters or remarks"/>
        </div>
      </div>

      <div class="cta">
        <button id="simulateBtn" type="button">Simulate</button>
        <button id="processBtn" type="submit">Process Trade</button>
        <button id="copyJsonBtn" class="ghost" type="button">Copy JSON</button>
        <button id="downloadJsonBtn" class="ghost" type="button">Download JSON</button>
        <button class="ghost danger" type="reset">Reset</button>
      </div>

      <div id="validation" class="help" style="margin-top:10px"></div>
    </form>

    <footer>
      <p><strong>Disclaimer:</strong> This TestBed is a front‑end demonstration that collects parameters only and composes an email via <code>mailto:</code>. It does not execute trades or interact with blockchains or smart contracts.</p>
    </footer>

    <div class="card" style="margin-top:16px">
      <div class="inline" style="margin-bottom:8px"><span class="pill">Preview Payload</span><small class="help">Updates as you type</small></div>
      <div id="preview" class="out">—</div>
      <div class="inline" style="margin-top:10px">
        <span class="help">Profit Gate:</span>
        <div class="bar" style="width:260px"><span id="profitBar" style="width:0%" class="bad"></span></div>
        <span id="profitLabel" class="help">No simulation yet</span>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="inline" style="margin-bottom:8px">
        <span class="pill">Live Price</span>
        <small class="help">Based on token address/mint & selected network</small>
      </div>
      <div id="priceOut" class="out">Set network + token + token address to fetch price…</div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="inline" style="margin-bottom:8px">
        <span class="pill">Two‑Leg Quote (Buy → Sell)</span>
        <small class="help">Best available route per public APIs</small>
      </div>
      <div id="quoteOut" class="out">Provide loan amount, network, token, and choose buy/sell DEX to estimate PnL…</div>
    </div>
  </div>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);

    // --- Static maps ---
    const PLATFORMS = {
      ethereum: ["Aave v3", "Balancer", "Uniswap V3 (Uni Flash)", "DyDx (Perp Flash)", "Other / Custom"],
      arbitrum: ["Aave v3", "Radiant", "Balancer", "Other / Custom"],
      polygon: ["Aave v3", "Balancer", "Other / Custom"],
      bsc: ["PancakeSwap (flash via router)", "Other / Custom"],
      avalanche: ["Trader Joe (flash via router)", "Other / Custom"],
      solana: ["Solend", "MarginFi", "Other / Custom"],
    };

    const DEXES = {
      ethereum: ["Uniswap V3", "SushiSwap", "Curve", "Balancer", "1inch Aggregator", "Other / Custom"],
      arbitrum: ["Uniswap V3", "SushiSwap", "Camelot", "Balancer", "1inch Aggregator", "Other / Custom"],
      polygon: ["Uniswap V3", "SushiSwap", "Balancer", "1inch Aggregator", "QuickSwap", "Other / Custom"],
      bsc: ["PancakeSwap", "ApeSwap", "Other / Custom"],
      avalanche: ["Trader Joe", "Pangolin", "Other / Custom"],
      solana: ["Jupiter", "Raydium", "Orca", "Other / Custom"],
    };

    const EVM_NETWORKS = new Set(["ethereum", "arbitrum", "polygon", "bsc", "avalanche"]);

    const TOKENS = {
      ethereum: { WETH:'0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2', WBTC:'0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599', USDC:'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', USDT:'0xdAC17F958D2ee523a2206206994597C13D831ec7', DAI:'0x6B175474E89094C44Da98b954EedeAC495271d0F' },
      arbitrum: { WETH:'0x82af49447d8a07e3bd95bd0d56f35241523fbab1', WBTC:'0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f', USDC:'0xaf88d065e77c8cC2239327C5EDb3A432268e5831', USDT:'0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9', DAI:'0xda10009cbd5d07dd0cecc66161fc93d7c9000da1', ARB:'0x912CE59144191C1204E64559FE8253a0e49E6548' },
      polygon: { WETH:'0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619', WBTC:'0x1BFD67037B42Cf73acF2047067bd4F2C47D9BfD6', USDC:'0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174', USDT:'0xc2132D05D31c914a87C6611C10748AaCB8fd03C8', DAI:'0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063', MATIC:'0x0000000000000000000000000000000000001010' },
      bsc: { WBNB:'0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c', WETH:'0x2170Ed0880ac9A755fd29B2688956BD959F933F8', WBTC:'0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c', USDC:'0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d', USDT:'0x55d398326f99059fF775485246999027B3197955', DAI:'0x1AF3F329e8BE154074D8769D1FFa4eE058B1DBc3' },
      avalanche: { WETH:'0x49D5c2BdFfac6CE2BFdB6640F4F80f226bc10bAB', WBTC:'0x50b7545627a5162F82A992c33b87aDc75187B218', USDC:'0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E', USDT:'0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7', DAI:'0xd586E7F844cEa2F87f50152665BCbc2C279D8d70' },
      solana: { SOL:'So11111111111111111111111111111111111111112', USDC:'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', USDT:'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB' }
    };

    const USDC = {
      ethereum: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
      arbitrum: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831',
      polygon: '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',
      bsc: '0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d',
      avalanche: '0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E',
      solana: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    };

    const ZEROX_HOST = {
      ethereum: 'https://api.0x.org',
      polygon: 'https://polygon.api.0x.org',
      bsc: 'https://bsc.api.0x.org',
      arbitrum: 'https://arbitrum.api.0x.org',
      avalanche: 'https://avalanche.api.0x.org',
    };

    // --- Utilities ---
    function setOptions(select, items){
      if(!select) return;
      const opts = (items && items.length ? items : []);
      select.innerHTML = '<option value="" disabled selected>Select…</option>' + opts.map(x=>`<option>${x}</option>`).join("");
    }

    function collectData(){
      return {
        network: $("network").value || "",
        token: $("token").value || "",
        platform: $("platform").value || "",
        loanAmount: $("loanAmount").value || "",
        tokenAddress: $("tokenAddress").value || "",
        buyDex: $("buyDex").value || "",
        sellDex: $("sellDex").value || "",
        rewardWallet: $("rewardWallet").value || "",
        rewardWalletConfirm: $("rewardWalletConfirm").value || "",
        feeWallet: $("feeWallet").value || "",
        feeWalletConfirm: $("feeWalletConfirm").value || "",
        gasPrice: $("gasPrice").value || "",
        gasLimit: $("gasLimit").value || "",
        gasFeeEth: $("gasFeeEth").value || "",
        maxGasEth: $("maxGasEth").value || "",
        slippage: $("slippage").value || "",
        minProfitToken: $("minProfitToken").value || "",
        minProfitGBP: $("minProfitGBP").value || "",
        email: $("email").value || "",
        submitMode: $("submitMode").value || "mailto",
        agree: $("agree").checked,
        notes: $("notes").value || "",
      };
    }

    function formatPreview(){
      const d = collectData();
      const symEl = $("loanTokenSymbol");
      if(symEl) symEl.textContent = d.token || "Token";
      const lines = [
        `Network: ${d.network}`,
        `Platform: ${d.platform}`,
        `Token: ${d.token}`,
        `Loan Amount (USDC): ${d.loanAmount}`,
        `Token Address: ${d.tokenAddress}`,
        `Buy On: ${d.buyDex}`,
        `Sell To: ${d.sellDex}`,
        `Gas Price (Gwei): ${d.gasPrice}`,
        `Gas Limit: ${d.gasLimit}`,
        `Est. Gas Fee (ETH): ${d.gasFeeEth}`,
        `Max Gas Spend (ETH): ${d.maxGasEth}`,
        `Slippage (%): ${d.slippage}`,
        `Min Profit (Token): ${d.minProfitToken}`,
        `Min Profit (£): ${d.minProfitGBP}`,
        `Email: ${d.email}`,
        `Notes: ${d.notes}`
      ];
      $("preview").textContent = lines.join("\n");
      try{ localStorage.setItem('ck-testbed-cache', JSON.stringify(d)); }catch(e){}
    }

    function calcGas(){
      const gp = parseFloat($("gasPrice").value);
      const gl = parseFloat($("gasLimit").value);
      $("gasFeeEth").value = (!isNaN(gp) && !isNaN(gl)) ? ((gp*gl)/1e9).toFixed(6) : "";
      formatPreview();
    }

    function looksLikeEVM(addr){ return /^0x[a-fA-F0-9]{40}$/.test(addr.trim()); }
    function looksLikeSol(addr){ return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(addr.trim()); }

    function validate(){
      const d = collectData();
      let msg = "";
      if(!d.network) msg += "• Select a network.\n";
      if(!d.platform) msg += "• Select a flash loan platform.\n";
      if(!d.token) msg += "• Select a token.\n";
      if(!d.loanAmount || Number(d.loanAmount)<=0) msg += "• Enter a valid loan amount.\n";
      if(!d.buyDex) msg += "• Select a buy DEX.\n";
      if(!d.sellDex) msg += "• Select a sell DEX.\n";
      if(d.rewardWallet !== d.rewardWalletConfirm) msg += "• Reward wallet confirmation doesn’t match.\n";
      if(d.feeWallet !== d.feeWalletConfirm) msg += "• Fee wallet confirmation doesn’t match.\n";
      if(!d.email) msg += "• Provide a notification email.\n";
      if(!d.agree) msg += "• You must accept the Terms & Disclaimer.\n";
      $("validation").textContent = msg; return msg==="";
    }

    // --- Price helpers ---
    async function fetchWithTimeout(url, ms=10000){
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), ms);
      try{ const res = await fetch(url, {signal: controller.signal}); clearTimeout(id); return res; } finally{ clearTimeout(id); }
    }
    async function priceFromDexscreener(address){
      const r = await fetchWithTimeout(`https://api.dexscreener.com/latest/dex/tokens/${address}`);
      const j = await r.json();
      if(j?.pairs?.length){
        j.pairs.sort((a,b)=>(Number(b.liquidity?.usd||0))-Number(a.liquidity?.usd||0));
        const p=j.pairs[0];
        return { usd:Number(p.priceUsd||0), source:'Dexscreener' };
      }
      throw new Error('No pairs');
    }
    async function priceFromJupiter(mint){
      const r = await fetchWithTimeout(`https://price.jup.ag/v6/price?ids=${encodeURIComponent(mint)}`);
      const j = await r.json();
      const data = j?.data && (j.data[mint] || j.data[Object.keys(j.data)[0]]);
      if(data?.price){ return { usd:Number(data.price), source:'Jupiter' }; }
      throw new Error('No price');
    }
    async function priceFromCoinGecko(network, address){
      const platform = {ethereum:'ethereum',arbitrum:'arbitrum-one',polygon:'polygon-pos',bsc:'binance-smart-chain',avalanche:'avalanche'}[network];
      const r = await fetchWithTimeout(`https://api.coingecko.com/api/v3/simple/token_price/${platform}?contract_addresses=${address}&vs_currencies=usd`);
      const j = await r.json();
      const key = Object.keys(j)[0];
      if(key && j[key]?.usd){ return { usd:Number(j[key].usd), source:'CoinGecko' }; }
      throw new Error('No price');
    }

    async function maybeFetchPrice(){
      const d = collectData();
      const out = $("priceOut"); if(!out) return;
      if(!d.network){ out.textContent = 'Select a network.'; return; }
      if(!d.tokenAddress && d.token && TOKENS[d.network]?.[d.token]){ $("tokenAddress").value = TOKENS[d.network][d.token]; }
      const addr = ($("tokenAddress").value||"").trim();
      if(!addr){ out.textContent = 'Enter token contract/mint.'; return; }
      out.textContent = 'Fetching price…';
      try{
        let q;
        if(d.network==='solana') q = await priceFromJupiter(addr);
        else if(looksLikeEVM(addr)) { try{ q = await priceFromDexscreener(addr);} catch{ q = await priceFromCoinGecko(d.network, addr);} }
        else { out.textContent='Address format not recognised for this network.'; return; }
        out.textContent = `Price: $${q.usd.toFixed(6)} • Source: ${q.source}`;
      }catch{ out.textContent='Could not fetch price.'; }
    }

    // --- Two‑leg quote ---
    async function twoLegQuote(){
      const d = collectData();
      const out = $("quoteOut"); if(!out) return;
      if(!d.network || !d.tokenAddress || !d.loanAmount){ out.textContent='Need network, token address, and loan amount.'; return; }
      out.textContent = 'Quoting route…';
      const slippage = Math.max(0, Number(d.slippage||0))/100; // decimal
      try{
        if(d.network==='solana'){
          const baseMint = USDC.solana; const amt = Math.round(Number(d.loanAmount)*1e6);
          const l1 = await (await fetchWithTimeout(`https://quote-api.jup.ag/v6/quote?inputMint=${baseMint}&outputMint=${d.tokenAddress}&amount=${amt}&slippageBps=${Math.round(slippage*10000)}`)).json();
          if(!l1?.outAmount) throw new Error('leg1');
          const tokenOut = Number(l1.outAmount);
          const l2 = await (await fetchWithTimeout(`https://quote-api.jup.ag/v6/quote?inputMint=${d.tokenAddress}&outputMint=${baseMint}&amount=${tokenOut}&slippageBps=${Math.round(slippage*10000)}`)).json();
          if(!l2?.outAmount) throw new Error('leg2');
          const usdcBack = Number(l2.outAmount)/1e6;
          const pnl = usdcBack - Number(d.loanAmount);
          out.textContent = `SOL two‑leg (USDC→Token→USDC)\nStart: ${Number(d.loanAmount).toFixed(2)} USDC\nEnd: ${usdcBack.toFixed(2)} USDC\nGross PnL: ${pnl.toFixed(2)} USDC`;
        } else if (EVM_NETWORKS.has(d.network)){
          const host = ZEROX_HOST[d.network]; const base = USDC[d.network]; const amt = Math.round(Number(d.loanAmount)*1e6);
          const q1 = await (await fetchWithTimeout(`${host}/swap/v1/price?sellToken=${base}&buyToken=${d.tokenAddress}&sellAmount=${amt}`)).json();
          if(!q1?.buyAmount) throw new Error('0x leg1');
          const tokenOut = BigInt(q1.buyAmount);
          const q2 = await (await fetchWithTimeout(`${host}/swap/v1/price?sellToken=${d.tokenAddress}&buyToken=${base}&sellAmount=${tokenOut.toString()}`)).json();
          if(!q2?.buyAmount) throw new Error('0x leg2');
          const usdcBack = Number(q2.buyAmount)/1e6;
          const pnl = usdcBack - Number(d.loanAmount);
          // gas rough USD using ETH price if provided
          let gasUsd = 0; try{
            if($("gasFeeEth").value){
              const ep = await (await fetchWithTimeout('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd')).json();
              gasUsd = Number($("gasFeeEth").value) * Number(ep?.ethereum?.usd||0);
            }
          }catch{}
          out.textContent = `EVM two‑leg (USDC→Token→USDC via 0x)\nStart: ${Number(d.loanAmount).toFixed(2)} USDC\nEnd: ${usdcBack.toFixed(2)} USDC\nGross PnL: ${pnl.toFixed(2)} USDC\nEst. Gas (USD): ${gasUsd.toFixed(2)}\nNet PnL (USD): ${(pnl-gasUsd).toFixed(2)}`;
        } else { out.textContent='Network not supported for quoting.'; }
      }catch{ out.textContent='Could not fetch quotes.'; }
    }

    // --- Population + bindings ---
    function refreshForNetwork(){
      const net = $("network")?.value || "";
      setOptions($("platform"), (PLATFORMS[net]||["Other / Custom"]) );
      const dexes = (DEXES[net] || ["Other / Custom"]);
      setOptions($("buyDex"), dexes);
      setOptions($("sellDex"), dexes);
      const showGas = EVM_NETWORKS.has(net);
      ["gasPriceWrap","gasLimitWrap","gasFeeWrap"].forEach(id=>{ const el=$(id); if(el) el.classList.toggle('hidden', !showGas); });
      formatPreview();
      maybeFetchPrice();
    }

    window.__ck_refreshForNetwork = function(){ try{ refreshForNetwork(); twoLegQuote(); }catch(e){ console.error('refresh error',e);} };

    function bindEvents(){
      const ids = ["loanAmount","platform","token","tokenAddress","buyDex","sellDex","rewardWallet","rewardWalletConfirm","feeWallet","feeWalletConfirm","gasPrice","gasLimit","maxGasEth","slippage","minProfitToken","minProfitGBP","email","notes","submitMode"];
      ids.forEach(id=>{ const el=$(id); if(!el) return;
        el.addEventListener('input', ()=>{ if(id==='gasPrice'||id==='gasLimit') calcGas(); else formatPreview(); });
        el.addEventListener('change', ()=>{ if(['buyDex','sellDex','tokenAddress','token'].includes(id)){ maybeFetchPrice(); twoLegQuote(); } if(id==='gasPrice'||id==='gasLimit') calcGas(); else formatPreview(); });
      });
      const sim=$("simulateBtn"); if(sim) sim.addEventListener('click', ()=>{ if(validate()){ simulate(); twoLegQuote(); }});
      const copy=$("copyJsonBtn"); if(copy) copy.addEventListener('click', ()=>{ const payload=JSON.stringify({subject:`CK TestBed | NET: ${($("network").value||'N/A')} | TOKEN: ${($("token").value||'N/A')}`, timestamp:new Date().toISOString(), ...collectData()},null,2); navigator.clipboard.writeText(payload).then(()=>$("validation").textContent='JSON copied.').catch(()=>$("validation").textContent='Clipboard blocked.'); });
      const dl=$("downloadJsonBtn"); if(dl) dl.addEventListener('click', ()=>{ const payload=JSON.stringify({subject:`CK TestBed | NET: ${($("network").value||'N/A')} | TOKEN: ${($("token").value||'N/A')}`, timestamp:new Date().toISOString(), ...collectData()},null,2); const blob=new Blob([payload],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ck-testbed-request.json'; a.click(); URL.revokeObjectURL(url); });
      const form=$("testbedForm"); if(form) form.addEventListener('submit', (e)=>{ e.preventDefault(); if(!validate()) return; const d=collectData(); const subject=encodeURIComponent(`CK TestBed | NET: ${d.network} | TOKEN: ${d.token}`); const body=encodeURIComponent($("preview").textContent+"\n\nSent from Crypto Kings TestBed"); if(d.submitMode==='mailto'){ window.location.href=`mailto:${d.email}?subject=${subject}&body=${body}`; } else { const payload=JSON.stringify({subject:`CK TestBed | NET: ${d.network} | TOKEN: ${d.token}`, timestamp:new Date().toISOString(), ...d},null,2); const blob=new Blob([payload],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ck-testbed-request.json'; a.click(); URL.revokeObjectURL(url); }});
    }

    function simulate(){
      const d = collectData(); let score=0; if(d.minProfitToken||d.minProfitGBP) score+=30; else score+=10; if(d.slippage && Number(d.slippage)<=1) score+=30; else if(d.slippage) score+=15; if(EVM_NETWORKS.has(d.network)){ if(d.maxGasEth && d.gasFeeEth && Number(d.maxGasEth)>=Number(d.gasFeeEth)) score+=30; } else { score+=30; } if(d.buyDex && d.sellDex && d.buyDex!==d.sellDex) score+=10; const pct=Math.max(5,Math.min(100,score)); const bar=$("profitBar"); bar.style.width=pct+"%"; bar.className=pct>=60?"good":"bad"; $("profitLabel").textContent=pct>=60?"Pass (est.)":"Fail (est.)"; }

    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        bindEvents();
        // restore cache
        try{ const cached=localStorage.getItem('ck-testbed-cache'); if(cached){ const d=JSON.parse(cached); ["network","token","platform","loanAmount","tokenAddress","buyDex","sellDex","rewardWallet","rewardWalletConfirm","feeWallet","feeWalletConfirm","gasPrice","gasLimit","gasFeeEth","maxGasEth","slippage","minProfitToken","minProfitGBP","email","notes","submitMode"].forEach(id=>{ if(d[id]!==undefined && $(id)) $(id).value=d[id]; }); } }catch{}
        window.__ck_refreshForNetwork();
        calcGas();
        formatPreview();
        setTimeout(()=>{ window.__ck_refreshForNetwork(); }, 60);
      }catch(err){ console.error('Init error:',err); }
    });
  })();
  </script>
</body>
</html>
