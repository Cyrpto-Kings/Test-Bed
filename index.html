<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Crypto Kings • TestBed v9.9.30 • UniV3 On-Chain Quotes</title>
<style>
  :root{
    color-scheme: light;
    --bg:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --card:#f9fafb; --ok:#059669; --bad:#e11d48;
    --g1:#2563eb; --g2:#7c3aed; --chip:#eef2f7;
  }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--ink)}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* Header (hamburger only) */
  header{background:#111;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,#4f46e5,#22c55e);display:grid;place-items:center;font-weight:800}
  .burger{font-size:22px;cursor:pointer;user-select:none}

  /* Page + panels */
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .hint{color:var(--muted);font-size:12px}
  input[type=number]{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-width:160px}
  button{border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn-primary{color:#fff;background:linear-gradient(135deg,var(--g1),var(--g2));box-shadow:0 8px 24px rgba(37,99,235,.2)}
  .btn-ghost{background:var(--chip);color:#111}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#111}

  /* Results table */
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding-bottom:10px;border-bottom:1px solid var(--line);margin-bottom:10px}
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  thead th{background:#f3f4f6;border-bottom:1px solid var(--line);padding:10px 12px;color:#374151;font-weight:700}
  tbody td{border-bottom:1px solid var(--line);padding:10px 12px;vertical-align:middle}
  .right{text-align:right}
  .mono{font-variant-numeric:tabular-nums}
  tr.profit{background:#ecfdf5}
  tr.loss{background:#fff1f2}
  .ok{color:var(--ok)} .bad{color:var(--bad)}

  /* Mobile friendliness */
  .cell{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .lbl{color:#6b7280;font-size:12px;margin-right:8px;white-space:nowrap}
  .val{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-variant-numeric:tabular-nums}

  /* Logs */
  .logs{background:#0b1220;color:#a7f3d0;border:1px solid #0f1b34;border-radius:12px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;max-height:220px;overflow:auto}

  /* Footer (4 columns) */
  footer{background:#111;color:#ddd;padding:24px}
  .foot{max-width:1100px;margin:0 auto;display:grid;gap:18px;grid-template-columns:repeat(4,1fr)}
  footer h4{color:#fff;margin:0 0 10px;font-size:16px}
  footer ul{list-style:none;margin:0;padding:0}
  footer li{margin:6px 0}
  @media(max-width:800px){ .foot{grid-template-columns:1fr 1fr} }
  @media(max-width:560px){ .foot{grid-template-columns:1fr} }

  /* Mobile table → cards */
  @media(max-width:720px){
    thead{display:none}
    tbody tr{display:grid;grid-template-columns:1fr 1fr;grid-row-gap:6px;padding:10px 12px}
    tbody td{border:0;padding:0}
    td.sel{grid-column:1/-1;order:-3;margin-bottom:4px}
    td.tok{grid-column:1/-1;font-weight:700;order:-2}
    td.spread, td.usdc, td.net{order:-1}
    .toolbar .btn-primary,.toolbar .btn-ghost{width:100%}
  }
</style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">CK</div>
      <div>
        <div style="font-weight:800;line-height:1">Crypto Kings</div>
        <div class="hint">TestBed v9.9.30 • Arbitrum • UniV3 on-chain quotes</div>
      </div>
    </div>
    <div class="burger" title="Menu">&#9776;</div>
  </header>

  <div class="container">
    <!-- Scan Panel -->
    <div class="panel">
      <div class="row">
        <label class="hint">Loan Amount (USDC):</label>
        <input id="loan" type="number" min="100" step="100" value="10000"/>
        <button id="scanBtn" class="btn-primary">Scan</button>
        <button id="stopBtn" class="btn-ghost">Stop</button>
      </div>
      <div class="chips">
        <span class="pill" id="rpcPill">RPC: Alchemy</span>
        <span class="pill" id="tokensPill">Tokens: 50</span>
        <span class="pill" id="gasPill">Gas: —</span>
        <span class="pill" id="ethPill">ETH: —</span>
        <span class="pill" id="progPill">Idle.</span>
      </div>
    </div>

    <!-- Results Panel -->
    <div class="panel">
      <div class="toolbar">
        <button id="selectProfitable" class="btn-ghost">Select all profitable</button>
        <button id="clearSel" class="btn-ghost">Clear</button>
        <span id="selTotal" class="pill">++$0.00</span>
        <button id="execPreview" class="btn-primary" style="margin-left:auto">Execute Selected (Preview)</button>
      </div>
      <table id="results">
        <thead>
          <tr>
            <th style="width:42px">Select</th>
            <th>Token</th>
            <th>Buy (DEX @ $)</th>
            <th>Sell (DEX @ $)</th>
            <th class="right">Spread %</th>
            <th class="right">USDC Back</th>
            <th class="right">Net P/L</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Logs Panel -->
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:700">Details / Logs</div>
        <span class="hint">Live only — UniV3 on-chain, others via Dexscreener</span>
      </div>
      <div id="log" class="logs">Ready.</div>
    </div>
  </div>

  <footer>
    <div class="foot">
      <div>
        <h4>Crypto Kings</h4>
        <ul><li>Arbitrage Scanner</li><li>DeFi Tools</li><li>Risk Analysis</li></ul>
      </div>
      <div>
        <h4>Company</h4>
        <ul><li>Who we are</li><li>What we do</li><li>Connect with us</li></ul>
      </div>
      <div>
        <h4>Resources</h4>
        <ul><li>Docs</li><li>Blog</li><li>Support</li></ul>
      </div>
      <div>
        <h4>Legal</h4>
        <ul><li>Privacy</li><li>Terms</li><li>Disclaimer</li></ul>
      </div>
    </div>
  </footer>

<!-- Ethers.js (v5) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
/* ======= CONFIG (live) ======= */
const ALCHEMY_URL = "https://arb-mainnet.g.alchemy.com/v2/h4YaGX9cc_WywAx5cvsez"; // per your request
const SPREAD_CAP = 50;       // drop absurd API spreads
const FLASH_FEE = 0.0009;    // 0.09%
const DEX_FEE   = 0.003;     // per leg
const SLIP_FEE  = 0.002;     // per leg
const GAS_LIMIT = 380000;    // ~2 swaps + callback
const TOKENS = [
  "WETH","WBTC","USDC","USDT","DAI","ARB","LINK","GMX","AAVE","RDNT",
  "PENDLE","FRAX","CRV","BAL","UNI","wstETH","SNX","COMP","YFI","GRT",
  "STG","LQTY","RPL","MKR","ENS","CVX","FXS","SUSHI","LUSD","MAGIC",
  "BADGER","DODO","BNT","OP","GNS","DPX","RDPX","GRAIL","HOP","ALCX",
  "ANGLE","PERP","1INCH","VELO","AURA","BOND","UMAMI","TCR","PLS","JOE"
]; // 50
document.getElementById("tokensPill").textContent = "Tokens: "+TOKENS.length;

/* ======= Chain consts (Arbitrum) ======= */
const ADDR = {
  USDC: "0xaf88d065e77c8cC2239327C5EDb3A432268e5831",
  USDT: "0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",
  WETH: "0x82af49447d8a07e3bd95bd0d56f35241523fbab1",
  UNI_V3_QUOTER_V2: "0x61fFE014bA17989E743c5F6cB21bF9697530B21e"
};
const UNI_V3_FEE_TIERS = [500, 3000, 10000]; // 0.05%, 0.3%, 1%

/* ======= Helpers ======= */
const $ = s=>document.querySelector(s);
const tbody = $("#tbody"), logEl = $("#log");
function log(m){ logEl.textContent += (m.endsWith("\n")?m:m+"\n"); logEl.scrollTop=logEl.scrollHeight; }
function usd(n){ return Number(n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}); }

/* ======= Live ETH & Gas ======= */
let ETH_USD = null, GAS_GWEI = null;
async function fetchEthUsd(){
  try{
    const r=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd",{cache:"no-store"});
    const j=await r.json();
    ETH_USD = Number(j?.ethereum?.usd)||null;
    $("#ethPill").textContent = "ETH: " + (ETH_USD? usd(ETH_USD):"—");
  }catch(_){ $("#ethPill").textContent="ETH: (fail)"; }
}
async function fetchGasGwei(){
  try{
    const body={jsonrpc:"2.0",id:1,method:"eth_gasPrice",params:[]};
    const r=await fetch(ALCHEMY_URL,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(body)});
    const j=await r.json(); const wei=parseInt(j?.result||"0x0",16);
    GAS_GWEI = wei/1e9;
    $("#gasPill").textContent = "Gas: " + GAS_GWEI.toFixed(2) + " gwei";
  }catch(_){ $("#gasPill").textContent="Gas: (fail)"; GAS_GWEI = 0.05; }
}

/* ======= Dexscreener (address discovery + other DEX prices) ======= */
async function fetchPairsForSymbol(sym){
  try{
    const url = "https://api.dexscreener.com/latest/dex/search?q="+encodeURIComponent(sym);
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) return [];
    const j = await r.json();
    const pairs = (j?.pairs||[]).filter(p=>{
      const base = (p?.baseToken?.symbol||"").toUpperCase();
      return p?.chainId==="arbitrum" && base===sym.toUpperCase();
    });
    // keep one best by liquidity per dex
    const byDex = new Map();
    for(const p of pairs){
      const k=(p?.dexId||"").toLowerCase();
      const liq=Number(p?.liquidity?.usd||0);
      const price=Number(p?.priceUsd||0);
      if(!k||!(liq>0)||!(price>0)) continue;
      const cur=byDex.get(k);
      if(!cur || liq>cur.liq) byDex.set(k,{pair:p,liq});
    }
    return Array.from(byDex.values()).map(v=>v.pair);
  }catch(_){ return []; }
}
async function getTokenAddressFromDexscreener(sym){
  const pairs = await fetchPairsForSymbol(sym);
  const p = pairs[0];
  return p?.baseToken?.address || null;
}

/* ======= Ethers provider + UniV3 quoter ======= */
const provider = new ethers.providers.JsonRpcProvider(ALCHEMY_URL);
const QUOTER_ABI = [
  "function quoteExactInputSingle(tuple(address tokenIn,address tokenOut,uint256 amountIn,uint24 fee,uint160 sqrtPriceLimitX96)) external returns (uint256 amountOut,uint160,uint32,uint256)"
];
const quoter = new ethers.Contract(ADDR.UNI_V3_QUOTER_V2, QUOTER_ABI, provider);

// Quote UniV3 best of common fee tiers; returns {amountOut, feeTier} or null
async function uniV3BestOut(tokenIn, tokenOut, amountIn){
  let best = null;
  for(const ft of UNI_V3_FEE_TIERS){
    try{
      const params = [ [tokenIn, tokenOut, amountIn.toString(), ft, 0] ];
      const res = await quoter.quoteExactInputSingle(params);
      const out = ethers.BigNumber.isBigNumber(res?.[0]) ? res[0] : ethers.BigNumber.from(res?.amountOut||0);
      if(out.gt(0)){
        if(!best || out.gt(best.amountOut)) best = { amountOut: out, feeTier: ft };
      }
    }catch(_e){ /* ignore non-existent pool/fee */ }
  }
  return best; // could be null
}

/* ======= Route computation ======= */
function computeNetPL({ loanUSDC, buyPrice, sellPrice }){
  const units = loanUSDC / buyPrice;
  const gross = units * sellPrice;
  const dexCost = loanUSDC*(DEX_FEE+SLIP_FEE) + gross*(DEX_FEE+SLIP_FEE);
  const flash = loanUSDC*FLASH_FEE;
  const gasEth = ((GAS_GWEI||0.05) * GAS_LIMIT) / 1e9;
  const gasUsd = (ETH_USD? gasEth*ETH_USD : 0);
  const netPL = gross - loanUSDC - dexCost - flash - gasUsd;
  const spreadPct = (sellPrice/buyPrice - 1) * 100;
  return { netPL, spreadPct, usdcBack: gross };
}

/* ======= Render ======= */
function renderRows(rows){
  rows.sort((a,b)=>{
    const pa=a.netPL||-1e99, pb=b.netPL||-1e99;
    const ap=pa>0, bp=pb>0;
    if(ap!==bp) return bp-ap; // profitable first
    return pb-pa;
  });

  const tbody = document.getElementById("tbody");
  tbody.innerHTML="";
  for(const r of rows){
    const tr=document.createElement("tr");
    tr.className = r.netPL>0 ? "profit" : "loss";
    tr.dataset.netpl = r.netPL;
    tr.innerHTML = `
      <td class="sel"><input type="checkbox" class="pick" ${r.netPL>0?"checked":""}></td>
      <td class="tok">${r.token}</td>
      <td><div class="cell"><span class="lbl">Buy</span><span class="val">${r.buyDex} @ ${Number(r.buyPrice).toLocaleString(undefined,{maximumFractionDigits:6})}</span></div></td>
      <td><div class="cell"><span class="lbl">Sell</span><span class="val">${r.sellDex} @ ${Number(r.sellPrice).toLocaleString(undefined,{maximumFractionDigits:6})}</span></div></td>
      <td class="right mono spread">${r.spreadPct.toFixed(2)}%</td>
      <td class="right mono usdc">${usd(r.usdcBack)}</td>
      <td class="right mono ${r.netPL>0?'ok':'bad'} net">${(r.netPL>=0?'+':'-')+usd(Math.abs(r.netPL)).replace('$','')}</td>
    `;
    tbody.appendChild(tr);
  }
  updateSelectedTotal();
}
function updateSelectedTotal(){
  let sum=0;
  document.querySelectorAll("#tbody .pick:checked").forEach(cb=>{
    const tr=cb.closest("tr"); sum += Number(tr.dataset.netpl||0);
  });
  document.getElementById("selTotal").textContent = (sum>=0?'++$':'−$') + Math.abs(sum).toLocaleString(undefined,{maximumFractionDigits:2});
}

/* ======= Scan flow ======= */
let stopFlag=false, scanning=false;

async function runScan(){
  if(scanning) return;
  scanning = true; stopFlag=false;
  document.getElementById("progPill").textContent="Preparing (gas, ETH)…";
  document.getElementById("tbody").innerHTML=""; updateSelectedTotal(); logEl.textContent="Ready.\n";

  const loan = Number(document.getElementById("loan").value||10000);
  await Promise.all([fetchEthUsd(), fetchGasGwei()]);
  document.getElementById("progPill").textContent="Scanning live pools…";
  log(`[${new Date().toLocaleTimeString()}] CLICK Scan; tokens=${TOKENS.length}; loan=${loan.toLocaleString()}`);

  const found = [];

  for(let i=0;i<TOKENS.length;i++){
    if(stopFlag) break;
    const sym = TOKENS[i].toUpperCase();
    document.getElementById("progPill").textContent = `Scanning ${i+1}/${TOKENS.length} — ${sym}`;
    log(`${sym}: resolving address…`);

    const tokenAddr = await getTokenAddressFromDexscreener(sym);
    if(!tokenAddr){ log(`${sym}: no Arbitrum address found`); continue; }

    // 1) On-chain UniV3 BUY: USDC -> TOKEN for loan size (with fee tier search)
    const amountInUSDC = ethers.utils.parseUnits(String(loan), 6); // USDC 6dp
    const buyOutBest = await uniV3BestOut(ADDR.USDC, tokenAddr, amountInUSDC);
    let buyFrom = null, buyPrice = null, tokenAmount = null;
    if(buyOutBest){
      tokenAmount = buyOutBest.amountOut; // decimals unknown; we’ll estimate price via reverse quote too
      // Derive buy price as (loan USDC)/(tokens out) using a second quote TOKEN->USDC for a small probe to infer decimals.
      // Better: build price directly from amountIn/amountOut with assumed decimals; but address decimals require an ERC20 call (extra RPC).
      // Use reciprocal sell quote with tiny amount to approximate price scale:
      buyFrom = `UniV3(${(buyOutBest.feeTier/10000).toFixed(2)}%)`;
      // compute buyPrice more exactly using amountInUSDC / tokenOut (requires token decimals).
      // We’ll fetch token decimals just once:
      const erc20 = new ethers.Contract(tokenAddr, ["function decimals() view returns (uint8)"], provider);
      let dec=18;
      try{ dec = await erc20.decimals(); }catch(_){}
      buyPrice = (loan) / Number(ethers.utils.formatUnits(tokenAmount, dec));
    }

    // 2) Candidate SELL quotes: other DEXes via Dexscreener mid-price + UniV3 on-chain sell
    const pairs = await fetchPairsForSymbol(sym);
    if(!pairs.length && !buyOutBest){ log(`${sym}: no pools`); continue; }

    // Always include a UniV3 on-chain SELL for realism (TOKEN -> USDC) using the tokenAmount we got
    let sellChoices = [];
    if(buyOutBest && tokenAmount){
      try{
        const erc20 = new ethers.Contract(tokenAddr, ["function decimals() view returns (uint8)"], provider);
        let dec=18; try{ dec = await erc20.decimals(); }catch(_){}
        const sellIn = tokenAmount; // same tokens from buy
        const sellOutBest = await uniV3BestOut(tokenAddr, ADDR.USDC, sellIn);
        if(sellOutBest && sellOutBest.amountOut.gt(0)){
          const usdcBack = Number(ethers.utils.formatUnits(sellOutBest.amountOut, 6));
          const units = Number(ethers.utils.formatUnits(tokenAmount, dec));
          const sellPx = usdcBack / units;
          sellChoices.push({ dex:`UniV3(${(sellOutBest.feeTier/10000).toFixed(2)}%)`, price: sellPx });
        }
      }catch(_){}
    }

    // Add best per-DEX from Dexscreener (mid) for comparison
    for(const p of pairs){
      const dex = (p?.dexId||"").toUpperCase();
      const pr  = Number(p?.priceUsd||0);
      if(pr>0) sellChoices.push({ dex, price: pr });
    }

    // Require we have at least buy and one sell
    if(!(buyPrice>0) || sellChoices.length<1){ log(`${sym}: no executable buy or sell choices`); continue; }

    // Pick best sell (highest price)
    sellChoices.sort((a,b)=> b.price - a.price);
    const sellBest = sellChoices[0];

    // Cap spreads to avoid absurd dexscreener outliers
    const rawSpread = (sellBest.price/buyPrice - 1) * 100;
    if(rawSpread <= 0 || rawSpread > SPREAD_CAP){
      log(`${sym}: spread ${rawSpread.toFixed(2)}% out of bounds`);
      continue;
    }

    // Net P/L calc (loan-sized, depth-aware on UniV3 legs)
    const { netPL, spreadPct, usdcBack } = computeNetPL({
      loanUSDC: loan, buyPrice, sellPrice: sellBest.price
    });

    found.push({
      token: sym,
      buyDex: buyFrom || "UniV3",
      sellDex: sellBest.dex,
      buyPrice, sellPrice: sellBest.price,
      spreadPct, usdcBack, netPL
    });

    log(`${sym}: ✅ ${buyFrom} → ${sellBest.dex} spread ${spreadPct.toFixed(2)}% net ${usd(netPL)}`);
  }

  renderRows(found);
  document.getElementById("progPill").textContent =
    `Done. Found ${found.filter(r=>r.netPL>0).length} profitable route(s), ${found.length} total rows.`;
  scanning=false;
}

/* ======= Wire UI ======= */
document.getElementById("scanBtn").addEventListener("click", runScan);
document.getElementById("stopBtn").addEventListener("click", ()=>{ stopFlag=true; document.getElementById("progPill").textContent="Stopped."; });
document.getElementById("results").addEventListener("change", e=>{ if(e.target.classList.contains("pick")) updateSelectedTotal(); });
document.getElementById("selectProfitable").addEventListener("click", ()=>{
  document.querySelectorAll("#tbody tr").forEach(tr=>{
    const cb=tr.querySelector(".pick"); if(cb) cb.checked = (Number(tr.dataset.netpl||-1e99)>0);
  });
  updateSelectedTotal();
});
document.getElementById("clearSel").addEventListener("click", ()=>{
  document.querySelectorAll("#tbody .pick").forEach(cb=>cb.checked=false);
  updateSelectedTotal();
});
document.getElementById("execPreview").addEventListener("click", ()=>{
  const rows = Array.from(document.querySelectorAll("#tbody tr")).filter(tr=>tr.querySelector(".pick")?.checked);
  if(!rows.length){ alert("Select at least one profitable route first."); return; }
  let msg="Preview — routes to execute:\n\n";
  rows.forEach((tr,i)=>{
    const tds = tr.querySelectorAll("td");
    msg += `${i+1}. ${tds[1].textContent.trim()}: ${tds[2].innerText.replace(/\n/g,' ')} → ${tds[3].innerText.replace(/\n/g,' ')} | ${tds[5].textContent.trim()} | ${tds[6].textContent.trim()}\n`;
  });
  alert(msg);
});

/* Init badges + live chips */
document.getElementById("rpcPill").textContent = "RPC: Alchemy";
(async ()=>{ await Promise.all([fetchEthUsd(), fetchGasGwei()]); })();
</script>
</body>
</html>
